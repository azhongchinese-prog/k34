<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BÃ i Kiá»ƒm Tra HSK 1</title>
    <!-- TÃ­ch há»£p Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @media print {
            body { background-color: white; }
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            .step-content { display: block !important; } 
            input, select, textarea { border: none !important; border-bottom: 1px solid #000 !important; border-radius: 0 !important; box-shadow: none !important; appearance: none; -webkit-appearance: none; }
            .bg-white { box-shadow: none !important; }
            #stepNav, #btnNav, #topBanner { display: none !important; }
        }
        
        /* Hiá»‡u á»©ng hiá»ƒn thá»‹ Ä‘Ã¡p Ã¡n */
        .correct-answer { display: none; margin-top: 8px; font-size: 0.95em; color: #16a34a; background: #dcfce7; padding: 8px 12px; border-radius: 6px; border-left: 4px solid #16a34a; }
        .wrong-alert { display: none; color: #dc2626; font-weight: bold; margin-bottom: 4px; font-size: 0.9em; }
        
        .show-answer .correct-answer { display: block; }
        .show-answer .input-wrong + .wrong-alert { display: block; } /* Hiá»‡n chá»¯ X sai náº¿u lÃ m sai */
        
        .input-wrong { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; color: #b91c1c; }
        .input-correct { border: 2px solid #22c55e !important; background-color: #f0fdf4 !important; color: #15803d; }
        
        .example-box { background-color: #fffbeb; border: 1px dashed #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .step-content { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #stepNav::-webkit-scrollbar { height: 4px; }
        #stepNav::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        
        /* Cá»‘ Ä‘á»‹nh banner trÃªn cÃ¹ng */
        #topBanner { position: sticky; top: 0; z-index: 50; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased pb-20">

    <!-- Thanh Banner ghim trÃªn Ä‘áº§u (Chá»©a Timer vÃ  Tráº¡ng thÃ¡i) -->
    <div id="topBanner" class="w-full bg-blue-700 text-white shadow-md flex justify-between items-center px-4 py-2">
        <div id="saveStatus" class="text-sm md:text-base"><i class="fas fa-save mr-2"></i>Há»‡ thá»‘ng sáºµn sÃ ng.</div>
        <div class="flex items-center bg-blue-900 rounded-full px-4 py-1 border border-blue-500 shadow-inner">
            <i class="fas fa-clock mr-2 text-yellow-300"></i>
            <span id="timerDisplay" class="font-mono text-xl md:text-2xl font-bold tracking-widest text-yellow-300">90:00</span>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mt-6 bg-white rounded-xl shadow-lg overflow-hidden">
        
        <!-- Header -->
        <div class="bg-red-700 text-white p-6 text-center">
            <h1 class="text-3xl font-bold mb-2">BÃ€I KIá»‚M TRA ÄÃNH GIÃ NÄ‚NG Lá»°C HSK 1</h1>
            <p class="text-lg opacity-90">Trung tÃ¢m HÃ¡n ngá»¯ HANAI LAB</p>
        </div>

        <form id="examForm" class="p-6 md:p-8">
            
            <!-- THANH ÄIá»€U HÆ¯á»šNG TIáº¾N Äá»˜ -->
            <ul id="stepNav" class="flex justify-between items-center mb-8 overflow-x-auto pb-3 text-sm md:text-base font-medium text-gray-400 border-b whitespace-nowrap">
                <li class="step-nav-item text-red-600 font-bold border-b-2 border-red-600 pb-2 px-3 transition-colors"><i class="fas fa-user-circle mr-1"></i> ThÃ´ng tin</li>
                <li class="step-nav-item pb-2 px-3 transition-colors"><i class="fas fa-headphones mr-1"></i> Nghe</li>
                <li class="step-nav-item pb-2 px-3 transition-colors"><i class="fas fa-book-open mr-1"></i> Äá»c</li>
                <li class="step-nav-item pb-2 px-3 transition-colors"><i class="fas fa-keyboard mr-1"></i> Viáº¿t</li>
                <li class="step-nav-item pb-2 px-3 transition-colors"><i class="fas fa-language mr-1"></i> Dá»‹ch</li>
                <li class="step-nav-item pb-2 px-3 transition-colors"><i class="fas fa-font mr-1"></i> HÃ¡n Tá»±</li>
            </ul>

            <!-- ================= STEP 0: THÃ”NG TIN ================= -->
            <div id="step-0" class="step-content">
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2"><i class="fas fa-info-circle mr-2"></i>BÆ°á»›c 1: Äiá»n thÃ´ng tin há»c viÃªn</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Há» vÃ  TÃªn *</label>
                            <input type="text" id="studentName" name="studentName" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">MÃ£ há»c viÃªn / Sá»‘ ÄT *</label>
                            <input type="text" id="studentId" name="studentId" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg">
                        </div>
                    </div>
                    <!-- TrÆ°á»ng Máº­t kháº©u (Báº®T BUá»˜C THEO YÃŠU Cáº¦U) -->
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200 mt-4">
                        <label class="block text-sm font-bold text-red-800 mb-1"><i class="fas fa-lock mr-1"></i> Máº­t kháº©u truy cáº­p Ä‘á» thi *</label>
                        <input type="password" id="studentPassword" required placeholder="Nháº­p máº­t kháº©u giÃ¡o viÃªn cung cáº¥p..." class="w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 text-lg font-mono">
                    </div>
                </div>
            </div>

            <!-- ================= STEP 1: NGHE ================= -->
            <div id="step-1" class="step-content hidden print-break">
                <h2 class="text-2xl font-bold text-red-700 mb-4 flex items-center"><i class="fas fa-headphones mr-2"></i>Pháº§n Nghe Hiá»ƒu (20 cÃ¢u - 50 Ä‘iá»ƒm)</h2>
                
                <div class="bg-red-50 p-4 rounded-lg mb-6 border border-red-200 shadow-inner">
                    <p class="font-bold text-red-800 mb-2"><i class="fas fa-volume-up mr-2"></i>File Nghe Audio:</p>
                    <audio id="examAudio" controls class="w-full">
                        <source src="https://res.cloudinary.com/dvkx1wuml/video/upload/v1772163506/H10902_d8tqgn.mp3" type="audio/mpeg">
                    </audio>
                    <p id="audioWarning" class="text-red-600 text-sm mt-2 font-bold bg-white inline-block px-2 py-1 rounded border border-red-200">
                        âš ï¸ LÆ°u Ã½: File nghe chá»‰ Ä‘Æ°á»£c phÃ¡t 1 láº§n duy nháº¥t! Sau khi káº¿t thÃºc sáº½ tá»± Ä‘á»™ng khÃ³a.
                    </p>
                </div>

                <div class="space-y-10">
                    <!-- Nghe Pháº§n 1 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 1: CÃ¢u 1 - 5</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Chá»n True(ÄÃºng) / False(Sai) cho cÃ¡c cÃ¢u tÆ°Æ¡ng á»©ng.</p>
                        <img src="https://res.cloudinary.com/dvkx1wuml/image/upload/v1772162849/%E6%88%AA%E5%B1%8F2026-02-27_10.25.07_eshvy3.png" alt="Nghe pháº§n 1" class="w-full rounded border">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-4" id="nghe-part1"></div>
                    </div>

                    <!-- Nghe Pháº§n 2 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 2: CÃ¢u 6 - 10</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Chá»n Ä‘Ã¡p Ã¡n A, B hoáº·c C.</p>
                        <img src="https://res.cloudinary.com/dvkx1wuml/image/upload/v1772162899/%E6%88%AA%E5%B1%8F2026-02-27_10.25.25_diz4yr.png" class="w-full rounded border">
                        <div class="grid grid-cols-3 gap-3 mt-4 mb-6" id="nghe-part2a"></div>
                        <img src="https://res.cloudinary.com/dvkx1wuml/image/upload/v1772162924/%E6%88%AA%E5%B1%8F2026-02-27_10.25.36_g31yvy.png" class="w-full rounded border">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4" id="nghe-part2b"></div>
                    </div>

                    <!-- Nghe Pháº§n 3 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 3: CÃ¢u 11 - 15</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Chá»n bá»©c tranh tÆ°Æ¡ng á»©ng (A-F).</p>
                        <div class="example-box">
                            <span class="bg-yellow-400 text-yellow-900 font-bold px-2 py-1 rounded text-xs mr-2">VÃ­ dá»¥ / ä¾‹å¦‚</span>
                            <div class="mt-2 text-gray-700">
                                <p>å¥³ï¼šä½ å¥½ï¼(NÇ hÇo!)</p><p>ç”·ï¼šä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚(NÇ hÇo! HÄ›n gÄoxÃ¬ng rÃ¨nshi nÇ.)</p>
                                <p class="mt-2 text-right font-bold text-red-600">ÄÃ¡p Ã¡n: [ C ]</p>
                            </div>
                        </div>
                        <img src="https://res.cloudinary.com/dvkx1wuml/image/upload/v1772162952/%E6%88%AA%E5%B1%8F2026-02-27_10.25.47_n6ife0.png" class="w-full rounded border">
                        <div class="grid grid-cols-3 md:grid-cols-5 gap-3 mt-4" id="nghe-part3"></div>
                    </div>

                    <!-- Nghe Pháº§n 4 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 4: CÃ¢u 16 - 20</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Nghe vÃ  chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng nháº¥t (A, B hoáº·c C).</p>
                        <div class="example-box mb-4">
                            <span class="bg-yellow-400 text-yellow-900 font-bold px-2 py-1 rounded text-xs mr-2">VÃ­ dá»¥ / ä¾‹å¦‚</span>
                            <div class="mt-2 text-gray-700">
                                <p>ä¸‹åˆæˆ‘å»å•†åº—ï¼Œæˆ‘æƒ³ä¹°ä¸€äº›æ°´æœã€‚(XiÃ wÇ” wÇ’ qÃ¹ shÄngdiÃ n, wÇ’ xiÇng mÇi yÃ¬xiÄ“ shuÇguÇ’.)</p>
                                <p>é—®ï¼šå¥¹ä¸‹åˆå»å“ªé‡Œï¼Ÿ(TÄ xiÃ wÇ” qÃ¹ nÇlÇ?)</p>
                                <p class="mt-2 text-right font-bold text-red-600">ÄÃ¡p Ã¡n: [ A ]</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 border rounded" id="nghe-part4"></div>
                    </div>
                </div>
            </div>

            <!-- ================= STEP 2: Äá»ŒC ================= -->
            <div id="step-2" class="step-content hidden print-break">
                <h2 class="text-2xl font-bold text-red-700 mb-4 flex items-center"><i class="fas fa-book-open mr-2"></i>Pháº§n Äá»c Hiá»ƒu</h2>
                <div class="space-y-10">
                    <!-- Äá»c Pháº§n 1 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 1: CÃ¢u 21 - 25</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Chá»n True(ÄÃºng) / False(Sai) cho cÃ¡c cÃ¢u tÆ°Æ¡ng á»©ng.</p>
                        <img src="https://res.cloudinary.com/dvkx1wuml/image/upload/v1772162974/%E6%88%AA%E5%B1%8F2026-02-27_10.26.03_y7xzub.png" class="w-full rounded border">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-4" id="doc-part1"></div>
                    </div>
                    
                    <!-- Äá»c Pháº§n 2 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 2: CÃ¢u 26 - 30</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Chá»n bá»©c tranh tÆ°Æ¡ng á»©ng vá»›i cÃ¢u (A-F).</p>
                        <div class="example-box">
                            <span class="bg-yellow-400 text-yellow-900 font-bold px-2 py-1 rounded text-xs mr-2">VÃ­ dá»¥ / ä¾‹å¦‚</span>
                            <div class="mt-2 text-gray-700">
                                <p>æˆ‘å¾ˆå–œæ¬¢è¿™æœ¬ä¹¦ã€‚(WÇ’ hÄ›n xÇhuan zhÃ¨ bÄ›n shÅ«.)</p>
                                <p class="mt-2 text-right font-bold text-red-600">ÄÃ¡p Ã¡n: [ E ]</p>
                            </div>
                        </div>
                        <img src="https://res.cloudinary.com/dvkx1wuml/image/upload/v1772162995/%E6%88%AA%E5%B1%8F2026-02-27_10.26.16_slkga7.png" class="w-full rounded border">
                        <div class="grid grid-cols-3 md:grid-cols-5 gap-3 mt-4" id="doc-part2"></div>
                    </div>

                    <!-- Äá»c Pháº§n 3 -->
                    <div>
                        <h3 class="text-lg font-bold bg-gray-200 px-3 py-1 rounded mb-3">Pháº§n 3: CÃ¢u 31 - 35</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Chá»n cÃ¢u tráº£ lá»i phÃ¹ há»£p (A-F).</p>
                        <div class="bg-white p-4 border rounded mb-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 font-bold text-gray-700 bg-gray-100 p-4 rounded">
                                <div>A. éƒ½å¾ˆå¥½ã€‚(DÅu hÄ›n hÇo.)</div><div>B. æ˜¨å¤©ä¸‹åˆã€‚(ZuÃ³tiÄn xiÃ wÇ”.)</div>
                                <div>C. é‚£å„¿ã€‚(NÃ r.)</div><div>D. å¬ä½ çš„ã€‚(TÄ«ng nÇ de.)</div>
                                <div>E. åé¢çš„äººã€‚(HÃ²umian de rÃ©n.)</div><div>F. å¥½çš„ï¼Œè°¢è°¢ï¼(HÇo de, xiÃ¨xie!)</div>
                            </div>
                            <div class="example-box mb-6">
                                <span class="bg-yellow-400 text-yellow-900 font-bold px-2 py-1 rounded text-xs mr-2">VÃ­ dá»¥ / ä¾‹å¦‚</span>
                                ä½ å–æ°´å—ï¼Ÿ(NÇ hÄ“ shuÇ ma?) <span class="float-right font-bold text-red-600">ÄÃ¡p Ã¡n: [ F ]</span>
                            </div>
                            <div class="space-y-4" id="doc-part3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= STEP 3: VIáº¾T ================= -->
            <div id="step-3" class="step-content hidden print-break">
                <h2 class="text-2xl font-bold text-red-700 mb-2 flex items-center"><i class="fas fa-keyboard mr-2"></i>Pháº§n Viáº¿t Chá»¯ HÃ¡n (15 cÃ¢u - 45 Ä‘iá»ƒm)</h2>
                <div class="bg-red-50 p-4 rounded border-l-4 border-red-500 mb-6">
                    <p class="font-bold text-red-800 mb-1">YÃªu cáº§u báº¯t buá»™c:</p>
                    <ul class="list-disc ml-5 text-gray-700 text-sm">
                        <li>GÃµ chá»¯ HÃ¡n tÆ°Æ¡ng á»©ng vá»›i phiÃªn Ã¢m Pinyin.</li>
                        <li><b>Báº®T BUá»˜C</b> nháº­p Ä‘áº§y Ä‘á»§ dáº¥u cÃ¢u tiáº¿ng Trung (<code>ï¼Œ</code> <code>ã€‚</code> <code>ï¼Ÿ</code>) y há»‡t nhÆ° cáº¥u trÃºc Pinyin.</li>
                    </ul>
                </div>
                <div class="space-y-4" id="section-viet"></div>
            </div>

            <!-- ================= STEP 4: Dá»ŠCH ================= -->
            <div id="step-4" class="step-content hidden print-break">
                <h2 class="text-2xl font-bold text-red-700 mb-2 flex items-center"><i class="fas fa-language mr-2"></i>Pháº§n Dá»‹ch Thuáº­t (15 cÃ¢u - 45 Ä‘iá»ƒm)</h2>
                <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500 mb-6">
                    <p class="text-gray-700">YÃªu cáº§u: NhÃ¬n chá»¯ HÃ¡n & phiÃªn Ã¢m, dá»‹ch sÃ¡t nghÄ©a sang tiáº¿ng Viá»‡t.</p>
                </div>
                <div class="space-y-4" id="section-dich"></div>
            </div>

            <!-- ================= STEP 5: Tá»ª Vá»°NG ================= -->
            <div id="step-5" class="step-content hidden print-break">
                <h2 class="text-2xl font-bold text-red-700 mb-2 flex items-center"><i class="fas fa-font mr-2"></i>Pháº§n Chá»¯ HÃ¡n (10 chá»¯ - 10 Ä‘iá»ƒm)</h2>
                <p class="text-gray-600 mb-6 italic bg-gray-50 p-3 rounded border-l-4 border-gray-400">YÃªu cáº§u: Chá»n nghÄ©a tiáº¿ng Viá»‡t phÃ¹ há»£p vá»›i chá»¯ HÃ¡n tá»« danh sÃ¡ch.</p>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="section-han"></div>
            </div>

            <!-- NÃšT Gá»¬I VÃ€ Káº¾T QUáº¢ -->
            <div id="btnNav" class="flex justify-between mt-10 border-t pt-6 bg-white sticky bottom-0 z-10 pb-4">
                <button type="button" id="prevBtn" class="px-5 md:px-8 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 hidden transition-colors shadow"><i class="fas fa-arrow-left mr-2"></i> Quay láº¡i</button>
                <button type="button" id="nextBtn" class="px-5 md:px-8 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 ml-auto transition-colors shadow">Tiáº¿p theo <i class="fas fa-arrow-right ml-2"></i></button>
                <button type="submit" id="submitBtn" class="px-6 md:px-10 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 hidden shadow-lg transform transition hover:scale-105"><i class="fas fa-paper-plane mr-2"></i> Ná»˜P BÃ€I THI</button>
            </div>
            
            <button type="button" id="printBtn" class="hidden mx-auto mt-6 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><i class="fas fa-file-pdf mr-2"></i> XUáº¤T PDF LÆ¯U TRá»®</button>
            
            <div id="loadingMsg" class="hidden mt-4 text-center text-blue-600 font-bold"><i class="fas fa-spinner fa-spin mr-2"></i> Äang cháº¥m Ä‘iá»ƒm vÃ  Ä‘á»“ng bá»™ dá»¯ liá»‡u...</div>
            <div id="resultBox" class="hidden mt-6 bg-green-100 border-2 border-green-500 text-green-800 p-6 md:p-8 rounded-xl text-xl font-bold shadow-lg"></div>

        </form>

        <!-- FOOTER & TEACHER PORTAL -->
        <div class="bg-gray-800 text-gray-400 text-center py-4 mt-8 text-sm no-print relative">
            &copy; 2026 HANAI LAB. Há»‡ thá»‘ng thi tráº¯c nghiá»‡m.
            <button type="button" onclick="openTeacherModal()" class="absolute right-4 top-3 text-gray-500 hover:text-white transition"><i class="fas fa-user-cog"></i> Khu vá»±c GiÃ¡o viÃªn</button>
        </div>
    </div>

    <!-- MODAL GIÃO VIÃŠN CHá»ˆNH Sá»¬A -->
    <div id="teacherModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-red-700"><i class="fas fa-tools mr-2"></i>Báº£ng Ä‘iá»u khiá»ƒn GiÃ¡o viÃªn</h2>
                <button onclick="closeTeacherModal()" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Táº¡i Ä‘Ã¢y cÃ´ cÃ³ thá»ƒ chá»‰nh sá»­a Ä‘Ã¡p Ã¡n trá»±c tiáº¿p. Sau khi lÆ°u, hÃ£y báº¥m "Cháº¥m láº¡i bÃ i" Ä‘á»ƒ há»‡ thá»‘ng tÃ­nh láº¡i Ä‘iá»ƒm theo Ä‘Ã¡p Ã¡n má»›i.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="font-bold text-gray-700">1. ÄÃ¡p Ã¡n Nghe (JSON):</label>
                    <textarea id="editAnsNghe" rows="4" class="w-full text-sm font-mono border p-2 rounded bg-gray-50 mt-1"></textarea>
                </div>
                <div>
                    <label class="font-bold text-gray-700">2. ÄÃ¡p Ã¡n Äá»c (JSON):</label>
                    <textarea id="editAnsDoc" rows="4" class="w-full text-sm font-mono border p-2 rounded bg-gray-50 mt-1"></textarea>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeTeacherModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 font-bold">Há»§y</button>
                <button type="button" onclick="saveTeacherSettings()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold"><i class="fas fa-save mr-1"></i> LÆ°u CÃ i Äáº·t</button>
                <button type="button" id="regradeBtn" onclick="regradeExam()" class="hidden px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold"><i class="fas fa-redo mr-1"></i> Cháº¥m Láº¡i BÃ i</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Dá»® LIá»†U Äá»€ THI (DÃ¹ng let Ä‘á»ƒ GiÃ¡o viÃªn cÃ³ thá»ƒ ghi Ä‘Ã¨)
        // ==========================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4ORte-q8HWtEZ5r0HEBDUedaFFIOI10GbkUoHQlON0ktxSxZ3URovyU4oisw90Q_s/exec"; 

        let ansNghe = { "nghe_1": "F", "nghe_2": "F", "nghe_3": "F", "nghe_4": "T", "nghe_5": "T", "nghe_6": "B", "nghe_7": "A", "nghe_8": "C", "nghe_9": "A", "nghe_10": "B", "nghe_11": "E", "nghe_12": "F", "nghe_13": "D", "nghe_14": "B", "nghe_15": "A", "nghe_16": "C", "nghe_17": "A", "nghe_18": "C", "nghe_19": "C", "nghe_20": "B" };
        let ansDoc = { "doc_21": "F", "doc_22": "T", "doc_23": "F", "doc_24": "T", "doc_25": "T", "doc_26": "A", "doc_27": "B", "doc_28": "C", "doc_29": "D", "doc_30": "F", "doc_31": "C", "doc_32": "E", "doc_33": "B", "doc_34": "D", "doc_35": "A" };

        let dataViet = [
            { id: "v1", q: "WÇ’ shÃ¬ xuÃ© sheng.", ans: "æˆ‘æ˜¯å­¦ç”Ÿã€‚" }, { id: "v2", q: "NÇ jiÃ o shÃ©n me mÃ­ng zi?", ans: "ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ" },
            { id: "v3", q: "JÄ«n tiÄn xÄ«ng qÄ« jÇ?", ans: "ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ" }, { id: "v4", q: "WÇ’ xiÇng chÄ« mÇ fÃ n.", ans: "æˆ‘æƒ³åƒç±³é¥­ã€‚" },
            { id: "v5", q: "NÇ mÇi shÃ©n me le?", ans: "ä½ ä¹°ä»€ä¹ˆäº†ï¼Ÿ" }, { id: "v6", q: "BÄ“i zi zÃ i yÄ« zi shÃ ng miÃ n.", ans: "æ¯å­åœ¨æ¤…å­ä¸Šé¢ã€‚" },
            { id: "v7", q: "HÄ›n gÄo xÃ¬ng rÃ¨n shi nÃ­n.", ans: "å¾ˆé«˜å…´è®¤è¯†æ‚¨ã€‚" }, { id: "v8", q: "MÃ­ng tiÄn shÃ¬ 2026 niÃ¡n 2 yuÃ¨ 28 rÃ¬.", ans: "æ˜å¤©æ˜¯2026å¹´2æœˆ28æ—¥ã€‚" },
            { id: "v9", q: "RÃ¨n shi nÃ­n wÇ’ yÄ› hÄ›n gÄo xÃ¬ng.", ans: "è®¤è¯†æ‚¨æˆ‘ä¹Ÿå¾ˆé«˜å…´ã€‚" }, { id: "v10", q: "TÄ shÃ¬ yÄ« shÄ“ng, tÄ zÃ i yÄ« yuÃ n gÅng zuÃ².", ans: "ä»–æ˜¯åŒ»ç”Ÿï¼Œä»–åœ¨åŒ»é™¢å·¥ä½œã€‚" },
            { id: "v11", q: "NÇ shÃ¬ zÄ›n me lÃ¡i fÃ n diÃ n de?", ans: "ä½ æ˜¯æ€ä¹ˆæ¥é¥­åº—çš„ï¼Ÿ" }, { id: "v12", q: "WÇ’ men shÃ¬ zuÃ² chÅ« zÅ« chÄ“ lÃ¡i de.", ans: "æˆ‘ä»¬æ˜¯åå‡ºç§Ÿè½¦æ¥çš„ã€‚" },
            { id: "v13", q: "TÄ shÃ¬ hÃ© pÃ©ng you yÃ¬ qÇ kÄi chÄ“ lÃ¡i de.", ans: "ä»–æ˜¯å’Œæœ‹å‹ä¸€èµ·å¼€è½¦æ¥çš„ã€‚" }, { id: "v14", q: "NÃ­n shÃ¬ zuÃ² fÄ“i jÄ« lÃ¡i BÄ›i jÄ«ng de ma?", ans: "æ‚¨æ˜¯åé£æœºæ¥åŒ—äº¬çš„å—ï¼Ÿ" },
            { id: "v15", q: "ZhÄng xiÇo jie zhÃ¹ zÃ i zhÃ¨r, xiÇo mÄo hÃ© xiÇo gÇ’u dÅu shÃ¬ tÄ de.", ans: "å¼ å°å§ä½åœ¨è¿™å„¿ï¼Œå°çŒ«å’Œå°ç‹—éƒ½æ˜¯å¥¹çš„ã€‚" }
        ];

        let dataDich = [
            { id: "d1", h: "å¥¹æ˜¯è€å¸ˆå—ï¼Ÿ", p: "TÄ shÃ¬ lÇo shÄ« ma?", ansShow: "CÃ´ áº¥y lÃ  giÃ¡o viÃªn pháº£i khÃ´ng?", keys: ["cÃ´ áº¥y", "giÃ¡o viÃªn"] },
            { id: "d2", h: "æˆ‘ä¸å»å­¦æ ¡ã€‚", p: "WÇ’ bÃº qÃ¹ xuÃ© xiÃ o.", ansShow: "TÃ´i khÃ´ng Ä‘i Ä‘áº¿n trÆ°á»ng / há»c.", keys: ["tÃ´i khÃ´ng", "trÆ°á»ng"] },
            { id: "d3", h: "æ˜¨å¤©å‡ å·ï¼Ÿ", p: "ZuÃ³ tiÄn jÇ hÃ o?", ansShow: "HÃ´m qua ngÃ y máº¥y?", keys: ["hÃ´m qua", "máº¥y"] },
            { id: "d4", h: "ä½ æƒ³å–ä»€ä¹ˆï¼Ÿ", p: "NÇ xiÇng hÄ“ shÃ©n me?", ansShow: "Báº¡n muá»‘n uá»‘ng gÃ¬?", keys: ["muá»‘n uá»‘ng", "gÃ¬"] },
            { id: "d5", h: "ä¸å†·ä¸çƒ­ã€‚", p: "BÃ¹ lÄ›ng bÃ¹ rÃ¨.", ansShow: "KhÃ´ng láº¡nh khÃ´ng nÃ³ng.", keys: ["khÃ´ng láº¡nh", "khÃ´ng nÃ³ng"] },
            { id: "d6", h: "è¿™ä¸ªæ¯å­å¤šå°‘é’±ï¼Ÿ", p: "ZhÃ¨ ge bÄ“i zi duÅ shÇo qiÃ¡n?", ansShow: "CÃ¡i cá»‘c/ly nÃ y bao nhiÃªu tiá»n?", keys: ["cá»‘c", "bao nhiÃªu"] },
            { id: "d7", h: "æˆ‘çš„å°ç‹—åœ¨æ¤…å­ä¸‹é¢ã€‚", p: "WÇ’ de xiÇo gÇ’u zÃ i yÄ« zi xiÃ  miÃ n.", ansShow: "Con chÃ³ nhá» cá»§a tÃ´i á»Ÿ dÆ°á»›i gháº¿.", keys: ["con chÃ³", "dÆ°á»›i"] },
            { id: "d8", h: "ä»–ä»€ä¹ˆæ—¶å€™èƒ½å›æ¥ï¼Ÿ", p: "TÄ shÃ©n me shÃ­ hou nÃ©ng huÃ­ lai?", ansShow: "Khi nÃ o anh áº¥y cÃ³ thá»ƒ vá» / quay láº¡i?", keys: ["khi nÃ o", "vá»"] },
            { id: "d9", h: "æ˜å¤©ä¸‹åˆæˆ‘æƒ³å»å­¦æ ¡çœ‹ä¹¦ã€‚", p: "MÃ­ng tiÄn xiÃ  wÇ” wÇ’ xiÇng qÃ¹ xuÃ© xiÃ o kÃ n shÅ«.", ansShow: "Chiá»u mai tÃ´i muá»‘n Ä‘áº¿n trÆ°á»ng Ä‘á»c sÃ¡ch.", keys: ["chiá»u mai", "trÆ°á»ng", "Ä‘á»c sÃ¡ch"] },
            { id: "d10", h: "ç‹æ–¹çš„è¡£æœå¤ªæ¼‚äº®äº†ï¼", p: "WÃ¡ng fÄng de yÄ« fu tÃ i piÃ o liang le!", ansShow: "Quáº§n Ã¡o cá»§a VÆ°Æ¡ng PhÆ°Æ¡ng Ä‘áº¹p quÃ¡!", keys: ["quáº§n Ã¡o", "Ä‘áº¹p"] },
            { id: "d11", h: "ä»Šå¤©æ™šä¸Šæˆ‘ä»¬å»ä»–å®¶çœ‹ç”µè§†ã€‚", p: "JÄ«n tiÄn wÇn shang wÇ’ men qÃ¹ tÄ jiÄ kÃ n diÃ n shÃ¬.", ansShow: "Tá»‘i nay chÃºng tÃ´i Ä‘áº¿n nhÃ  anh áº¥y xem tivi.", keys: ["tá»‘i nay", "xem tivi"] },
            { id: "d12", h: "å¦ˆå¦ˆå»å•†åº—ä¹°äº†å¾ˆå¤šæ°´æœã€‚", p: "MÄ ma qÃ¹ shÄng diÃ n mÇi le hÄ›n duÅ shuÇ guÇ’.", ansShow: "Máº¹ Ä‘i cá»­a hÃ ng mua ráº¥t nhiá»u hoa quáº£/trÃ¡i cÃ¢y.", keys: ["máº¹", "cá»­a hÃ ng", "hoa quáº£"] },
            { id: "d13", h: "è¿™ä¸ªæ˜ŸæœŸæˆ‘èº«ä½“ä¸å¤ªå¥½ï¼Œä¸æƒ³åƒé¥­ã€‚", p: "ZhÃ¨ ge xÄ«ng qÄ« wÇ’ shÄ“n tÇ bÃ¹ tÃ i hÇo, bÃ¹ xiÇng chÄ« fÃ n.", ansShow: "Tuáº§n nÃ y sá»©c khá»e tÃ´i khÃ´ng tá»‘t láº¯m, khÃ´ng muá»‘n Äƒn cÆ¡m.", keys: ["tuáº§n nÃ y", "khÃ´ng tá»‘t", "khÃ´ng muá»‘n"] },
            { id: "d14", h: "ä½ ä»¬éƒ½æ¥æˆ‘å®¶åƒé¥­å§ï¼Œæˆ‘åšäº†ä¸å°‘èœã€‚", p: "NÇ men dÅu lÃ¡i wÇ’ jiÄ chÄ« fÃ n ba, wÇ’ zuÃ² le bÃ¹ shÇo cÃ i.", ansShow: "CÃ¡c báº¡n Ä‘á»u Ä‘áº¿n nhÃ  tÃ´i Äƒn cÆ¡m nhÃ©, tÃ´i Ä‘Ã£ lÃ m khÃ´ng Ã­t mÃ³n.", keys: ["Ä‘áº¿n nhÃ  tÃ´i", "Äƒn cÆ¡m", "khÃ´ng Ã­t"] },
            { id: "d15", h: "æˆ‘æ²¡çœ‹è§ç‹è€å¸ˆçš„å¥³æœ‹å‹ï¼Œå¥¹æ¼‚äº®å§ï¼Ÿ", p: "WÇ’ mÃ©i kÃ n jiÃ n wÃ¡ng lÇo shÄ« de nÇš pÃ©ng you, tÄ piÃ o liang ba?", ansShow: "TÃ´i khÃ´ng nhÃ¬n tháº¥y báº¡n gÃ¡i cá»§a tháº§y VÆ°Æ¡ng, cÃ´ áº¥y xinh chá»©?", keys: ["khÃ´ng nhÃ¬n tháº¥y", "báº¡n gÃ¡i", "xinh"] }
        ];

        let dataHan = [
            { id: "h1", q: "å¹´", ans: "nÄƒm" }, { id: "h2", q: "å‡º", ans: "ra" }, { id: "h3", q: "é£", ans: "bay" }, { id: "h4", q: "æ—¥", ans: "ngÃ y" }, { id: "h5", q: "æœˆ", ans: "thÃ¡ng" },
            { id: "h6", q: "ç›®", ans: "máº¯t" }, { id: "h7", q: "å¤©", ans: "trá»i" }, { id: "h8", q: "é›¨", ans: "mÆ°a" }, { id: "h9", q: "ç”µ", ans: "Ä‘iá»‡n" }, { id: "h10", q: "æ°”", ans: "khÃ­" }
        ];
        const vocabOptions = ["nÄƒm", "ra", "bay", "ngÃ y", "thÃ¡ng", "máº¯t", "trá»i", "mÆ°a", "Ä‘iá»‡n", "khÃ­"].sort();

        // Load overrides cá»§a GiÃ¡o viÃªn (náº¿u cÃ³)
        function loadTeacherSettings() {
            let savedNghe = localStorage.getItem('hsk1_teacher_nghe');
            let savedDoc = localStorage.getItem('hsk1_teacher_doc');
            if(savedNghe) ansNghe = JSON.parse(savedNghe);
            if(savedDoc) ansDoc = JSON.parse(savedDoc);
        }
        loadTeacherSettings();

        // ==========================================
        // RENDER GIAO DIá»†N Báº°NG JAVASCRIPT
        // ==========================================
        function initRender() {
            // Render Nghe 1-15
            const tfOpt = `<option value="">- Chá»n -</option><option value="T">True (âˆš)</option><option value="F">False (X)</option>`;
            const abcOpt = `<option value="">- Chá»n -</option><option value="A">A</option><option value="B">B</option><option value="C">C</option>`;
            const afOpt = `<option value="">- Chá»n -</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option>`;
            
            const createSelect = (name, opt) => `<div><label class="block text-sm text-center font-bold mb-1">CÃ¢u ${name.split('_')[1]}</label>
                <div class="wrong-alert text-center"><i class="fas fa-times"></i> Sai</div>
                <select name="${name}" required class="w-full px-2 py-2 border rounded font-bold text-center text-red-700 bg-gray-50 focus:ring-2 focus:ring-red-500">${opt}</select></div>`;
            
            document.getElementById('nghe-part1').innerHTML = [1,2,3,4,5].map(i => createSelect('nghe_'+i, tfOpt)).join('');
            document.getElementById('nghe-part2a').innerHTML = [6,7,8].map(i => createSelect('nghe_'+i, abcOpt)).join('');
            document.getElementById('nghe-part2b').innerHTML = [9,10].map(i => createSelect('nghe_'+i, abcOpt)).join('');
            document.getElementById('nghe-part3').innerHTML = [11,12,13,14,15].map(i => createSelect('nghe_'+i, afOpt)).join('');
            
            // Render Nghe 4
            const opts4 = [ ["7 å—", "8 å—", "18 å—"], ["é¥­åº—", "å®¶é‡Œ", "æœ‹å‹å®¶"], ["å†™å­—", "çœ‹ç”µè§†", "æ‰“ç”µè¯"], ["æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­", "æ˜ŸæœŸæ—¥"], ["å¼€è½¦", "åé£æœº", "åç«è½¦"] ];
            document.getElementById('nghe-part4').innerHTML = `<div class="space-y-4">` + opts4.map((opts, idx) => {
                let i = idx + 16;
                return `<div class="flex flex-col md:flex-row md:items-center justify-between border-b pb-4">
                    <div class="flex-1 mb-2 md:mb-0"><b>${i}.</b><span class="ml-2 mr-4 inline-block">A. ${opts[0]}</span><span class="mr-4 inline-block">B. ${opts[1]}</span><span class="inline-block">C. ${opts[2]}</span></div>
                    <div class="flex flex-col items-center"><div class="wrong-alert"><i class="fas fa-times"></i> Sai</div><select name="nghe_${i}" required class="w-full md:w-32 px-2 py-2 border rounded font-bold text-center text-red-700 bg-gray-50">${abcOpt}</select></div></div>`;
            }).join('') + `</div>`;

            // Render Äá»c 1-2
            document.getElementById('doc-part1').innerHTML = [21,22,23,24,25].map(i => createSelect('doc_'+i, tfOpt)).join('');
            document.getElementById('doc-part2').innerHTML = [26,27,28,29,30].map(i => createSelect('doc_'+i, afOpt)).join('');
            
            // Render Äá»c 3
            const qsDoc3 = ["åŒ»ç”Ÿåœ¨å“ªå„¿ï¼Ÿ", "è°åœ¨è¯´è¯ï¼Ÿ", "æå…ˆç”Ÿæ˜¯ä»€ä¹ˆæ—¶å€™æ¥çš„ï¼Ÿ", "æˆ‘ä»¬å»ä¸‹é¢åƒï¼Ÿ", "é‚£å‡ æœ¬ä¹¦æ€ä¹ˆæ ·ï¼Ÿ"];
            document.getElementById('doc-part3').innerHTML = qsDoc3.map((q, idx) => {
                let i = idx + 31;
                return `<div class="flex flex-col md:flex-row md:items-center justify-between border-b pb-4"><span class="mb-2 md:mb-0"><b>${i}.</b> ${q}</span>
                    <div class="flex flex-col items-center"><div class="wrong-alert"><i class="fas fa-times"></i> Sai</div><select name="doc_${i}" required class="w-full md:w-32 px-2 py-2 border rounded font-bold text-center text-red-700 bg-gray-50">${afOpt}</select></div></div>`;
            }).join('');

            // Render Viáº¿t, Dá»‹ch, HÃ¡n Tá»± (KÃ¨m theo Ã´ Ä‘Ã¡p Ã¡n áº©n)
            document.getElementById('section-viet').innerHTML = dataViet.map((item, idx) => `<div class="bg-white p-4 rounded border shadow-sm"><label class="block font-bold text-gray-800 text-lg">${idx + 1}. ${item.q}</label><div class="wrong-alert mt-2">âŒ Sai hoáº·c thiáº¿u dáº¥u cÃ¢u.</div><input type="text" name="${item.id}" required class="w-full mt-1 px-3 py-3 border rounded focus:ring-2 focus:ring-red-500" placeholder="Nháº­p chá»¯ HÃ¡n kÃ¨m dáº¥u cÃ¢u..."><div class="correct-answer">âœ… ÄÃ¡p Ã¡n chuáº©n: <b>${item.ans}</b></div></div>`).join('');
            document.getElementById('section-dich').innerHTML = dataDich.map((item, idx) => `<div class="bg-white p-4 rounded border shadow-sm"><label class="block font-bold text-gray-800 text-lg">${idx + 1}. ${item.h}</label><div class="text-sm text-gray-600 mb-2">${item.p}</div><div class="wrong-alert">âŒ Dá»‹ch chÆ°a sÃ¡t nghÄ©a.</div><textarea name="${item.id}" required rows="2" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-red-500" placeholder="Nháº­p báº£n dá»‹ch tiáº¿ng Viá»‡t..."></textarea><div class="correct-answer">âœ… Gá»£i Ã½ cá»§a GiÃ¡o viÃªn: <b>${item.ansShow}</b></div></div>`).join('');
            
            const hanOpt = `<option value="">- Chá»n -</option>` + vocabOptions.map(o => `<option value="${o}">${o}</option>`).join('');
            document.getElementById('section-han').innerHTML = dataHan.map(item => `<div class="bg-white p-3 rounded border shadow-sm text-center"><label class="block font-bold text-4xl text-red-700 mb-3 mt-1">${item.q}</label><div class="wrong-alert">âŒ Sai</div><select name="${item.id}" required class="w-full px-2 py-3 border rounded font-bold text-lg text-center bg-gray-50">${hanOpt}</select><div class="correct-answer">âœ… <b>${item.ans}</b></div></div>`).join('');
            
            renderAnswerTags(); // ThÃªm há»™p Ä‘Ã¡p Ã¡n cho Nghe & Äá»c
        }

        function renderAnswerTags() {
            // XÃ³a cÃ¡c Ã´ Ä‘Ã¡p Ã¡n cÅ© náº¿u cÃ³ (khi render láº¡i)
            document.querySelectorAll('.auto-ans-tag').forEach(e => e.remove());
            
            const addTag = (obj, isTF) => {
                Object.keys(obj).forEach(k => {
                    let selectEl = document.getElementsByName(k)[0];
                    if(selectEl) {
                        let text = obj[k] === 'T' ? 'True (âˆš)' : (obj[k] === 'F' ? 'False (X)' : obj[k]);
                        let div = document.createElement('div');
                        div.className = "correct-answer auto-ans-tag text-xs mt-1 p-1 text-center font-bold";
                        div.innerHTML = `âœ… ÄA: ${text}`;
                        selectEl.parentNode.appendChild(div);
                    }
                });
            }
            addTag(ansNghe, false);
            addTag(ansDoc, false);
        }
        initRender();

        // ==========================================
        // KHÃ“A AUDIO
        // ==========================================
        document.getElementById('examAudio').addEventListener('ended', function() {
            this.controls = false; this.src = ""; 
            const warn = document.getElementById('audioWarning');
            warn.innerHTML = "ğŸ”’ ÄÃ£ phÃ¡t xong file nghe. KhÃ³a chá»©c nÄƒng nghe láº¡i.";
            warn.classList.add("bg-red-100");
        });

        // ==========================================
        // WIZARD (ÄIá»€U HÆ¯á»šNG BÆ¯á»šC) & PASSWORD Há»ŒC SINH
        // ==========================================
        const TOTAL_STEPS = 6;
        let currentStep = 0;
        let autoAdvancedFlags = [false, false, false, false, false, false];

        function updateWizardUI() {
            for(let i=0; i<TOTAL_STEPS; i++) {
                document.getElementById(`step-${i}`).classList.add('hidden');
                let nav = document.querySelectorAll('.step-nav-item')[i];
                nav.className = "step-nav-item pb-2 px-3 transition-colors border-transparent text-gray-400";
                if(i < currentStep) nav.classList.add('text-gray-800');
            }
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            let currNav = document.querySelectorAll('.step-nav-item')[currentStep];
            currNav.className = "step-nav-item pb-2 px-3 transition-colors text-red-600 font-bold border-b-2 border-red-600";
            currNav.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 0);
            if(currentStep === TOTAL_STEPS - 1) {
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('submitBtn').classList.remove('hidden');
            } else {
                document.getElementById('nextBtn').classList.remove('hidden');
                document.getElementById('submitBtn').classList.add('hidden');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateCurrentStep() {
            const stepEl = document.getElementById(`step-${currentStep}`);
            const inputs = stepEl.querySelectorAll('input[required], select[required], textarea[required]');
            for(let i=0; i<inputs.length; i++) {
                if(!inputs[i].checkValidity()) { inputs[i].reportValidity(); return false; }
            }
            
            // Validate Password Há»c sinh táº¡i BÆ°á»›c 0
            if(currentStep === 0) {
                const pwd = document.getElementById('studentPassword').value;
                if(pwd !== "27022006") {
                    alert("Sai máº­t kháº©u lÃ m bÃ i! Vui lÃ²ng liÃªn há»‡ giÃ¡o viÃªn Ä‘á»ƒ láº¥y máº­t kháº©u.");
                    return false;
                }
            }
            return true;
        }

        document.getElementById('prevBtn').addEventListener('click', () => { if(currentStep > 0) { currentStep--; updateWizardUI(); } });
        document.getElementById('nextBtn').addEventListener('click', () => {
            if(validateCurrentStep()) {
                if(currentStep === 0) startTimer(); // Báº¯t Ä‘áº§u Ä‘áº¿m ngÆ°á»£c khi qua BÆ°á»›c 1
                currentStep++; updateWizardUI();
            }
        });

        const form = document.getElementById('examForm');
        form.addEventListener('change', (e) => {
            if ([0, 1, 2, 5].includes(currentStep)) {
                if(!autoAdvancedFlags[currentStep]) {
                    const stepEl = document.getElementById(`step-${currentStep}`);
                    const inputs = Array.from(stepEl.querySelectorAll('input[required], select[required], textarea[required]'));
                    if(inputs.every(el => el.value.trim() !== '') && validateCurrentStep()) {
                        autoAdvancedFlags[currentStep] = true;
                        setTimeout(() => { if(currentStep < TOTAL_STEPS - 1 && document.getElementById(`step-${currentStep}`) === stepEl) document.getElementById('nextBtn').click(); }, 600);
                    }
                }
            }
            saveDraft();
        });

        // ==========================================
        // Äá»’NG Há»’ Äáº¾M NGÆ¯á»¢C (90 PHÃšT)
        // ==========================================
        let timerInterval;
        const EXAM_DURATION = 90 * 60; // 90 phÃºt (TÃ­nh báº±ng giÃ¢y)
        
        function startTimer() {
            let endTime = localStorage.getItem('hsk1_endTime');
            if(!endTime) {
                endTime = Date.now() + EXAM_DURATION * 1000;
                localStorage.setItem('hsk1_endTime', endTime);
            }
            updateTimerDisplay(endTime);
            timerInterval = setInterval(() => updateTimerDisplay(endTime), 1000);
        }

        function updateTimerDisplay(endTime) {
            if(isSubmitted) { clearInterval(timerInterval); return; }
            
            let remainMs = endTime - Date.now();
            if(remainMs <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timerDisplay').innerText = "00:00";
                document.getElementById('timerDisplay').classList.replace('text-yellow-300', 'text-red-500');
                alert("ÄÃ£ háº¿t thá»i gian lÃ m bÃ i (90 PhÃºt)! Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng ná»™p bÃ i vÃ  cháº¥m Ä‘iá»ƒm.");
                submitExam(true); // Ã‰p ná»™p bÃ i
                return;
            }
            
            let totalSeconds = Math.floor(remainMs / 1000);
            let m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            let s = (totalSeconds % 60).toString().padStart(2, '0');
            let display = document.getElementById('timerDisplay');
            display.innerText = `${m}:${s}`;
            
            // Äá»•i mÃ u cáº£nh bÃ¡o khi cÃ²n dÆ°á»›i 5 phÃºt
            if(totalSeconds < 300) display.classList.replace('text-yellow-300', 'text-red-300');
        }

        // ==========================================
        // Báº¢O Máº¬T & AUTO SAVE
        // ==========================================
        let cheatCount = 0;
        let isSubmitted = false;

        document.addEventListener("visibilitychange", () => {
            if (document.hidden && !isSubmitted && currentStep > 0) { cheatCount++; alert("âš ï¸ Cáº¢NH BÃO: Báº¡n vá»«a chuyá»ƒn tab/thoÃ¡t trang thi!\nHÃ nh Ä‘á»™ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c ghi láº¡i (Sá»‘ láº§n: " + cheatCount + ")"); }
        });

        window.addEventListener('beforeunload', function (e) {
            if (!isSubmitted && currentStep > 0) { e.preventDefault(); e.returnValue = 'ThoÃ¡t sáº½ máº¥t dá»¯ liá»‡u chÆ°a lÆ°u!'; }
        });

        function saveDraft() {
            if(isSubmitted) return;
            const dataObj = Object.fromEntries(new FormData(form).entries());
            localStorage.setItem('hsk1_draft', JSON.stringify({ timestamp: Date.now(), data: dataObj, cheats: cheatCount, step: currentStep }));
        }

        window.onload = function() {
            updateWizardUI();
            const draftStr = localStorage.getItem('hsk1_draft');
            if (draftStr) {
                const draft = JSON.parse(draftStr);
                // KhÃ´i phá»¥c náº¿u nhÃ¡p chÆ°a quÃ¡ 90 phÃºt
                if (Date.now() - draft.timestamp < 90 * 60 * 1000) {
                    if(confirm("Há»‡ thá»‘ng tÃ¬m tháº¥y báº£n lÃ m bÃ i Ä‘ang dang dá»Ÿ cá»§a báº¡n. Báº¡n cÃ³ muá»‘n tiáº¿p tá»¥c khÃ´ng?")) {
                        cheatCount = draft.cheats || 0;
                        for (let key in draft.data) { let el = form.elements[key]; if (el) el.value = draft.data[key]; }
                        currentStep = draft.step || 0;
                        updateWizardUI();
                        if(currentStep > 0) startTimer(); // Phá»¥c há»“i timer
                    } else { localStorage.removeItem('hsk1_endTime'); localStorage.removeItem('hsk1_draft'); }
                } else { localStorage.removeItem('hsk1_endTime'); localStorage.removeItem('hsk1_draft'); }
            }
        };

        // ==========================================
        // CHáº¤M ÄIá»‚M & Ná»˜P BÃ€I (TÃ¡ch hÃ m Ä‘á»ƒ TÃ¡i sá»­ dá»¥ng)
        // ==========================================
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if(!validateCurrentStep()) return;
            if(confirm("XÃ¡c nháº­n ná»™p bÃ i? Há»‡ thá»‘ng sáº½ khÃ³a bÃ i lÃ m vÃ  tá»± Ä‘á»™ng cháº¥m Ä‘iá»ƒm.")) {
                submitExam(false);
            }
        });

        function submitExam(isForce = false) {
            isSubmitted = true;
            clearInterval(timerInterval);
            document.getElementById('btnNav').classList.add('hidden');
            document.getElementById('loadingMsg').classList.remove('hidden');

            gradeExamLogic();
        }

        function gradeExamLogic() {
            const formData = new FormData(form);
            let correctNghe = 0, correctDoc = 0, scoreViet = 0, scoreDich = 0, scoreHan = 0;

            // XoÃ¡ class cÅ© Ä‘á»ƒ phá»¥c vá»¥ cháº¥m láº¡i (GiÃ¡o viÃªn)
            form.querySelectorAll('.input-correct, .input-wrong').forEach(el => el.classList.remove('input-correct', 'input-wrong'));

            const checkObj = (ansObj, countVar) => {
                let count = 0;
                Object.keys(ansObj).forEach(key => {
                    let el = form.elements[key];
                    if(el) {
                        let userVal = el.value.trim().toUpperCase();
                        let isCorrect = (userVal === ansObj[key]);
                        if(isCorrect) { count++; el.classList.add('input-correct'); } else { el.classList.add('input-wrong'); }
                    }
                });
                return count;
            };
            correctNghe = checkObj(ansNghe, correctNghe);
            correctDoc = checkObj(ansDoc, correctDoc);

            dataViet.forEach(item => {
                let userAns = (formData.get(item.id) || "").replace(/\s+/g, '');
                let inputEl = form.elements[item.id];
                if (userAns === item.ans.replace(/\s+/g, '')) { scoreViet += 3; inputEl.classList.add('input-correct'); } else { inputEl.classList.add('input-wrong'); }
            });

            dataDich.forEach(item => {
                let userAns = (formData.get(item.id) || "").toLowerCase();
                let inputEl = form.elements[item.id];
                let matchCount = item.keys.filter(kw => userAns.includes(kw.toLowerCase())).length;
                if (matchCount >= (item.keys.length / 2)) { scoreDich += 3; inputEl.classList.add('input-correct'); } else { inputEl.classList.add('input-wrong'); }
            });

            dataHan.forEach(item => {
                let inputEl = form.elements[item.id];
                if (formData.get(item.id) === item.ans) { scoreHan += 1; inputEl.classList.add('input-correct'); } else { inputEl.classList.add('input-wrong'); }
            });

            let scoreNgheNum = correctNghe * 2.5; 
            let scoreDocNum = Math.round((correctDoc * (50/15)) * 10) / 10; 
            let totalScoreNum = scoreNgheNum + scoreDocNum + scoreViet + scoreDich + scoreHan;

            // Hiá»ƒn thá»‹ UI Ä‘Ã¡p Ã¡n
            form.classList.add('show-answer');
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('hidden'));
            document.getElementById('stepNav').classList.add('hidden');
            document.getElementById('printBtn').classList.remove('hidden');

            const resultBox = document.getElementById('resultBox');
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = `
                <h3 class="text-3xl font-black mb-2 text-center text-red-700">Káº¾T QUáº¢ BÃ€I THI</h3>
                <p class="text-center mb-6">Há»c viÃªn: <b class="text-red-700 uppercase">${formData.get('studentName')}</b></p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg bg-white p-5 rounded-lg border-2 border-green-400">
                    <p>ğŸ§ <b>Nghe:</b> <span class="text-blue-600">${correctNghe} / 20</span> (â‰ˆ ${scoreNgheNum}Ä‘)</p>
                    <p>ğŸ“– <b>Äá»c:</b> <span class="text-blue-600">${correctDoc} / 15</span> (â‰ˆ ${scoreDocNum}Ä‘)</p>
                    <p>âœï¸ <b>Viáº¿t:</b> <span class="text-blue-600">${scoreViet} / 45Ä‘</span></p>
                    <p>ğŸŒ <b>Dá»‹ch:</b> <span class="text-blue-600">${scoreDich} / 45Ä‘</span> <span class="text-xs italic text-gray-500">(MÃ¡y cháº¥m)</span></p>
                    <p class="md:col-span-2 text-center border-t pt-2 mt-2">ğŸ€„ <b>Chá»¯ HÃ¡n:</b> <span class="text-blue-600">${scoreHan} / 10Ä‘</span></p>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-3xl uppercase tracking-wider">Tá»•ng Ä‘iá»ƒm: <span class="text-red-600 font-black">${totalScoreNum}</span> / 200</p>
                </div>
            `;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            localStorage.removeItem('hsk1_draft');
            localStorage.removeItem('hsk1_endTime');

            // Send data
            const dataPost = new URLSearchParams();
            dataPost.append('name', formData.get('studentName'));
            dataPost.append('id', formData.get('studentId'));
            dataPost.append('scoreNghe', scoreNgheNum);
            dataPost.append('scoreDoc', scoreDocNum);
            dataPost.append('scoreViet', scoreViet);
            dataPost.append('scoreDich', scoreDich);
            dataPost.append('scoreHan', scoreHan);
            dataPost.append('totalScore', totalScoreNum);
            
            fetch(APPS_SCRIPT_URL, { method: 'POST', body: dataPost })
                .then(res => { document.getElementById('loadingMsg').innerHTML = "<span class='text-green-600'><i class='fas fa-check-circle'></i> Äiá»ƒm Ä‘Ã£ gá»­i vá» há»‡ thá»‘ng.</span>"; })
                .catch(err => { document.getElementById('loadingMsg').innerHTML = "<span class='text-gray-500 italic'>HoÃ n táº¥t cháº¥m Ä‘iá»ƒm.</span>"; });
            
            // KhÃ³a form
            form.querySelectorAll('input, textarea, select').forEach(i => i.disabled = true);
            document.getElementById('regradeBtn').classList.remove('hidden'); // Má»Ÿ khÃ³a nÃºt cháº¥m láº¡i cho giÃ¡o viÃªn
        }

        // ==========================================
        // Cá»”NG GIÃO VIÃŠN (Sá»¬A ÄÃP ÃN)
        // ==========================================
        function openTeacherModal() {
            let pwd = prompt("KHU Vá»°C GIÃO VIÃŠN\nVui lÃ²ng nháº­p máº­t kháº©u quáº£n trá»‹:");
            if(pwd === "Trungkio050701") {
                document.getElementById('teacherModal').classList.remove('hidden');
                document.getElementById('editAnsNghe').value = JSON.stringify(ansNghe, null, 2);
                document.getElementById('editAnsDoc').value = JSON.stringify(ansDoc, null, 2);
            } else if (pwd !== null) {
                alert("Sai máº­t kháº©u giÃ¡o viÃªn!");
            }
        }

        function closeTeacherModal() {
            document.getElementById('teacherModal').classList.add('hidden');
        }

        function saveTeacherSettings() {
            try {
                let newNghe = JSON.parse(document.getElementById('editAnsNghe').value);
                let newDoc = JSON.parse(document.getElementById('editAnsDoc').value);
                
                ansNghe = newNghe;
                ansDoc = newDoc;
                
                localStorage.setItem('hsk1_teacher_nghe', JSON.stringify(ansNghe));
                localStorage.setItem('hsk1_teacher_doc', JSON.stringify(ansDoc));
                
                renderAnswerTags(); // Cáº­p nháº­t láº¡i nhÃ£n Ä‘Ã¡p Ã¡n
                alert("ÄÃ£ lÆ°u Ä‘Ã¡p Ã¡n má»›i thÃ nh cÃ´ng!");
                closeTeacherModal();
            } catch (e) {
                alert("Lá»—i cÃº phÃ¡p JSON! Vui lÃ²ng kiá»ƒm tra láº¡i cáº¥u trÃºc dáº¥u pháº©y, ngoáº·c kÃ©p.");
            }
        }

        function regradeExam() {
            if(!isSubmitted) { alert("Há»c sinh chÆ°a ná»™p bÃ i, khÃ´ng thá»ƒ cháº¥m láº¡i!"); return; }
            if(confirm("Há»‡ thá»‘ng sáº½ cháº¥m láº¡i toÃ n bá»™ bÃ i lÃ m cá»§a há»c sinh dá»±a trÃªn ÄÃ¡p Ã¡n má»›i nháº¥t cá»§a CÃ´. CÃ´ cÃ³ cháº¯c cháº¯n?")) {
                closeTeacherModal();
                gradeExamLogic();
                alert("ÄÃ£ cháº¥m phÃºc kháº£o xong!");
            }
        }

        document.getElementById('printBtn').addEventListener('click', () => { window.print(); });
    </script>
</body>
</html>
