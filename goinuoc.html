<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mua caffe - HSK1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Coffee Palette */
            --coffee-dark: #3e2723;   /* Espresso */
            --coffee-med: #6d4c41;    /* Mocha */
            --coffee-light: #a1887f;  /* Latte */
            --coffee-cream: #efebe9;  /* Foam */
            --bg-body: #fdfbf7;
            --accent: #2e7d32;        /* Green Tea / Eco friendly */
            --accent-hover: #1b5e20;
            --text-main: #4e342e;
            --text-light: #8d6e63;
            --white: #ffffff;
            --shadow: 0 8px 24px rgba(62, 39, 35, 0.12);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Quicksand', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            background-image: radial-gradient(var(--coffee-cream) 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 25px;
            align-items: start;
        }

        /* --- Header --- */
        header {
            grid-column: 1 / -1;
            background: var(--white);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 5px solid var(--coffee-med);
        }

        .header-content h1 {
            font-size: 1.8rem;
            color: var(--coffee-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* --- Pinyin Toggle --- */
        .toggle-btn {
            background: var(--coffee-cream);
            color: var(--coffee-dark);
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }

        .toggle-btn:hover { background: #e0dbd9; }
        .toggle-btn.active { 
            background: var(--coffee-med); 
            color: var(--white); 
            border-color: var(--coffee-dark);
        }

        /* --- Ruby Text Logic --- */
        ruby {
            ruby-position: over;
            display: inline-flex;
            flex-direction: column-reverse;
            vertical-align: bottom;
            align-items: center;
            margin: 0 1px;
        }

        rt {
            font-size: 0.6em;
            color: var(--coffee-med);
            font-weight: normal;
            opacity: 0;
            transform: translateY(5px);
            transition: 0.3s ease;
            user-select: none;
            line-height: 1;
        }

        body.show-pinyin rt {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Progress Bar --- */
        .step-bar {
            grid-column: 1 / -1;
            background: var(--white);
            padding: 20px 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .step-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
            transform: translateY(-50%);
        }

        .step-item {
            position: relative;
            z-index: 1;
            width: 35px;
            height: 35px;
            background: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #ccc;
            transition: 0.3s;
        }

        .step-item.active {
            border-color: var(--coffee-med);
            color: var(--coffee-med);
            transform: scale(1.2);
            box-shadow: 0 0 0 4px var(--coffee-cream);
        }

        .step-item.completed {
            background: var(--coffee-med);
            border-color: var(--coffee-med);
            color: var(--white);
        }

        .step-label {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            white-space: nowrap;
            color: var(--text-light);
            font-weight: 600;
        }

        /* --- Main Interface --- */
        .main-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 550px;
            display: flex;
            flex-direction: column;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .msg {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            opacity: 0;
            animation: slideIn 0.4s forwards;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.server { align-self: flex-start; }
        .msg.customer { align-self: flex-end; flex-direction: row-reverse; }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--white);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .avatar.server { background: var(--coffee-med); }
        .avatar.customer { background: var(--accent); }

        .bubble {
            padding: 14px 20px;
            border-radius: 20px;
            font-size: 1.15rem;
            max-width: 85%;
            position: relative;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .msg.server .bubble {
            background: var(--coffee-cream);
            color: var(--coffee-dark);
            border-bottom-left-radius: 4px;
        }

        .msg.customer .bubble {
            background: #e8f5e9;
            color: #1b5e20;
            border-bottom-right-radius: 4px;
        }

        /* Options Area */
        .interaction-zone {
            border-top: 1px solid #f0f0f0;
            padding-top: 25px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
        }

        .option-card {
            background: var(--white);
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
        }

        .option-card:hover {
            border-color: var(--coffee-light);
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }

        .option-card.selected {
            border-color: var(--coffee-med);
            background: var(--coffee-cream);
        }

        .opt-icon { font-size: 2.2rem; margin-bottom: 8px; }
        .opt-name { font-weight: 700; color: var(--coffee-dark); font-size: 1.1rem; }

        /* --- Bill Receipt Style --- */
        .bill-wrapper {
            background: #fff;
            padding: 25px;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 380px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            position: relative;
            font-family: 'Courier New', monospace;
        }

        .bill-wrapper::before {
            content: '';
            position: absolute;
            top: -5px; left: 0; right: 0; height: 5px;
            background: radial-gradient(circle, #fff 4px, transparent 5px) repeat-x;
            background-size: 10px 10px;
        }

        .bill-title { text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px; color: var(--coffee-dark); font-weight: bold; font-size: 1.2rem; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; color: #555; }
        .bill-val { font-weight: bold; color: var(--coffee-dark); }
        .bill-total { border-top: 2px dashed #ccc; margin-top: 15px; padding-top: 15px; text-align: center; font-style: italic; color: var(--accent); }

        /* --- Sidebar (Vocab) --- */
        .sidebar {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 20px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--coffee-med);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--coffee-cream);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vocab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .vocab-item:hover { background: var(--coffee-cream); }
        
        .v-icon { font-size: 1.4rem; width: 30px; text-align: center; }
        .v-text { flex: 1; }
        .v-word { font-weight: 700; color: var(--text-main); font-size: 1.1rem; }
        .v-mean { font-size: 0.85rem; color: var(--text-light); }

        /* --- Footer Controls --- */
        .controls {
            margin-top: auto;
            padding-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 12px 28px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-reset { background: #f5f5f5; color: #777; }
        .btn-reset:hover { background: #e0e0e0; color: #333; }
        
        .btn-next { background: var(--coffee-med); color: white; }
        .btn-next:hover { background: var(--coffee-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(109, 76, 65, 0.3); }
        .btn-next:disabled { background: #d7ccc8; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-confirm { background: var(--accent); color: white; }
        .btn-confirm:hover { background: var(--accent-hover); }

        /* --- Completion Screen --- */
        .complete-screen {
            text-align: center;
            padding: 40px 20px;
        }
        .complete-screen i { font-size: 5rem; color: var(--accent); margin-bottom: 20px; display: block;}
        .complete-screen h2 { color: var(--coffee-dark); margin-bottom: 10px; }
        .complete-screen p { color: var(--text-light); margin-bottom: 30px; }

        /* Responsive */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* ·∫®n sidebar tr√™n mobile cho g·ªçn */
            header { flex-direction: column; gap: 15px; text-align: center; }
            .options-grid { grid-template-columns: repeat(2, 1fr); }
            .step-label { display: none; } /* ·∫®n nh√£n b∆∞·ªõc tr√™n mobile */
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <h1><i class="fas fa-mug-hot"></i> Coffee Shop ÂíñÂï°Â∫ó</h1>
                <div class="subtitle">HSK1 Interaction Practice (Luy·ªán t·∫≠p g·ªçi ƒë·ªì u·ªëng)</div>
            </div>
            <div class="toggle-btn" id="pinyinToggle">
                <i class="fas fa-font"></i> 
                <span id="toggleText">Hi·ªán Pinyin</span>
            </div>
        </header>

        <!-- Step Progress -->
        <div class="step-bar" id="stepBar">
            <!-- JS generates steps -->
        </div>

        <!-- Main Card -->
        <div class="main-card">
            
            <!-- Dialogue Area -->
            <div class="chat-area" id="chatArea">
                <!-- Messages go here -->
            </div>

            <!-- Interaction Zone -->
            <div class="interaction-zone" id="interactionZone">
                <div class="options-grid" id="optionsGrid">
                    <!-- Options go here -->
                </div>
            </div>

            <!-- Bill/Confirmation Zone (Hidden by default) -->
            <div id="billZone" style="display: none;">
                <div class="bill-wrapper">
                    <div class="bill-title">ORDER RECEIPT</div>
                    <div id="billDetails"></div>
                    <div class="bill-total">
                        Total: 25.00 ÂÖÉ
                    </div>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-confirm" id="confirmOrderBtn" style="width: 100%; justify-content: center;">
                        <i class="fas fa-check"></i> Ê≤°ÈîôÔºåÊòØÂØπÁöÑ (ƒê√∫ng r·ªìi)
                    </button>
                    <button class="btn btn-reset" id="rejectOrderBtn" style="width: 100%; justify-content: center; margin-top: 10px; background: transparent; border: 1px solid #ddd;">
                        <i class="fas fa-redo"></i> ‰∏çÂØπÔºåÈáçÊñ∞ÈÄâ (Ch·ªçn l·∫°i)
                    </button>
                </div>
            </div>

            <!-- Completion Zone (Hidden by default) -->
            <div id="completeZone" class="complete-screen" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h2>ÁÇπÂçïÊàêÂäüÔºÅ(Th√†nh c√¥ng)</h2>
                <p>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ ·ªßng h·ªô qu√°n.</p>
                <div id="finalSentence" style="background:#f0f4c3; padding: 15px; border-radius: 8px; font-weight: bold; color: #33691e; margin-bottom: 20px;"></div>
                <button class="btn btn-next" onclick="initGame()" style="margin: 0 auto;">
                    <i class="fas fa-redo"></i> Luy·ªán t·∫≠p l·∫°i
                </button>
            </div>

            <!-- Controls -->
            <div class="controls" id="footerControls">
                <button class="btn btn-reset" id="resetBtn">
                    <i class="fas fa-undo"></i> L√†m l·∫°i
                </button>
                <button class="btn btn-next" id="nextBtn" disabled>
                    Ti·∫øp theo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Vocabulary Sidebar -->
        <div class="sidebar">
            <h3><i class="fas fa-book"></i> T·ª´ v·ª±ng (HSK1)</h3>
            <div id="vocabList">
                <!-- Vocab generated by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const gameState = {
            step: 1,
            totalSteps: 6, // 6 steps selection + 1 confirmation step logic
            selections: {
                drink: null,
                size: null,
                sweetness: null,
                temp: null,
                serving: null,
                straw: null
            }
        };

        const stepsInfo = ["È•ÆÊñô", "ÊùØÂûã", "ÁîúÂ∫¶", "Ê∏©Â∫¶", "ÊñπÂºè", "Âê∏ÁÆ°"];

        // Pinyin Dictionary for fallback
        const pinyinMap = {
            "Êàë": "w«í", "ÊÉ≥": "xi«éng", "Âñù": "hƒì", "‰ªÄ": "sh√©n", "‰πà": "me",
            "ËØ∑": "q«êng", "ÈóÆ": "w√®n", "Ë¶Å": "y√†o", "‰∏ç": "b√π", "Ë∞¢": "xi√®",
            "ÂØπ": "du√¨", "Èîô": "cu√≤", "ÊòØ": "sh√¨", "ÁöÑ": "de", "Âñú": "x«ê", "Ê¨¢": "huƒÅn"
        };

        const vocabulary = [
            { ch: "Âñù", py: "hƒì", vn: "u·ªëng", icon: "ü•§" },
            { ch: "‰ªÄ‰πà", py: "sh√©n me", vn: "c√°i g√¨", icon: "‚ùì" },
            { ch: "ÂíñÂï°", py: "kƒÅ fƒìi", vn: "c√† ph√™", icon: "‚òï" },
            { ch: "Ëå∂", py: "ch√°", vn: "tr√†", icon: "üçµ" },
            { ch: "ÁâõÂ•∂", py: "ni√∫ n«éi", vn: "s·ªØa", icon: "ü•õ" },
            { ch: "ÂèØ‰πê", py: "kƒõ l√®", vn: "coca", icon: "ü•§" },
            { ch: "Â§ß", py: "d√†", vn: "l·ªõn", icon: "üü¢" },
            { ch: "‰∏≠", py: "zh≈çng", vn: "v·ª´a", icon: "üü°" },
            { ch: "Â∞è", py: "xi«éo", vn: "nh·ªè", icon: "üî¥" },
            { ch: "ÂÜ∞", py: "bƒ´ng", vn: "ƒë√°/l·∫°nh", icon: "üßä" },
            { ch: "ÁÉ≠", py: "r√®", vn: "n√≥ng", icon: "üî•" },
            { ch: "Á≥ñ", py: "t√°ng", vn: "ƒë∆∞·ªùng", icon: "üç¨" },
            { ch: "Âê∏ÁÆ°", py: "xƒ´ gu«én", vn: "·ªëng h√∫t", icon: "ü•¢" },
            { ch: "ÊâìÂåÖ", py: "d«é bƒÅo", vn: "mang v·ªÅ", icon: "üõçÔ∏è" }
        ];

        const optionsDB = {
            drink: [
                { id: "coffee", name: "ÂíñÂï°", py: "kƒÅ fƒìi", icon: "‚òï" },
                { id: "tea", name: "Ëå∂", py: "ch√°", icon: "üçµ" },
                { id: "milktea", name: "Â•∂Ëå∂", py: "n«éi ch√°", icon: "üßã" },
                { id: "milk", name: "ÁâõÂ•∂", py: "ni√∫ n«éi", icon: "ü•õ" },
                { id: "cola", name: "ÂèØ‰πê", py: "kƒõ l√®", icon: "ü•§" }
            ],
            size: [
                { id: "L", name: "Â§ßÊùØ", py: "d√† bƒìi", icon: "ü•§+" },
                { id: "M", name: "‰∏≠ÊùØ", py: "zh≈çng bƒìi", icon: "ü•§" },
                { id: "S", name: "Â∞èÊùØ", py: "xi«éo bƒìi", icon: "ü•§-" }
            ],
            sweetness: [
                { id: "normal", name: "Ê≠£Â∏∏Á≥ñ", py: "zh√®ng ch√°ng t√°ng", icon: "üç¨" },
                { id: "less", name: "Â∞ëÁ≥ñ", py: "sh«éo t√°ng", icon: "üìâ" },
                { id: "none", name: "Êó†Á≥ñ", py: "w√∫ t√°ng", icon: "üö´" }
            ],
            temp: [
                { id: "ice", name: "Ê≠£Â∏∏ÂÜ∞", py: "zh√®ng ch√°ng bƒ´ng", icon: "üßä" },
                { id: "less_ice", name: "Â∞ëÂÜ∞", py: "sh«éo bƒ´ng", icon: "üíß" },
                { id: "hot", name: "ÁÉ≠", py: "r√®", icon: "üî•" },
                { id: "room", name: "Â∏∏Ê∏©", py: "ch√°ng wƒìn", icon: "üå°Ô∏è" }
            ],
            serving: [
                { id: "here", name: "Âú®ËøôÂÑøÂñù", py: "z√†i zh√®'er hƒì", icon: "üè™" },
                { id: "togo", name: "ÊâìÂåÖÂ∏¶Ëµ∞", py: "d«é bƒÅo d√†i z«íu", icon: "üõçÔ∏è" }
            ],
            straw: [
                { id: "yes", name: "Ë¶Å", py: "y√†o", icon: "‚úÖ" },
                { id: "no", name: "‰∏çË¶Å", py: "b√∫ y√†o", icon: "‚ùå" }
            ]
        };

        const serverScript = {
            1: { text: "Ê¨¢ËøéÂÖâ‰∏¥ÔºÅÊÇ®Ë¶ÅÁÇπ‰ªÄ‰πàÔºü", py: "HuƒÅny√≠ng guƒÅngl√≠n! n√≠n y√†o di«én sh√©n me?" },
            2: { text: "ÊÇ®Ë¶ÅÂ§ßÁöÑËøòÊòØÂ∞èÁöÑÔºü", py: "n√≠n y√†o d√† de h√°i sh√¨ xi«éo de?" },
            3: { text: "ÁîúÂ∫¶ÊÄé‰πàÊ†∑Ôºü", py: "ti√°nd√π zƒõn me y√†ng?" },
            4: { text: "Ë¶Å‰ªÄ‰πàÊ∏©Â∫¶Ôºü", py: "y√†o sh√©nme wƒìnd√π?" },
            5: { text: "Ë¶ÅÊâìÂåÖÂ∏¶Ëµ∞ËøòÊòØÂú®ËøôÂÑøÂñùÔºü", py: "y√†o d«ébƒÅo d√†iz«íu h√°ish√¨ z√†i zh√®'er hƒì?" },
            6: { text: "ÈúÄË¶ÅÂê∏ÁÆ°ÂêóÔºü", py: "X≈´y√†o xƒ´gu«én ma?" }
        };

        // --- CORE FUNCTIONS ---

        // Ruby Text Generator
        function getRuby(text, pinyinStr = "") {
            // Simple mapping strategy. 
            // If pinyinStr is provided (from optionsDB), split by space and map to chars if lengths match.
            // Otherwise lookup char by char.
            
            let html = "";
            const isChinese = (char) => /[\u4e00-\u9fff]/.test(char);

            // Special handling for Option Cards where we have explicit Pinyin phrases
            if (pinyinStr) {
                const pyArr = pinyinStr.split(' ');
                // Simple heuristic: if exact phrase match logic is complex, 
                // we will just treat the whole block or char by char if possible.
                // For this demo, let's map char-by-char using the provided string for guidance, 
                // but fallback to dict if lengths don't match nicely (which they often don't in simple splitting).
                
                // Let's use a simpler approach: Char by Char lookup for robust display
                for (let char of text) {
                    if(isChinese(char)) {
                        // Try to find pinyin in the provided string? No, simpler to use global dict + embedded data
                        // Since `optionsDB` provides specific pinyin, let's just use that for the WHOLE word if it's short,
                        // or char by char.
                        // BETTER: Let's use the char lookup mostly, but for specific vocab allow override.
                        // Implementing simple char lookup for reliability:
                        let py = pinyinMap[char];
                        // Try to find in vocabulary list
                        const voc = vocabulary.find(v => v.ch === char);
                        if(voc) py = voc.py;
                        
                        // If not found, use a placeholder or empty
                        if(!py) {
                             // Attempt to map from the phrase pinyin if provided
                             // This is hard to do dynamically without a full library.
                             // So we will rely on a slightly expanded dictionary for this demo.
                             py = getPinyinForChar(char, pinyinStr);
                        }
                        html += `<ruby>${char}<rt>${py}</rt></ruby>`;
                    } else {
                        html += char;
                    }
                }
            } else {
                // Fallback char by char
                for (let char of text) {
                    if(isChinese(char)) {
                        html += `<ruby>${char}<rt>${getPinyinForChar(char)}</rt></ruby>`;
                    } else {
                        html += char;
                    }
                }
            }
            return html;
        }

        function getPinyinForChar(char, contextPy = "") {
            // A mini dictionary for this specific game context to ensure accuracy
            const dict = {
                "Ê¨¢": "huƒÅn", "Ëøé": "y√≠ng", "ÂÖâ": "guƒÅng", "‰∏¥": "l√≠n", "‰Ω†": "n«ê",
                "ÊÉ≥": "xi«éng", "Âñù": "hƒì", "‰ªÄ": "sh√©n", "‰πà": "me", "Âíñ": "kƒÅ", "Âï°": "fƒìi",
                "Ëå∂": "ch√°", "Â•∂": "n«éi", "Áâõ": "ni√∫", "ÂèØ": "kƒõ", "‰πê": "l√®",
                "ËØ∑": "q«êng", "ÈóÆ": "w√®n", "Ë¶Å": "y√†o", "ÊùØ": "bƒìi", "Âûã": "x√≠ng",
                "Â§ß": "d√†", "‰∏≠": "zh≈çng", "Â∞è": "xi«éo", "Áîú": "ti√°n", "Â∫¶": "d√π",
                "Ê≠£": "zh√®ng", "Â∏∏": "ch√°ng", "Â∞ë": "sh«éo", "Êó†": "w√∫", "Á≥ñ": "t√°ng",
                "Ê∏©": "wƒìn", "ÁÉ≠": "r√®", "ÂÜ∞": "bƒ´ng", "ÊòØ": "sh√¨", "Êâì": "d«é", "ÂåÖ": "bƒÅo",
                "Â∏¶": "d√†i", "Ëµ∞": "z«íu", "Ëøò": "h√°i", "Âú®": "z√†i", "Ëøô": "zh√®", "ÂÑø": "er",
                "ÈúÄ": "x≈´", "Âê∏": "xƒ´", "ÁÆ°": "gu«én", "Âêó": "ma", "Ë∞¢": "xi√®", "ÂÆ¢": "k√®", "Ê∞î": "qi",
                "ÁÇπ": "di«én", "Âçï": "dƒÅn", "Ê≤°": "m√©i", "Èîô": "cu√≤"
            };
            return dict[char] || "";
        }

        // --- RENDER LOGIC ---

        function initGame() {
            gameState.step = 1;
            gameState.selections = { drink: null, size: null, sweetness: null, temp: null, serving: null, straw: null };
            
            document.getElementById('completeZone').style.display = 'none';
            document.getElementById('billZone').style.display = 'none';
            document.getElementById('interactionZone').style.display = 'block';
            document.getElementById('footerControls').style.display = 'flex';
            document.getElementById('chatArea').innerHTML = ''; // Clear chat

            renderSteps();
            renderVocab();
            renderStep();
        }

        function renderSteps() {
            const bar = document.getElementById('stepBar');
            bar.innerHTML = stepsInfo.map((label, index) => {
                const stepNum = index + 1;
                let cls = 'step-item';
                if(stepNum < gameState.step) cls += ' completed';
                if(stepNum === gameState.step) cls += ' active';
                return `
                    <div class="${cls}">
                        ${stepNum < gameState.step ? '<i class="fas fa-check"></i>' : stepNum}
                        <div class="step-label">${label}</div>
                    </div>
                `;
            }).join('');
        }

        function renderVocab() {
            const list = document.getElementById('vocabList');
            list.innerHTML = vocabulary.map(v => `
                <div class="vocab-item">
                    <div class="v-icon">${v.icon}</div>
                    <div class="v-text">
                        <div class="v-word">${getRuby(v.ch, v.py)}</div>
                        <div class="v-mean">${v.vn}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderStep() {
            const step = gameState.step;
            
            // 1. Render Server Bubble
            const serverData = serverScript[step];
            addMessage('server', serverData.text, serverData.py);

            // 2. Render Options
            const categoryKey = getCategoryKey(step);
            const options = optionsDB[categoryKey];
            const grid = document.getElementById('optionsGrid');
            
            grid.innerHTML = options.map(opt => `
                <div class="option-card ${gameState.selections[categoryKey] === opt.id ? 'selected' : ''}" 
                     onclick="selectOption('${categoryKey}', '${opt.id}')">
                    <div class="opt-icon">${opt.icon}</div>
                    <div class="opt-name">${getRuby(opt.name, opt.py)}</div>
                </div>
            `).join('');

            updateNextBtn();
        }

        function getCategoryKey(step) {
            const keys = ['drink', 'size', 'sweetness', 'temp', 'serving', 'straw'];
            return keys[step - 1];
        }

        function addMessage(role, text, pinyin = "") {
            const chat = document.getElementById('chatArea');
            const icon = role === 'server' ? '<i class="fas fa-user-tie"></i>' : '<i class="fas fa-user"></i>';
            
            // Check if last message was same role to avoid duplicates if re-rendering? 
            // Better simplicity: just append. 
            
            const html = `
                <div class="msg ${role}">
                    <div class="avatar ${role}">${icon}</div>
                    <div class="bubble">
                        ${getRuby(text, pinyin)}
                    </div>
                </div>
            `;
            chat.insertAdjacentHTML('beforeend', html);
            chat.scrollTop = chat.scrollHeight;
        }

        function selectOption(key, id) {
            gameState.selections[key] = id;
            
            // Visual update
            renderStepOptionsOnly(); // Re-render grid to show selection
            
            // Add customer Bubble
            const opt = optionsDB[key].find(o => o.id === id);
            
            // Remove previous customer bubble for this step if exists (simple way: clear last child if it is customer)
            // For simplicity in this demo, we just append. It might look like user changed mind.
            
            let reply = opt.name;
            if(key === 'drink') reply = `ÊàëÊÉ≥Âñù${opt.name}„ÄÇ`;
            if(key === 'straw') reply = `${opt.name}„ÄÇ`;
            
            // Slight delay for natural feel
            // Remove existing customer bubbles from this step (optional refinement)
            // Let's just append for flow history.
            
            // Actually, to prevent spamming bubbles on changing option, let's remove the last bubble if it was from customer
            const lastMsg = document.getElementById('chatArea').lastElementChild;
            if(lastMsg && lastMsg.classList.contains('customer')) {
                lastMsg.remove();
            }

            addMessage('customer', reply, opt.py);
            updateNextBtn();
        }

        function renderStepOptionsOnly() {
            const key = getCategoryKey(gameState.step);
            const options = optionsDB[key];
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = options.map(opt => `
                <div class="option-card ${gameState.selections[key] === opt.id ? 'selected' : ''}" 
                     onclick="selectOption('${key}', '${opt.id}')">
                    <div class="opt-icon">${opt.icon}</div>
                    <div class="opt-name">${getRuby(opt.name, opt.py)}</div>
                </div>
            `).join('');
        }

        function updateNextBtn() {
            const key = getCategoryKey(gameState.step);
            const btn = document.getElementById('nextBtn');
            btn.disabled = !gameState.selections[key];
        }

        // --- NAVIGATION ---

        document.getElementById('nextBtn').addEventListener('click', () => {
            if(gameState.step < 6) {
                gameState.step++;
                renderSteps();
                renderStep();
            } else {
                // Finish -> Show Bill Logic
                showBill();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', initGame);
        document.getElementById('rejectOrderBtn').addEventListener('click', initGame);

        document.getElementById('confirmOrderBtn').addEventListener('click', () => {
             document.getElementById('billZone').style.display = 'none';
             document.getElementById('completeZone').style.display = 'block';
             
             // Generate full sentence
             const s = gameState.selections;
             const getName = (cat, id) => optionsDB[cat].find(x => x.id === id).name;
             const fullSentence = `ÊàëË¶Å‰∏ÄÊùØ${getName('drink', s.drink)}Ôºå${getName('size', s.size)}Ôºå${getName('sweetness', s.sweetness)}Ôºå${getName('temp', s.temp)}Ôºå${getName('serving', s.serving)}Ôºå${getName('straw', s.straw)}Âê∏ÁÆ°„ÄÇ`;
             
             document.getElementById('finalSentence').innerHTML = getRuby(fullSentence);
        });

        function showBill() {
            document.getElementById('interactionZone').style.display = 'none';
            document.getElementById('footerControls').style.display = 'none';
            
            // Server summarizes
            const s = gameState.selections;
            const getName = (cat, id) => optionsDB[cat].find(x => x.id === id).name;
            const summaryText = `ËØ∑Á°ÆËÆ§ÊÇ®ÁöÑËÆ¢ÂçïÔºö${getName('drink', s.drink)}Ôºå${getName('size', s.size)}Ôºå${getName('sweetness', s.sweetness)}Ôºå${getName('temp', s.temp)}Ôºå${getName('serving', s.serving)}„ÄÇÂØπÂêóÔºü`;
            
            addMessage('server', summaryText);
            
            // Render Receipt
            const billZone = document.getElementById('billZone');
            const details = document.getElementById('billDetails');
            
            const row = (label, val) => `<div class="bill-row"><span>${label}</span><span class="bill-val">${getRuby(val)}</span></div>`;
            
            details.innerHTML = `
                ${row("Drinks:", getName('drink', s.drink))}
                ${row("Size:", getName('size', s.size))}
                ${row("Sugar:", getName('sweetness', s.sweetness))}
                ${row("Temp:", getName('temp', s.temp))}
                ${row("Type:", getName('serving', s.serving))}
                ${row("Straw:", getName('straw', s.straw))}
            `;
            
            billZone.style.display = 'block';
        }

        // --- TOGGLE PINYIN ---
        const pinyinToggle = document.getElementById('pinyinToggle');
        pinyinToggle.addEventListener('click', () => {
            document.body.classList.toggle('show-pinyin');
            pinyinToggle.classList.toggle('active');
            const isActive = pinyinToggle.classList.contains('active');
            document.getElementById('toggleText').textContent = isActive ? "·∫®n Pinyin" : "Hi·ªán Pinyin";
        });

        // Start
        initGame();

    </script>
</body>
</html>
