<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Shop Ordering Game - HSK1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --coffee-dark: #3e2723;
            --coffee-med: #6d4c41;
            --coffee-light: #a1887f;
            --coffee-cream: #efebe9;
            --bg-body: #fdfbf7;
            --accent: #2e7d32;
            --accent-hover: #1b5e20;
            --text-main: #4e342e;
            --text-light: #8d6e63;
            --white: #ffffff;
            --shadow: 0 8px 24px rgba(62, 39, 35, 0.12);
            --radius: 16px;
            --header-height: 80px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Quicksand', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            padding: 20px;
            padding-top: calc(var(--header-height) + 20px);
            min-height: 100vh;
            background-image: radial-gradient(var(--coffee-cream) 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 25px;
            align-items: start;
        }

        /* --- Header (Fixed) --- */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--white);
            padding: 0 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--coffee-med);
            z-index: 1001;
        }

        .header-content h1 {
            font-size: 1.6rem;
            color: var(--coffee-dark);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            background: var(--coffee-cream);
            color: var(--coffee-dark);
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .toggle-btn:hover { background: #e0dbd9; }
        .toggle-btn.active { 
            background: var(--coffee-med); 
            color: var(--white); 
            border-color: var(--coffee-dark);
        }

        #vocabMobileBtn {
            display: none;
            background: var(--accent);
            color: white;
        }

        /* --- Ruby Text --- */
        ruby {
            ruby-position: over;
            display: inline-flex;
            flex-direction: column-reverse;
            vertical-align: bottom;
            align-items: center;
            margin: 0 1px;
        }

        rt {
            font-size: 0.6em;
            color: var(--coffee-med);
            font-weight: normal;
            opacity: 0;
            transform: translateY(5px);
            transition: 0.3s ease;
            user-select: none;
            line-height: 1;
        }

        body.show-pinyin rt { opacity: 1; transform: translateY(0); }

        /* --- Progress Bar (Sticky) --- */
        .step-bar {
            grid-column: 1 / -1;
            background: var(--white);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            position: sticky;
            top: var(--header-height); /* D√≠nh ngay d∆∞·ªõi header */
            z-index: 1000;
            overflow-x: auto;
            margin-bottom: 25px;
            border: 1px solid #f0f0f0;
        }

        .step-bar::after {
            content: '';
            position: absolute;
            top: 50%; left: 50px; right: 50px; height: 2px;
            background: #e0e0e0; z-index: 0; transform: translateY(-50%);
        }

        .step-item {
            position: relative; z-index: 1; min-width: 35px; height: 35px;
            background: var(--white); border: 2px solid #e0e0e0; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #ccc; transition: 0.3s; margin: 0 5px;
        }

        .step-item.active {
            border-color: var(--coffee-med); color: var(--coffee-med);
            transform: scale(1.1); box-shadow: 0 0 0 4px var(--coffee-cream);
        }

        .step-item.completed {
            background: var(--coffee-med); border-color: var(--coffee-med); color: var(--white);
        }

        .step-label {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            font-size: 0.75rem; white-space: nowrap; color: var(--text-light); font-weight: 600;
        }

        /* --- Main Interface --- */
        .main-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 550px;
            display: flex;
            flex-direction: column;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            justify-content: center; 
        }

        .msg {
            display: flex; align-items: flex-end; gap: 12px;
            opacity: 0; animation: slideIn 0.4s forwards;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.server { align-self: flex-start; }
        .msg.customer { align-self: flex-end; flex-direction: row-reverse; }

        .avatar {
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: var(--white);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0;
        }

        .avatar.server { background: var(--coffee-med); }
        .avatar.customer { background: var(--accent); }

        .bubble {
            padding: 14px 20px; border-radius: 20px; font-size: 1.15rem;
            max-width: 100%; position: relative; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .msg.server .bubble { background: var(--coffee-cream); color: var(--coffee-dark); border-bottom-left-radius: 4px; }
        .msg.customer .bubble { background: #e8f5e9; color: #1b5e20; border-bottom-right-radius: 4px; }

        .interaction-zone { border-top: 1px solid #f0f0f0; padding-top: 25px; }

        .options-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;
        }

        .option-card {
            background: var(--white); border: 2px solid #eee; border-radius: 12px;
            padding: 15px 5px; text-align: center; cursor: pointer;
            transition: all 0.2s ease; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 120px;
        }

        .option-card:hover { border-color: var(--coffee-light); transform: translateY(-4px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        .option-card.selected { border-color: var(--coffee-med); background: var(--coffee-cream); }
        .opt-icon { font-size: 2.2rem; margin-bottom: 8px; }
        .opt-name { font-weight: 700; color: var(--coffee-dark); font-size: 1.1rem; }

        .bill-wrapper {
            background: #fff; padding: 25px; border: 1px solid #ddd;
            width: 100%; max-width: 380px; margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative;
            font-family: 'Courier New', monospace;
        }
        .bill-wrapper::before {
            content: ''; position: absolute; top: -5px; left: 0; right: 0; height: 5px;
            background: radial-gradient(circle, #fff 4px, transparent 5px) repeat-x; background-size: 10px 10px;
        }
        .bill-title { text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px; color: var(--coffee-dark); font-weight: bold; font-size: 1.2rem; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; color: #555; }
        .bill-val { font-weight: bold; color: var(--coffee-dark); }
        .bill-total { border-top: 2px dashed #ccc; margin-top: 15px; padding-top: 15px; text-align: center; font-style: italic; color: var(--accent); }

        .sidebar {
            background: var(--white); border-radius: var(--radius);
            padding: 25px; box-shadow: var(--shadow);
            position: sticky; top: calc(var(--header-height) + 20px);
            max-height: calc(100vh - 120px); overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--coffee-med); margin-bottom: 20px; padding-bottom: 10px;
            border-bottom: 2px solid var(--coffee-cream); font-size: 1.2rem;
            display: flex; align-items: center; gap: 10px;
        }

        .vocab-item {
            display: flex; align-items: center; gap: 12px; padding: 10px;
            margin-bottom: 8px; border-radius: 8px; transition: 0.2s;
            border: 1px solid transparent;
        }
        .vocab-item:hover { background: var(--coffee-cream); border-color: #e0e0e0; }
        .v-icon { font-size: 1.4rem; width: 30px; text-align: center; }
        .v-text { flex: 1; }
        .v-word { font-weight: 700; color: var(--text-main); font-size: 1.1rem; line-height: 1.3; }
        .v-mean { font-size: 0.85rem; color: var(--text-light); }

        .modal-overlay {
            display: none; 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        
        .modal-content {
            background: var(--white);
            width: 90%; max-width: 400px;
            max-height: 80vh;
            border-radius: var(--radius);
            display: flex; flex-direction: column;
        }

        .modal-header {
            padding: 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { color: var(--coffee-dark); margin: 0; font-size: 1.3rem; }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: #999; padding: 0 5px; }
        
        .modal-body { padding: 15px; overflow-y: auto; }

        .controls {
            margin-top: auto; padding-top: 20px;
            display: flex; justify-content: flex-end; gap: 15px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 12px 28px; border-radius: 50px; border: none;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }

        .btn-reset { background: #f5f5f5; color: #777; }
        .btn-reset:hover { background: #e0e0e0; color: #333; }
        .btn-next { background: var(--coffee-med); color: white; }
        .btn-next:hover { background: var(--coffee-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(109, 76, 65, 0.3); }
        .btn-next:disabled { background: #d7ccc8; cursor: not-allowed; }
        .btn-confirm { background: var(--accent); color: white; }

        .complete-screen { text-align: center; padding: 40px 20px; }
        .complete-screen i { font-size: 5rem; color: var(--accent); margin-bottom: 20px; display: block;}
        .complete-screen h2 { color: var(--coffee-dark); margin-bottom: 10px; }
        .complete-screen p { color: var(--text-light); margin-bottom: 30px; }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            #vocabMobileBtn { display: flex; }
            header { padding: 0 15px; }
            .header-content h1 { font-size: 1.2rem; }
            .options-grid { grid-template-columns: repeat(2, 1fr); }
            .step-bar { margin-bottom: 15px; }
            .main-card { padding: 20px; min-height: 450px; }
            .controls { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }

        @media (max-width: 480px) {
            .step-label { display: none; }
            .toggle-btn span { display: none; }
            .toggle-btn { padding: 8px; width: 40px; justify-content: center; }
            #vocabMobileBtn span { display: inline; }
            #vocabMobileBtn { width: auto; padding: 8px 16px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <h1><i class="fas fa-mug-hot"></i> Coffee Shop ÂíñÂï°Â∫ó</h1>
            <div class="subtitle">HSK1 Interaction Practice</div>
        </div>
        
        <div class="header-actions">
            <div class="toggle-btn" id="pinyinToggle">
                <i class="fas fa-font"></i> 
                <span id="toggleText">Hi·ªán Pinyin</span>
            </div>
            
            <div class="toggle-btn" id="vocabMobileBtn">
                <i class="fas fa-book-open"></i>
                <span>T·ª´ v·ª±ng</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Step Progress hi·ªán ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p position sticky -->
        <div class="step-bar" id="stepBar"></div>

        <div class="main-card">
            <div class="chat-area" id="chatArea"></div>

            <div class="interaction-zone" id="interactionZone">
                <div class="options-grid" id="optionsGrid"></div>
            </div>

            <div id="billZone" style="display: none;">
                <div class="bill-wrapper">
                    <div class="bill-title">ORDER RECEIPT</div>
                    <div id="billDetails"></div>
                    <div class="bill-total">Total: 25.00 ÂÖÉ</div>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-confirm" id="confirmOrderBtn" style="width: 100%; justify-content: center;">
                        <i class="fas fa-check"></i> Ê≤°ÈîôÔºåÊòØÂØπÁöÑ (ƒê√∫ng r·ªìi)
                    </button>
                    <button class="btn btn-reset" id="rejectOrderBtn" style="width: 100%; justify-content: center; margin-top: 10px; background: transparent; border: 1px solid #ddd;">
                        <i class="fas fa-redo"></i> ‰∏çÂØπÔºåÈáçÊñ∞ÈÄâ (Ch·ªçn l·∫°i)
                    </button>
                </div>
            </div>

            <div id="completeZone" class="complete-screen" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h2>ÁÇπÂçïÊàêÂäüÔºÅ(Th√†nh c√¥ng)</h2>
                <p>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ ·ªßng h·ªô qu√°n.</p>
                <div id="finalSentence" style="background:#f0f4c3; padding: 15px; border-radius: 8px; font-weight: bold; color: #33691e; margin-bottom: 20px;"></div>
                <button class="btn btn-next" onclick="initGame()" style="margin: 0 auto;">
                    <i class="fas fa-redo"></i> Luy·ªán t·∫≠p l·∫°i
                </button>
            </div>

            <div class="controls" id="footerControls">
                <button class="btn btn-reset" id="resetBtn">
                    <i class="fas fa-undo"></i> L√†m l·∫°i
                </button>
                <button class="btn btn-next" id="nextBtn" disabled>
                    Ti·∫øp theo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div class="sidebar">
            <h3><i class="fas fa-book"></i> ËØçÊ±áË°® (T·ª´ v·ª±ng HSK1)</h3>
            <div id="vocabList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="vocabModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> ËØçÊ±áË°® (T·ª´ v·ª±ng)</h3>
                <div class="modal-close" id="closeVocabModal">&times;</div>
            </div>
            <div class="modal-body">
                <div id="vocabModalContent"></div>
            </div>
        </div>
    </div>

    <script>
        const gameState = {
            step: 1,
            totalSteps: 6,
            selections: { drink: null, size: null, sweetness: null, temp: null, serving: null, straw: null }
        };

        const stepsInfo = ["È•ÆÊñô", "ÊùØÂûã", "ÁîúÂ∫¶", "Ê∏©Â∫¶", "ÊñπÂºè", "Âê∏ÁÆ°"];

        // T·ª´ ƒëi·ªÉn Pinyin ƒê·∫¶Y ƒê·ª¶ cho to√†n b·ªô ch·ªØ H√°n trong game
        const pinyinMap = {
            // ƒê·∫°i t·ª´ & T·ª´ c∆° b·∫£n
            "Êàë": "w«í", "‰Ω†": "n«ê", "ÊÇ®": "n√≠n", 
            "ÊÉ≥": "xi«éng", "Ë¶Å": "y√†o", "‰∏ç": "b√π", "ÈúÄ": "x≈´",
            "ÊòØ": "sh√¨", "ÁöÑ": "de", "Âñú": "x«ê", "Ê¨¢": "huƒÅn",
            "Ê≤°": "m√©i", "Èîô": "cu√≤", "ÂØπ": "du√¨",
            "Ë∞¢": "xi√®", "ÂÆ¢": "k√®", "Ê∞î": "qi",

            // ƒê·ªông t·ª´
            "Âñù": "hƒì", "ËØ∑": "q«êng", "ÈóÆ": "w√®n", 
            "Êâì": "d«é", "ÂåÖ": "bƒÅo", "Â∏¶": "d√†i", "Ëµ∞": "z«íu",
            "Âú®": "z√†i", "Ëøô": "zh√®", "ÂÑø": "er", "Ëøò": "h√°i",
            "ËÆ§": "r√®n", "ÂÆö": "d√¨ng", "Á°Æ": "qu√®", 
            "ÈÄâ": "xu«én", "Èáç": "ch√≥ng", "Êñ∞": "xƒ´n",

            // Danh t·ª´ & T√≠nh t·ª´ (ƒê·ªì u·ªëng)
            "Âíñ": "kƒÅ", "Âï°": "fƒìi",
            "Ëå∂": "ch√°", "Â•∂": "n«éi", "Áâõ": "ni√∫", 
            "ÂèØ": "kƒõ", "‰πê": "l√®",
            "È•Æ": "y«ên", "Êñô": "li√†o",

            // T√≠nh ch·∫•t (Nhi·ªát ƒë·ªô, ƒê∆∞·ªùng, K√≠ch c·ª°)
            "ÊùØ": "bƒìi", "Âûã": "x√≠ng", 
            "Â§ß": "d√†", "‰∏≠": "zh≈çng", "Â∞è": "xi«éo",
            "Áîú": "ti√°n", "Â∫¶": "d√π", "Á≥ñ": "t√°ng",
            "Ê∏©": "wƒìn", "ÂÜ∞": "bƒ´ng", "ÁÉ≠": "r√®", 
            "Ê≠£": "zh√®ng", "Â∏∏": "ch√°ng", "Â∞ë": "sh«éo", "Êó†": "w√∫",
            
            // C√¢u h·ªèi
            "‰ªÄ": "sh√©n", "‰πà": "me", "ÊÄé": "zƒõn", "Ê†∑": "y√†ng", "Âêó": "ma",

            // V·∫≠t d·ª•ng & Kh√°c
            "Âê∏": "xƒ´", "ÁÆ°": "gu«én", 
            "Ëøé": "y√≠ng", "ÂÖâ": "guƒÅng", "‰∏¥": "l√≠n",
            "ÁÇπ": "di«én", "Âçï": "dƒÅn", "Êàê": "ch√©ng", "Âäü": "g≈çng",
            "ËØç": "c√≠", "Ê±á": "hu√¨", "Ë°®": "bi«éo", "Â∫ó": "di√†n",
            "Êñπ": "fƒÅng", "Âºè": "sh√¨", "ÂÖÉ": "yu√°n"
        };

        const vocabulary = [
            { ch: "Ê¨¢ËøéÂÖâ‰∏¥", py: "HuƒÅny√≠ng guƒÅngl√≠n", vn: "Ch√†o m·ª´ng qu√Ω kh√°ch", icon: "üëã" },
            { ch: "ÊÉ≥", py: "xi«éng", vn: "Mu·ªën, nghƒ©", icon: "üí≠" },
            { ch: "Âñù", py: "hƒì", vn: "U·ªëng", icon: "ü•§" },
            { ch: "‰ªÄ‰πà", py: "sh√©nme", vn: "C√°i g√¨", icon: "‚ùì" },
            { ch: "ËØ∑ÈóÆ", py: "q«êngw√®n", vn: "Xin h·ªèi", icon: "üó£Ô∏è" },
            { ch: "ÂíñÂï°", py: "kƒÅfƒìi", vn: "C√† ph√™", icon: "‚òï" },
            { ch: "Ëå∂", py: "ch√°", vn: "Tr√†", icon: "üçµ" },
            { ch: "Â•∂Ëå∂", py: "n«éich√°", vn: "Tr√† s·ªØa", icon: "üßã" },
            { ch: "ÁâõÂ•∂", py: "ni√∫n«éi", vn: "S·ªØa", icon: "ü•õ" },
            { ch: "ÂèØ‰πê", py: "kƒõl√®", vn: "Coca", icon: "ü•§" },
            { ch: "ÊùØÂûã", py: "bƒìix√≠ng", vn: "Lo·∫°i c·ªëc", icon: "üìè" },
            { ch: "Â§ß", py: "d√†", vn: "L·ªõn", icon: "üü¢" },
            { ch: "‰∏≠", py: "zh≈çng", vn: "V·ª´a", icon: "üü°" },
            { ch: "Â∞è", py: "xi«éo", vn: "Nh·ªè", icon: "üî¥" },
            { ch: "ÁîúÂ∫¶", py: "ti√°nd√π", vn: "ƒê·ªô ng·ªçt", icon: "üç¨" },
            { ch: "Á≥ñ", py: "t√°ng", vn: "ƒê∆∞·ªùng", icon: "üßÇ" },
            { ch: "Ê∏©Â∫¶", py: "wƒìnd√π", vn: "Nhi·ªát ƒë·ªô", icon: "üå°Ô∏è" },
            { ch: "ÂÜ∞", py: "bƒ´ng", vn: "ƒê√°/L·∫°nh", icon: "üßä" },
            { ch: "ÁÉ≠", py: "r√®", vn: "N√≥ng", icon: "üî•" },
            { ch: "ÊâìÂåÖ", py: "d«ébƒÅo", vn: "Mang v·ªÅ (ƒë√≥ng g√≥i)", icon: "üõçÔ∏è" },
            { ch: "Â∏¶Ëµ∞", py: "d√†iz«íu", vn: "Mang ƒëi", icon: "üèÉ" },
            { ch: "Âú®ËøôÂÑø", py: "z√†i zh√®'er", vn: "·ªû ƒë√¢y", icon: "üìç" },
            { ch: "ÈúÄË¶Å", py: "x≈´y√†o", vn: "C·∫ßn", icon: "üôã" },
            { ch: "Âê∏ÁÆ°", py: "xƒ´gu«én", vn: "·ªêng h√∫t", icon: "ü•¢" },
            { ch: "Á°ÆËÆ§", py: "qu√®r√®n", vn: "X√°c nh·∫≠n", icon: "‚úÖ" },
            { ch: "Ê≤°Èîô", py: "m√©icu√≤", vn: "Kh√¥ng sai/ƒê√∫ng r·ªìi", icon: "üëå" },
            { ch: "Ë∞¢Ë∞¢", py: "xi√®xie", vn: "C·∫£m ∆°n", icon: "üôè" }
        ];

        const optionsDB = {
            drink: [
                { id: "coffee", name: "ÂíñÂï°", py: "kƒÅ fƒìi", icon: "‚òï" },
                { id: "tea", name: "Ëå∂", py: "ch√°", icon: "üçµ" },
                { id: "milktea", name: "Â•∂Ëå∂", py: "n«éi ch√°", icon: "üßã" },
                { id: "milk", name: "ÁâõÂ•∂", py: "ni√∫ n«éi", icon: "ü•õ" },
                { id: "cola", name: "ÂèØ‰πê", py: "kƒõ l√®", icon: "ü•§" }
            ],
            size: [
                { id: "L", name: "Â§ßÊùØ", py: "d√† bƒìi", icon: "ü•§+" },
                { id: "M", name: "‰∏≠ÊùØ", py: "zh≈çng bƒìi", icon: "ü•§" },
                { id: "S", name: "Â∞èÊùØ", py: "xi«éo bƒìi", icon: "ü•§-" }
            ],
            sweetness: [
                { id: "normal", name: "Ê≠£Â∏∏Á≥ñ", py: "zh√®ng ch√°ng t√°ng", icon: "üç¨" },
                { id: "less", name: "Â∞ëÁ≥ñ", py: "sh«éo t√°ng", icon: "üìâ" },
                { id: "none", name: "Êó†Á≥ñ", py: "w√∫ t√°ng", icon: "üö´" }
            ],
            temp: [
                { id: "ice", name: "Ê≠£Â∏∏ÂÜ∞", py: "zh√®ng ch√°ng bƒ´ng", icon: "üßä" },
                { id: "less_ice", name: "Â∞ëÂÜ∞", py: "sh«éo bƒ´ng", icon: "üíß" },
                { id: "hot", name: "ÁÉ≠", py: "r√®", icon: "üî•" },
                { id: "room", name: "Â∏∏Ê∏©", py: "ch√°ng wƒìn", icon: "üå°Ô∏è" }
            ],
            serving: [
                { id: "here", name: "Âú®ËøôÂÑøÂñù", py: "z√†i zh√®'er hƒì", icon: "üè™" },
                { id: "togo", name: "ÊâìÂåÖÂ∏¶Ëµ∞", py: "d«é bƒÅo d√†i z«íu", icon: "üõçÔ∏è" }
            ],
            straw: [
                { id: "yes", name: "Ë¶Å", py: "y√†o", icon: "‚úÖ" },
                { id: "no", name: "‰∏çË¶Å", py: "b√∫ y√†o", icon: "‚ùå" }
            ]
        };

        const serverScript = {
            1: { text: "Ê¨¢ËøéÂÖâ‰∏¥ÔºÅ‰Ω†ÊÉ≥Âñù‰ªÄ‰πàÔºü", py: "HuƒÅny√≠ng guƒÅngl√≠n! N«ê xi«éng hƒì sh√©nme?" },
            2: { text: "ËØ∑ÈóÆË¶Å‰ªÄ‰πàÊùØÂûãÔºü", py: "Q«êngw√®n y√†o sh√©nme bƒìix√≠ng?" },
            3: { text: "ËØ∑ÈóÆÁîúÂ∫¶ÊÄé‰πàÊ†∑Ôºü", py: "Q«êngw√®n ti√°nd√π zƒõn me y√†ng?" },
            4: { text: "ËØ∑ÈóÆË¶Å‰ªÄ‰πàÊ∏©Â∫¶Ôºü", py: "Q«êngw√®n y√†o sh√©nme wƒìnd√π?" },
            5: { text: "ËØ∑ÈóÆÊòØÊâìÂåÖÂ∏¶Ëµ∞ËøòÊòØÂú®ËøôÂÑøÂñùÔºü", py: "Q«êngw√®n sh√¨ d«ébƒÅo d√†iz«íu h√°ish√¨ z√†i zh√®'er hƒì?" },
            6: { text: "ÈúÄË¶ÅÂê∏ÁÆ°ÂêóÔºü", py: "X≈´y√†o xƒ´gu«én ma?" }
        };

        function getRuby(text, pinyinStr = "") {
            let html = "";
            const isChinese = (char) => /[\u4e00-\u9fff]/.test(char);
            for (let char of text) {
                if(isChinese(char)) {
                    let py = pinyinMap[char] || "";
                    html += `<ruby>${char}<rt>${py}</rt></ruby>`;
                } else {
                    html += char;
                }
            }
            return html;
        }

        function initGame() {
            gameState.step = 1;
            gameState.selections = { drink: null, size: null, sweetness: null, temp: null, serving: null, straw: null };
            document.getElementById('completeZone').style.display = 'none';
            document.getElementById('billZone').style.display = 'none';
            document.getElementById('interactionZone').style.display = 'block';
            document.getElementById('footerControls').style.display = 'flex';
            document.getElementById('chatArea').innerHTML = ''; 
            renderSteps();
            renderVocab();
            renderStepUI();
        }

        function renderSteps() {
            const bar = document.getElementById('stepBar');
            bar.innerHTML = stepsInfo.map((label, index) => {
                const stepNum = index + 1;
                let cls = 'step-item';
                if(stepNum < gameState.step) cls += ' completed';
                if(stepNum === gameState.step) cls += ' active';
                return `<div class="${cls}">
                            ${stepNum < gameState.step ? '<i class="fas fa-check"></i>' : stepNum}
                            <div class="step-label">${getRuby(label)}</div>
                        </div>`;
            }).join('');
        }

        function renderVocab() {
            const html = vocabulary.map(v => `
                <div class="vocab-item">
                    <div class="v-icon">${v.icon}</div>
                    <div class="v-text">
                        <div class="v-word">${getRuby(v.ch, v.py)}</div>
                        <div class="v-mean">${v.vn}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('vocabList').innerHTML = html;
            document.getElementById('vocabModalContent').innerHTML = html;
        }

        function renderStepUI() {
            const step = gameState.step;
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = ''; 
            const serverData = serverScript[step];
            addMessage('server', serverData.text, serverData.py);
            const categoryKey = getCategoryKey(step);
            const currentSelectionId = gameState.selections[categoryKey];
            if (currentSelectionId) {
                const opt = optionsDB[categoryKey].find(o => o.id === currentSelectionId);
                let reply = opt.name;
                if(categoryKey === 'drink') reply = `ÊàëÊÉ≥Âñù${opt.name}„ÄÇ`;
                else reply = `${opt.name}„ÄÇ`;
                addMessage('customer', reply, opt.py);
            }
            renderOptionsGrid();
            updateNextBtn();
        }

        function renderOptionsGrid() {
            const step = gameState.step;
            const categoryKey = getCategoryKey(step);
            const options = optionsDB[categoryKey];
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = options.map(opt => `
                <div class="option-card ${gameState.selections[categoryKey] === opt.id ? 'selected' : ''}" 
                     onclick="selectOption('${categoryKey}', '${opt.id}')">
                    <div class="opt-icon">${opt.icon}</div>
                    <div class="opt-name">${getRuby(opt.name, opt.py)}</div>
                </div>
            `).join('');
        }

        function getCategoryKey(step) {
            return ['drink', 'size', 'sweetness', 'temp', 'serving', 'straw'][step - 1];
        }

        function addMessage(role, text, pinyin = "") {
            const chat = document.getElementById('chatArea');
            const icon = role === 'server' ? '<i class="fas fa-user-tie"></i>' : '<i class="fas fa-user"></i>';
            const html = `
                <div class="msg ${role}">
                    <div class="avatar ${role}">${icon}</div>
                    <div class="bubble">${getRuby(text, pinyin)}</div>
                </div>
            `;
            chat.insertAdjacentHTML('beforeend', html);
        }

        function selectOption(key, id) {
            gameState.selections[key] = id;
            renderStepUI();
        }

        function updateNextBtn() {
            const key = getCategoryKey(gameState.step);
            document.getElementById('nextBtn').disabled = !gameState.selections[key];
        }

        document.getElementById('nextBtn').addEventListener('click', () => {
            if(gameState.step < 6) {
                gameState.step++;
                renderSteps();
                renderStepUI();
            } else {
                showBill();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', initGame);
        document.getElementById('rejectOrderBtn').addEventListener('click', initGame);

        document.getElementById('confirmOrderBtn').addEventListener('click', () => {
             document.getElementById('billZone').style.display = 'none';
             document.getElementById('completeZone').style.display = 'block';
             const s = gameState.selections;
             const getName = (cat, id) => optionsDB[cat].find(x => x.id === id).name;
             const fullSentence = `ÊàëË¶Å‰∏ÄÊùØ${getName('drink', s.drink)}Ôºå${getName('size', s.size)}Ôºå${getName('sweetness', s.sweetness)}Ôºå${getName('temp', s.temp)}Ôºå${getName('serving', s.serving)}Ôºå${getName('straw', s.straw)}Âê∏ÁÆ°„ÄÇ`;
             document.getElementById('finalSentence').innerHTML = getRuby(fullSentence);
        });

        function showBill() {
            document.getElementById('interactionZone').style.display = 'none';
            document.getElementById('footerControls').style.display = 'none';
            document.getElementById('chatArea').innerHTML = '';
            const s = gameState.selections;
            const getName = (cat, id) => optionsDB[cat].find(x => x.id === id).name;
            const summaryText = `ËØ∑Á°ÆËÆ§ÊÇ®ÁöÑËÆ¢ÂçïÔºö${getName('drink', s.drink)}Ôºå${getName('size', s.size)}Ôºå${getName('sweetness', s.sweetness)}Ôºå${getName('temp', s.temp)}Ôºå${getName('serving', s.serving)}„ÄÇÂØπÂêóÔºü`;
            addMessage('server', summaryText);
            const details = document.getElementById('billDetails');
            const row = (label, val) => `<div class="bill-row"><span>${label}</span><span class="bill-val">${getRuby(val)}</span></div>`;
            details.innerHTML = `
                ${row("Drinks:", getName('drink', s.drink))}
                ${row("Size:", getName('size', s.size))}
                ${row("Sugar:", getName('sweetness', s.sweetness))}
                ${row("Temp:", getName('temp', s.temp))}
                ${row("Type:", getName('serving', s.serving))}
                ${row("Straw:", getName('straw', s.straw))}
            `;
            document.getElementById('billZone').style.display = 'block';
        }

        const modal = document.getElementById('vocabModal');
        const openBtn = document.getElementById('vocabMobileBtn');
        const closeBtn = document.getElementById('closeVocabModal');
        openBtn.addEventListener('click', () => modal.style.display = 'flex');
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

        const pinyinToggle = document.getElementById('pinyinToggle');
        pinyinToggle.addEventListener('click', () => {
            document.body.classList.toggle('show-pinyin');
            pinyinToggle.classList.toggle('active');
            const isActive = pinyinToggle.classList.contains('active');
            document.getElementById('toggleText').textContent = isActive ? "·∫®n Pinyin" : "Hi·ªán Pinyin";
        });

        initGame();
    </script>
</body>
</html>
