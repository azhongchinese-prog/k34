<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK1 G·ªçi m√≥n ·ªü nh√† h√†ng - Th·∫ßy Trung</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d35400;       /* M√†u cam ch√°y ch·ªß ƒë·∫°o */
            --primary-light: #e67e22;
            --secondary: #2c3e50;     /* M√†u xanh ƒë·∫≠m */
            --bg-body: #fdfaf5;       /* M√†u kem n·ªÅn n√£ */
            --bg-card: #ffffff;
            --text-main: #4a3c31;
            --text-light: #7f8c8d;
            --accent: #27ae60;        /* M√†u xanh l√° cho n√∫t x√°c nh·∫≠n */
            --border-radius: 16px;
            --shadow: 0 10px 30px rgba(211, 84, 0, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Nunito', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        /* --- Header & Container --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 25px;
            align-items: start;
        }

        header {
            grid-column: 1 / -1;
            background: #fff;
            padding: 20px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--primary);
        }

        .header-title h1 {
            font-size: 1.8rem;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .header-title .subtitle {
            color: var(--text-light);
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* --- Pinyin Toggle Switch --- */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            background: #f0f2f5;
            padding: 8px 16px;
            border-radius: 30px;
            transition: 0.3s;
        }
        
        .toggle-container:hover { background: #e1e4e8; }
        .toggle-container.active { background: var(--primary); color: white; }
        .toggle-icon { font-size: 1.2rem; }
        .toggle-label { font-weight: 700; font-size: 0.9rem; }

        /* --- Ruby Text (Pinyin Logic) --- */
        ruby {
            ruby-position: over;
            display: inline-flex;
            flex-direction: column-reverse;
            align-items: center;
            margin: 0 1px;
            vertical-align: bottom;
        }
        
        rt {
            font-size: 0.6em;
            line-height: 1;
            color: var(--primary);
            font-weight: normal;
            opacity: 0; /* M·∫∑c ƒë·ªãnh ·∫©n */
            transform: translateY(5px);
            transition: all 0.3s ease;
            user-select: none;
        }

        /* Class n√†y ƒë∆∞·ª£c JS th√™m v√†o Body ƒë·ªÉ hi·ªán Pinyin */
        body.show-pinyin rt {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Progress Steps --- */
        .step-bar {
            grid-column: 1 / -1;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            position: relative;
            box-shadow: var(--shadow);
        }

        .step-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 40px;
            right: 40px;
            height: 3px;
            background: #eee;
            z-index: 0;
            transform: translateY(-50%);
        }

        .step-item {
            position: relative;
            z-index: 1;
            background: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #ccc;
            transition: 0.3s;
        }

        .step-item.active { border-color: var(--primary); color: var(--primary); background: #fff5eb; transform: scale(1.1); }
        .step-item.completed { background: var(--primary); border-color: var(--primary); color: #fff; }
        .step-label {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            white-space: nowrap;
            color: var(--text-light);
            font-weight: 600;
        }
        .step-item.active .step-label { color: var(--primary); }

        /* --- Main Content Area --- */
        .main-card {
            background: #fff;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        /* Dialogue Chat Bubbles */
        .dialogue-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .message {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(10px); } }

        .message.server { align-self: flex-start; }
        .message.customer { align-self: flex-end; flex-direction: row-reverse; }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }
        .avatar.server { background: var(--secondary); }
        .avatar.customer { background: var(--accent); }

        .bubble {
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 1.2rem;
            position: relative;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .message.server .bubble {
            background: #f0f2f5;
            color: var(--text-main);
            border-bottom-left-radius: 4px;
        }
        
        .message.customer .bubble {
            background: #e3f2fd;
            color: #0d47a1;
            border-bottom-right-radius: 4px;
        }

        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .option-card {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .option-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .option-card.selected {
            border-color: var(--primary);
            background: #fff5eb;
        }

        .opt-emoji { font-size: 2.5rem; display: block; margin-bottom: 8px; }
        .opt-text { font-size: 1.1rem; font-weight: 700; color: var(--secondary); }

        /* --- Sidebar (Vocabulary) --- */
        .sidebar {
            background: #fff;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-title {
            font-size: 1.1rem;
            color: var(--primary);
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .vocab-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .vocab-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            background: #f9f9f9;
            transition: 0.2s;
            border-left: 3px solid transparent;
        }

        .vocab-card:hover { border-left-color: var(--primary); background: #fff5eb; }

        .v-emoji { font-size: 1.4rem; }
        .v-content { display: flex; flex-direction: column; }
        .v-hanzi { font-weight: 700; font-size: 1.1rem; color: var(--secondary); line-height: 1.2; }
        .v-meaning { font-size: 0.85rem; color: var(--text-light); }

        /* --- Footer Controls --- */
        .controls {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            font-size: 1rem;
        }

        .btn-reset { background: #f0f2f5; color: var(--text-light); }
        .btn-reset:hover { background: #e1e4e8; color: var(--secondary); }

        .btn-next { background: var(--primary); color: white; }
        .btn-next:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(211, 84, 0, 0.3); }
        .btn-next:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        /* --- Bill / Summary Styles --- */
        .bill-container {
            background: #fff;
            border: 2px dashed #ccc;
            padding: 30px;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
            font-family: 'Courier New', monospace; /* Font ki·ªÉu h√≥a ƒë∆°n */
        }
        
        .bill-header { text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 15px; margin-bottom: 20px; }
        .bill-header h3 { font-size: 1.5rem; color: var(--secondary); margin-bottom: 5px; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.1rem; }
        .bill-label { color: #666; }
        .bill-value { font-weight: bold; color: var(--secondary); }
        .bill-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc; text-align: center; font-style: italic; color: var(--primary); }

        /* --- Mobile Responsive --- */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* ·∫®n sidebar tr√™n mobile cho g·ªçn, ho·∫∑c c√≥ th·ªÉ chuy·ªÉn xu·ªëng d∆∞·ªõi */
            .main-card { min-height: auto; }
            .options-grid { grid-template-columns: repeat(2, 1fr); }
            header { flex-direction: column; gap: 15px; text-align: center; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-title">
                <h1>HSK1 È§êÂéÖÁÇπÈ§ê (G·ªçi m√≥n)</h1>
                <div class="subtitle">Roleplay Practice - Th·∫ßy Trung</div>
            </div>
            <div class="toggle-container" id="pinyinToggle">
                <i class="fas fa-language toggle-icon"></i>
                <span class="toggle-label" id="toggleText">Hi·ªán Pinyin (B·∫≠t phi√™n √¢m)</span>
            </div>
        </header>

        <!-- Progress Steps -->
        <div class="step-bar">
            <!-- ƒê∆∞·ª£c t·∫°o b·∫±ng JS -->
        </div>

        <!-- Main Interaction Area -->
        <div class="main-card">
            
            <div class="dialogue-area" id="dialogueContent">
                <!-- H·ªôi tho·∫°i s·∫Ω hi·ªán ·ªü ƒë√¢y -->
            </div>

            <!-- Khu v·ª±c l·ª±a ch·ªçn -->
            <div id="interactionZone">
                <div class="options-grid" id="optionsArea">
                    <!-- C√°c l·ª±a ch·ªçn s·∫Ω hi·ªán ·ªü ƒë√¢y -->
                </div>
            </div>

            <!-- Khu v·ª±c h√≥a ƒë∆°n x√°c nh·∫≠n (·∫®n m·∫∑c ƒë·ªãnh) -->
            <div id="confirmZone" style="display: none;">
                <div class="bill-container">
                    <div class="bill-header">
                        <h3>ËÆ¢Âçï (H√≥a ƒë∆°n)</h3>
                        <p>Table: 01</p>
                    </div>
                    <div id="billContent">
                        <!-- N·ªôi dung h√≥a ƒë∆°n -->
                    </div>
                    <div class="bill-footer">
                        Ë∞¢Ë∞¢ÂÖâ‰∏¥ (C·∫£m ∆°n qu√Ω kh√°ch!)
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
                    <button class="btn btn-reset" id="billRejectBtn" style="background: #e74c3c; color: white;">
                        <i class="fas fa-times"></i> ‰∏çÂØπ (S·ª≠a l·∫°i)
                    </button>
                    <button class="btn btn-next" id="billConfirmBtn" style="background: var(--accent);">
                        <i class="fas fa-check"></i> ÂØπ (ƒê√∫ng r·ªìi)
                    </button>
                </div>
            </div>

            <!-- Khu v·ª±c ho√†n th√†nh (·∫®n m·∫∑c ƒë·ªãnh) -->
            <div id="completeZone" style="display: none; text-align: center; padding: 40px;">
                <i class="fas fa-check-circle" style="font-size: 5rem; color: var(--accent); margin-bottom: 20px;"></i>
                <h2 style="color: var(--secondary); margin-bottom: 10px;">ÂÆåÊàêÁÇπÈ§ê!</h2>
                <p style="color: var(--text-light); margin-bottom: 30px;">B·∫°n ƒë√£ ho√†n th√†nh b√†i luy·ªán t·∫≠p g·ªçi m√≥n.</p>
                <div id="finalSummary" class="bill-container" style="margin-bottom: 30px; transform: scale(0.9);"></div>
                <button class="btn btn-next" id="playAgainBtn" style="margin: 0 auto;">
                    <i class="fas fa-redo"></i> Luy·ªán t·∫≠p l·∫°i
                </button>
            </div>

            <!-- Footer Buttons -->
            <div class="controls" id="footerControls">
                <button class="btn btn-reset" id="resetBtn">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button class="btn btn-next" id="nextBtn" disabled>
                    Ti·∫øp theo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Sidebar Vocabulary -->
        <div class="sidebar">
            <div class="sidebar-title">
                <i class="fas fa-book-open"></i> ÁîüËØçË°® (T·ª´ v·ª±ng)
            </div>
            <div class="vocab-list" id="vocabList">
                <!-- T·ª´ v·ª±ng s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const gameState = {
            currentStep: 1,
            totalSteps: 6,
            selection: {
                cuisine: null,
                bowlSize: null,
                spiciness: null,
                serving: null,
                utensils: null
            }
        };

        const pinyinDict = {
            "‰Ω†": "n«ê", "ÊÉ≥": "xi«éng", "ÂêÉ": "chƒ´", "‰ªÄ": "sh√©n", "‰πà": "me", 
            "ËØ∑": "q«êng", "ÈóÆ": "w√®n", "Ë¶Å": "y√†o", "Á¢ó": "w«én", "Âûã": "x√≠ng",
            "Ëæ£": "l√†", "Â∫¶": "d√π", "Â¶Ç": "r√∫", "‰Ωï": "h√©", "ÊòØ": "sh√¨",
            "Êâì": "d«é", "ÂåÖ": "bƒÅo", "Â∏¶": "d√†i", "Ëµ∞": "z«íu", "Ëøò": "h√°i",
            "Âú®": "z√†i", "Ëøô": "zh√®", "ÂÑø": "er", "ÈúÄ": "x≈´", "‰∏Ä": "yƒ´",
            "Ê¨°": "c√¨", "ÊÄß": "x√¨ng", "È§ê": "cƒÅn", "ÂÖ∑": "j√π", "Âêó": "ma",
            "ÂØπ": "du√¨", "‰∏ç": "b√π", "Â§ß": "d√†", "Â∞è": "xi«éo", "Ê≠£": "zh√®ng",
            "Â∏∏": "ch√°ng", "Â∞ë": "sh«éo", "Ë∂ä": "yu√®", "Âçó": "n√°n", "Ëèú": "c√†i",
            "‰∏≠": "zh≈çng", "ÂõΩ": "gu√≥", "Áæé": "mƒõi", "Êàë": "w«í", "ÁöÑ": "de",
            "ÁÇπ": "di«én", "ÈÄâ": "xu«én", "Êã©": "z√©", "Â∞±": "ji√π", "Êñπ": "fƒÅng",
            "Âºè": "sh√¨", "Á°Æ": "qu√®", "ËÆ§": "r√®n", "È•≠": "f√†n", "Á±≥": "m«ê",
            "Âñù": "hƒì", "È°æ": "g√π", "ÂÆ¢": "k√®", "Êúç": "f√∫", "Âä°": "w√π",
            "Âëò": "yu√°n", "Èáç": "ch√≥ng", "Êñ∞": "xƒ´n", "ÂºÄ": "kƒÅi", "Âßã": "sh«ê",
            "‰∏ã": "xi√†", "Ê≠•": "b√π", "ÊÇ®": "n√≠n", "Ë∞¢": "xi√®", "ÂÖâ": "guƒÅng",
            "‰∏¥": "l√≠n", "ÂÆå": "w√°n", "Êàê": "ch√©ng", "ÂÜç": "z√†i", "ËßÅ": "ji√†n",
            "Â•Ω": "h«éo", "Ê¨¢": "huƒÅn", "Ëøé": "y√≠ng", "Êú¨": "bƒõn", "ËØæ": "k√®",
            "Áîü": "shƒìng", "ËØç": "c√≠", "Ê∞¥": "shu«ê", "Âπ≥": "p√≠ng", "Ë°®": "bi«éo",
            "ÊÉÖ": "q√≠ng", "Â∏Æ": "bƒÅng", "Âä©": "zh√π", "Èáå": "l«ê", "Êúâ": "y«íu",
            "ÂèØ": "kƒõ", "‰ª•": "y«ê", "Áªô": "gƒõi", "Áúã": "k√†n", "Âçï": "dƒÅn",
            "‰ªä": "jƒ´n", "Â§©": "tiƒÅn", "Áâπ": "t√®", "Âà´": "bi√©", "Êé®": "tuƒ´",
            "Ëçê": "ji√†n", "‰∏ú": "d≈çng", "Ë•ø": "xi", "Âæà": "hƒõn", "Âë≥": "w√®i",
            "ÈÅì": "d√†o", "ÊÄé": "zƒõn", "Ê†∑": "y√†ng", "Áîú": "ti√°n", "ÈÖ∏": "suƒÅn",
            "Ëã¶": "k«î", "Âí∏": "xi√°n", "È∫ª": "m√°", "È≤ú": "xiƒÅn", "Áæé": "mƒõi",
            "Âè£": "k«íu", "ÊÑü": "g«én", "Èîô": "cu√≤", "Âñú": "x«ê", "Â§ö": "du≈ç",
            "Èí±": "qi√°n", "Âùó": "ku√†i", "ÂÖÉ": "yu√°n", "Ëßí": "ji«éo", "ÂàÜ": "fƒìn",
            "Ë¥µ": "gu√¨", "‰æø": "pi√°n", "ÂÆú": "yi", "Âêà": "h√©", "ÈÄÇ": "sh√¨",
            "Áî®": "y√≤ng", "Ê∞î": "qi", "Á®ç": "shƒÅo", "Á≠â": "dƒõng", "È©¨": "m«é",
            "‰∏ä": "sh√†ng", "Êù•": "l√°i", "Á•ù": "zh√π", "ÊÑâ": "y√∫", "Âø´": "ku√†i"
        };

        const vocabulary = [
            { chinese: "ÂêÉ", pinyin: "chƒ´", meaning: "ƒÉn", emoji: "üçΩÔ∏è" },
            { chinese: "ÊÉ≥", pinyin: "xi«éng", meaning: "mu·ªën", emoji: "üí≠" },
            { chinese: "‰ªÄ‰πà", pinyin: "sh√©nme", meaning: "c√°i g√¨", emoji: "‚ùì" },
            { chinese: "Ëèú", pinyin: "c√†i", meaning: "m√≥n ƒÉn", emoji: "ü•ò" },
            { chinese: "Â§ßÁ¢ó", pinyin: "d√† w«én", meaning: "t√¥ l·ªõn", emoji: "ü•£" },
            { chinese: "Â∞èÁ¢ó", pinyin: "xi«éo w«én", meaning: "t√¥ nh·ªè", emoji: "ü•£" },
            { chinese: "Ëæ£", pinyin: "l√†", meaning: "cay", emoji: "üå∂Ô∏è" },
            { chinese: "ÊâìÂåÖÂ∏¶Ëµ∞", pinyin: "d«é bƒÅo d√†i z«íu", meaning: "g√≥i mang ƒëi", emoji: "ü•°" },
            { chinese: "Âú®ËøôÂÑøÂêÉ", pinyin: "z√†i zh√®'er chƒ´", meaning: "ƒÉn t·∫°i ƒë√¢y", emoji: "üìç" },
            { chinese: "‰∏ÄÊ¨°ÊÄßÈ§êÂÖ∑", pinyin: "yƒ´ c√¨ x√¨ng cƒÅn j√π", meaning: "d·ª•ng c·ª• ƒÉn x√†i 1 l·∫ßn", emoji: "ü•¢" },
            { chinese: "Ë¶Å", pinyin: "y√†o", meaning: "mu·ªën,c·∫ßn,ph·∫£i", emoji: "‚úÖ" },
            { chinese: "‰∏çË¶Å", pinyin: "b√∫ y√†o", meaning: "kh√¥ng c·∫ßn", emoji: "‚ùå" },
            { chinese: "Ë∞¢Ë∞¢", pinyin: "xi√®xie", meaning: "c·∫£m ∆°n", emoji: "üôè" }
        ];

        const optionsData = {
            cuisines: [
                { id: "vietnamese", name: "Ë∂äÂçóËèú", pinyin: "Yu√®n√°n c√†i", emoji: "üáªüá≥" },
                { id: "chinese", name: "‰∏≠ÂõΩËèú", pinyin: "Zh≈çnggu√≥ c√†i", emoji: "üá®üá≥" },
                { id: "american", name: "ÁæéÂõΩËèú", pinyin: "Mƒõigu√≥ c√†i", emoji: "üá∫üá∏" }
            ],
            bowlSizes: [
                { id: "bigBowl", name: "Â§ßÁ¢ó", pinyin: "d√† w«én", emoji: "üçö+" },
                { id: "smallBowl", name: "Â∞èÁ¢ó", pinyin: "xi«éo w«én", emoji: "üçö-" }
            ],
            spicinessLevels: [
                { id: "normalSpicy", name: "Ê≠£Â∏∏Ëæ£", pinyin: "zh√®ngch√°ng l√†", emoji: "ü•µ" },
                { id: "lessSpicy", name: "Â∞ëËæ£", pinyin: "sh«éo l√†", emoji: "ü´ë" },
                { id: "notSpicy", name: "‰∏çËæ£", pinyin: "b√π l√†", emoji: "üòä" }
            ],
            servingOptions: [
                { id: "takeaway", name: "ÊâìÂåÖÂ∏¶Ëµ∞", pinyin: "d«ébƒÅo d√†iz«íu", emoji: "ü•°" },
                { id: "dineIn", name: "Âú®ËøôÂÑøÂêÉ", pinyin: "z√†i zh√®'er chƒ´", emoji: "üçΩÔ∏è" }
            ],
            utensilOptions: [
                { id: "needUtensils", name: "Ë¶Å", pinyin: "y√†o", emoji: "üëç" },
                { id: "noUtensils", name: "‰∏çË¶Å", pinyin: "b√∫ y√†o", emoji: "ü´∑" }
            ]
        };

        const serverDialogues = {
            step1: { text: "‰Ω†ÊÉ≥ÂêÉ‰ªÄ‰πàÔºü", emoji: "ü§î" },
            step2: { text: "ËØ∑ÈóÆË¶Å‰ªÄ‰πàÂ§ßÁ¢óËøòÊòØÂ∞èÁ¢óÔºü", emoji: "ü•£" },
            step3: { text: "ËØ∑ÈóÆËæ£Â∫¶ÊÄé‰πàÊ†∑Ôºü", emoji: "üå∂Ô∏è" },
            step4: { text: "ËØ∑ÈóÆÊòØÊâìÂåÖÂ∏¶Ëµ∞ËøòÊòØÂú®ËøôÂÑøÂêÉÔºü", emoji: "üçΩÔ∏è" },
            step5: { text: "ÈúÄË¶Å‰∏ÄÊ¨°ÊÄßÈ§êÂÖ∑ÂêóÔºü", emoji: "ü•¢" },
            step6: { text: "ÊÇ®ÁÇπÁöÑÈ§êÊòØ...ÔºåÂØπÂêóÔºü", emoji: "üßæ" }
        };

        const stepLabels = ["ËèúËÇ¥", "Á¢óÂûã", "Ëæ£Â∫¶", "Â∞±È§ê", "È§êÂÖ∑", "Á°ÆËÆ§"];

        // --- HELPER FUNCTIONS ---

        // H√†m t·∫°o Ruby Text (Ch·ªØ H√°n ·ªü d∆∞·ªõi, Pinyin ·ªü tr√™n)
        function createRubyText(text, pinyinOverride = null) {
            let result = '';
            // N·∫øu c√≥ Pinyin ghi ƒë√® (cho c√°c c·ª•m t·ª´ ƒë·∫∑c bi·ªát trong option)
            if (pinyinOverride) {
                // ƒê√¢y l√† c√°ch ƒë∆°n gi·∫£n: Map t·ª´ng k√Ω t·ª± v·ªõi t·ª´ng t·ª´ pinyin.
                // L∆∞u √Ω: data pinyin trong optionsData c·∫ßn kh·ªõp s·ªë l∆∞·ª£ng ch·ªØ H√°n.
                // V√≠ d·ª•: "Yu√®n√°n c√†i" (2 t·ª´ pinyin) vs "Ë∂äÂçóËèú" (3 ch·ªØ) -> C·∫ßn x·ª≠ l√Ω k·ªπ h∆°n n·∫øu mu·ªën ch√≠nh x√°c 100%.
                // ƒê·ªÉ ƒë∆°n gi·∫£n v√† ƒë·∫πp cho demo, ta s·∫Ω d√πng t·ª´ ƒëi·ªÉn lookup cho t·ª´ng ch·ªØ trong c√¢u.
                // Override ch·ªâ d√πng tham kh·∫£o n·∫øu kh√¥ng t√¨m th·∫•y trong dict.
            }

            for (let char of text) {
                if (/[\u4e00-\u9fff]/.test(char)) {
                    const p = pinyinDict[char] || '';
                    result += `<ruby>${char}<rt>${p}</rt></ruby>`;
                } else {
                    result += char;
                }
            }
            return result;
        }

        function getSelectionKeyForStep(step) {
            const keys = ['cuisine', 'bowlSize', 'spiciness', 'serving', 'utensils', null];
            return keys[step - 1];
        }

        function getOptionCategory(key) {
            const map = {
                cuisine: 'cuisines',
                bowlSize: 'bowlSizes',
                spiciness: 'spicinessLevels',
                serving: 'servingOptions',
                utensils: 'utensilOptions'
            };
            return map[key];
        }

        function getSelectedOption(key) {
            const id = gameState.selection[key];
            if(!id) return null;
            const cat = getOptionCategory(key);
            return optionsData[cat].find(o => o.id === id);
        }

        // --- RENDER FUNCTIONS ---

        function renderVocab() {
            const list = document.getElementById('vocabList');
            list.innerHTML = vocabulary.map(v => `
                <div class="vocab-card">
                    <div class="v-emoji">${v.emoji}</div>
                    <div class="v-content">
                        <div class="v-hanzi">${createRubyText(v.chinese)}</div>
                        <div class="v-meaning">${v.meaning}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderSteps() {
            const container = document.querySelector('.step-bar');
            let html = '';
            for(let i = 1; i <= gameState.totalSteps; i++) {
                let className = 'step-item';
                if(i < gameState.currentStep) className += ' completed';
                if(i === gameState.currentStep) className += ' active';
                
                html += `
                    <div class="${className}">
                        ${i < gameState.currentStep ? '<i class="fas fa-check"></i>' : i}
                        <div class="step-label">${stepLabels[i-1]}</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderDialogue() {
            const content = document.getElementById('dialogueContent');
            const data = serverDialogues[`step${gameState.currentStep}`];
            let text = data.text;

            // X·ª≠ l√Ω b∆∞·ªõc 6 (X√°c nh·∫≠n)
            if(gameState.currentStep === 6) {
                const s = gameState.selection;
                // Helper l·∫•y t√™n m√≥n
                const getName = (k) => getSelectedOption(k).name;
                text = `ÊÇ®ÁÇπÁöÑÈ§êÊòØÔºö${getName('cuisine')}Ôºå${getName('bowlSize')}Ôºå${getName('spiciness')}Ôºå${getName('serving')}Ôºå${getName('utensils')}‰∏ÄÊ¨°ÊÄßÈ§êÂÖ∑„ÄÇÂØπÂêóÔºü`;
            }

            // Render Server Message
            let html = `
                <div class="message server">
                    <div class="avatar server"><i class="fas fa-user-tie"></i></div>
                    <div class="bubble">
                        ${createRubyText(text)} 
                        <span style="font-size: 1.5rem; vertical-align: middle;">${data.emoji}</span>
                    </div>
                </div>
            `;

            // Render Customer Selection (n·∫øu ƒë√£ ch·ªçn ·ªü c√°c b∆∞·ªõc tr∆∞·ªõc)
            // Logic: N·∫øu ƒëang ·ªü b∆∞·ªõc X, v√† ƒë√£ c√≥ selection cho b∆∞·ªõc X, hi·ªán bubble c·ªßa kh√°ch
            const currentKey = getSelectionKeyForStep(gameState.currentStep);
            if(currentKey && gameState.selection[currentKey]) {
                const opt = getSelectedOption(currentKey);
                let reply = "";
                // T·∫°o c√¢u tr·∫£ l·ªùi t·ª± nhi√™n
                if(currentKey === 'cuisine') reply = `ÊàëÊÉ≥ÂêÉ${opt.name}„ÄÇ`;
                else if(currentKey === 'utensils') reply = `${opt.name}‰∏ÄÊ¨°ÊÄßÈ§êÂÖ∑„ÄÇ`;
                else reply = `${opt.name}„ÄÇ`;

                html += `
                    <div class="message customer">
                        <div class="avatar customer"><i class="fas fa-user"></i></div>
                        <div class="bubble">
                            ${createRubyText(reply)}
                            <span style="font-size: 1.5rem; vertical-align: middle;">${opt.emoji}</span>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function renderOptions() {
            const area = document.getElementById('optionsArea');
            const interactionZone = document.getElementById('interactionZone');
            const confirmZone = document.getElementById('confirmZone');
            const completeZone = document.getElementById('completeZone');
            const footer = document.getElementById('footerControls');

            // Reset visibilities
            interactionZone.style.display = 'block';
            confirmZone.style.display = 'none';
            completeZone.style.display = 'none';
            footer.style.display = 'flex';

            if(gameState.currentStep === 6) {
                interactionZone.style.display = 'none';
                footer.style.display = 'none'; // ·∫®n n√∫t next, d√πng n√∫t confirm ri√™ng
                renderBill('billContent');
                confirmZone.style.display = 'block';
                return;
            }

            const key = getSelectionKeyForStep(gameState.currentStep);
            const cat = getOptionCategory(key);
            const list = optionsData[cat];

            area.innerHTML = list.map(opt => {
                const isSelected = gameState.selection[key] === opt.id;
                return `
                    <div class="option-card ${isSelected ? 'selected' : ''}" onclick="selectOption('${key}', '${opt.id}')">
                        <span class="opt-emoji">${opt.emoji}</span>
                        <div class="opt-text">${createRubyText(opt.name)}</div>
                    </div>
                `;
            }).join('');

            updateNextBtn();
        }

        function renderBill(elementId) {
            const el = document.getElementById(elementId);
            const s = gameState.selection;
            
            const row = (label, key) => {
                const opt = getSelectedOption(key);
                return `
                    <div class="bill-row">
                        <span class="bill-label">${label}</span>
                        <span class="bill-value">${createRubyText(opt.name)}</span>
                    </div>
                `;
            };

            el.innerHTML = `
                ${row("ËèúËÇ¥ (M√≥n):", 'cuisine')}
                ${row("Á¢óÂûã (T√¥):", 'bowlSize')}
                ${row("Ëæ£Â∫¶ (Cay):", 'spiciness')}
                ${row("Â∞±È§ê (ƒÇn):", 'serving')}
                ${row("È§êÂÖ∑ (ƒê≈©a):", 'utensils')}
            `;
        }

        function updateNextBtn() {
            const btn = document.getElementById('nextBtn');
            const key = getSelectionKeyForStep(gameState.currentStep);
            btn.disabled = !gameState.selection[key];
        }

        // --- ACTIONS ---

        window.selectOption = function(key, id) {
            gameState.selection[key] = id;
            renderOptions(); // Re-render to show selection state
            renderDialogue(); // Re-render to show customer bubble
        }

        window.nextStep = function() {
            if(gameState.currentStep < gameState.totalSteps) {
                gameState.currentStep++;
                renderSteps();
                renderDialogue();
                renderOptions();
            }
        }

        window.initGame = function() {
            gameState.currentStep = 1;
            gameState.selection = {
                cuisine: null, bowlSize: null, spiciness: null, serving: null, utensils: null
            };
            document.getElementById('completeZone').style.display = 'none';
            renderSteps();
            renderDialogue();
            renderOptions();
            renderVocab();
        }

        // Pinyin Toggle
        const toggleBtn = document.getElementById('pinyinToggle');
        toggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('show-pinyin');
            toggleBtn.classList.toggle('active');
            
            const isShow = document.body.classList.contains('show-pinyin');
            document.getElementById('toggleText').innerText = isShow ? "·∫®n Pinyin (T·∫Øt phi√™n √¢m)" : "Hi·ªán Pinyin (B·∫≠t phi√™n √¢m)";
        });

        // Event Listeners
        document.getElementById('nextBtn').addEventListener('click', nextStep);
        document.getElementById('resetBtn').addEventListener('click', initGame);
        
        // Confirm Actions
        document.getElementById('billConfirmBtn').addEventListener('click', () => {
            // Show complete screen
            document.getElementById('interactionZone').style.display = 'none';
            document.getElementById('confirmZone').style.display = 'none';
            document.getElementById('footerControls').style.display = 'none';
            document.getElementById('dialogueContent').innerHTML = ''; // Clear chat
            
            const completeZone = document.getElementById('completeZone');
            completeZone.style.display = 'block';
            renderBill('finalSummary'); // Render bill again in summary
        });

        document.getElementById('billRejectBtn').addEventListener('click', initGame); // Reset for simplicity
        document.getElementById('playAgainBtn').addEventListener('click', initGame);

        // Start
        initGame();

    </script>
</body>
</html>
