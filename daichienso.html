<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ti·∫øng Trung: ƒê·∫°i Chi·∫øn M√™ Cung 1vs1 - Ho√†n Thi·ªán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Nunito:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', 'Noto Sans SC', sans-serif;
            background-color: #f0fdf4;
            touch-action: manipulation;
        }

        .grid-cell {
            aspect-ratio: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            user-select: none;
            position: relative;
            background-color: #ffffff;
            border-radius: 1rem;
        }

        .correct-p1 {
            background-color: #fef08a !important;
            border-color: #facc15 !important;
        }

        .correct-p2 {
            background-color: #fbcfe8 !important;
            border-color: #f472b6 !important;
        }

        .shake { animation: shake 0.5s; background-color: #fca5a5 !important; }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-4px, 0); }
            75% { transform: translate(4px, 0); }
        }

        .pop {
            animation: pop 0.3s ease;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .chicken-p1 {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 1.4rem;
            filter: drop-shadow(1px 1px 0 white);
            z-index: 21;
            animation: float 2s ease-in-out infinite;
        }

        .chicken-p2 {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 1.4rem;
            filter: drop-shadow(1px 1px 0 white);
            z-index: 20;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .pinyin { font-size: 0.7rem; color: #64748b; font-weight: bold; }
        .hanzi { font-size: 1.6rem; font-weight: 800; }

        .label-marker {
            position: absolute;
            font-weight: 800;
            font-size: 9px;
            z-index: 30;
            padding: 1px 5px;
            border-radius: 999px;
            border: 2px solid white;
        }

        .start-label { top: -8px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; }
        .exit-label { bottom: -8px; left: 50%; transform: translateX(-50%); background: #22c55e; color: white; }

        .battle-ui {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
        }

        .progress-bar {
            height: 12px;
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-weight: 800;
        }
        
        .connection-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connection-good { background-color: #22c55e; }
        .connection-warning { background-color: #f59e0b; }
        .connection-bad { background-color: #ef4444; }
        
        .score-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.7rem;
        }
    </style>
</head>
<body class="min-h-screen bg-green-50 flex flex-col items-center p-2 sm:p-4">

    <!-- Header -->
    <header class="text-center w-full max-w-4xl mb-4">
        <h1 class="text-2xl sm:text-3xl font-black text-green-800 uppercase tracking-tighter">ƒê·∫†I CHI·∫æN M√ä CUNG TI·∫æNG TRUNG</h1>
        <div id="connection-status" class="text-xs font-bold flex items-center justify-center gap-2 mt-2 hidden">
            <span id="connection-indicator" class="connection-dot connection-bad"></span>
            <span id="connection-message">ƒêang k·∫øt n·ªëi...</span>
        </div>
    </header>

    <div class="w-full max-w-6xl flex flex-col lg:flex-row gap-4 sm:gap-6">
        
        <!-- C·ªôt tr√°i: Khu v·ª±c ƒê·∫•u tr∆∞·ªùng -->
        <div class="flex-grow flex flex-col items-center">
            
            <!-- Battle Status Panel -->
            <div id="battle-panel" class="w-full max-w-lg bg-white rounded-3xl p-4 shadow-xl border-4 border-green-200 mb-4 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Player 1 -->
                    <div id="p1-info" class="text-center p-3 rounded-2xl transition-all border-2 border-transparent">
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-2xl">üê•</span>
                            <span id="p1-score" class="score-badge">0</span>
                        </div>
                        <div id="p1-name" class="font-black text-lg truncate mt-1">---</div>
                        <div class="w-full bg-gray-100 rounded-full mt-2">
                            <div id="p1-progress-bar" class="progress-bar bg-yellow-400" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Player 2 -->
                    <div id="p2-info" class="text-center p-3 rounded-2xl transition-all border-2 border-transparent">
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-2xl">üéÄ</span>
                            <span id="p2-score" class="score-badge">0</span>
                        </div>
                        <div id="p2-name" class="font-black text-lg truncate mt-1">---</div>
                        <div class="w-full bg-gray-100 rounded-full mt-2">
                            <div id="p2-progress-bar" class="progress-bar bg-pink-400" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <div id="battle-msg" class="text-xs font-bold text-gray-400 uppercase tracking-widest">ƒêang thi ƒë·∫•u...</div>
                    <div id="timer-display" class="timer-display text-green-600 text-sm bg-green-50 px-3 py-1 rounded-full">
                        ‚è±Ô∏è <span id="timer">180</span>s
                    </div>
                </div>
            </div>

            <!-- Target Number -->
            <div class="flex items-center justify-between w-full max-w-md mb-2">
                <div class="bg-white px-6 py-3 rounded-2xl shadow-md border-2 border-green-100 flex-grow text-center">
                    <span class="text-gray-400 text-[10px] uppercase font-black block">T√¨m s·ªë ti·∫øp theo</span>
                    <span id="target-display" class="font-black text-3xl text-green-600 italic">...</span>
                </div>
            </div>

            <!-- Maze Grid -->
            <div class="grid-container w-full max-w-md relative p-1 sm:p-2">
                <!-- Spectator Overlay -->
                <div id="spectator-overlay" class="hidden absolute inset-0 z-40 flex items-center justify-center rounded-3xl">
                    <div class="bg-white/90 p-4 rounded-2xl shadow-2xl border-2 border-gray-100 text-center animate-pulse">
                        <span class="text-4xl">üçø</span>
                        <p class="text-sm font-black text-gray-500 mt-2 uppercase">Ch·∫ø ƒë·ªô quan s√°t</p>
                        <p class="text-xs text-gray-400 mt-1">Ch·ªù ƒë·∫øn l∆∞·ª£t c·ªßa b·∫°n</p>
                    </div>
                </div>

                <div id="game-grid" class="grid grid-cols-5 gap-2 sm:gap-3 bg-white p-3 sm:p-4 rounded-[2.5rem] shadow-2xl border-4 border-green-100">
                    <!-- JS generated cells -->
                </div>
            </div>

            <!-- Teacher Controls -->
            <div id="teacher-controls" class="mt-6 flex flex-wrap justify-center gap-2">
                <button id="btn-match-random" class="bg-indigo-600 hover:bg-indigo-700 text-white font-black px-6 py-3 rounded-2xl shadow-xl text-sm uppercase transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    üé≤ Gh√©p c·∫∑p ng·∫´u nhi√™n
                </button>
                <button id="btn-reset-battle" class="bg-red-500 hover:bg-red-600 text-white font-black px-4 py-3 rounded-2xl shadow-xl text-sm uppercase transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚ùå H·ªßy tr·∫≠n
                </button>
                <button id="btn-clear-queue" class="bg-amber-500 hover:bg-amber-600 text-white font-black px-4 py-3 rounded-2xl shadow-xl text-sm uppercase transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    üßπ X√≥a ph√≤ng ch·ªù
                </button>
            </div>
        </div>

        <!-- C·ªôt ph·∫£i: Danh s√°ch l·ªõp & H∆∞·ªõng d·∫´n -->
        <div class="w-full lg:w-80 flex-shrink-0 flex flex-col gap-4">
            <!-- Ph√≤ng ch·ªù -->
            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-100 p-6">
                <h3 class="font-black text-gray-800 mb-4 flex items-center gap-2 border-b-2 pb-2 text-lg">
                    <span>üè´</span> PH√íNG CH·ªú
                    <span id="queue-count" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">0</span>
                </h3>
                <div id="queue-list" class="space-y-3 min-h-[200px] max-h-[300px] overflow-y-auto">
                    <!-- JS generated queue -->
                </div>
                <div class="mt-4 text-[10px] text-gray-400 font-bold uppercase text-center">T·ªëi thi·ªÉu 2 b·∫°n ƒë·ªÉ ƒë·∫•u</div>
            </div>
            
            <!-- V·∫≠n h√†nh th·ª≠ -->
            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-100 p-6">
                <h3 class="font-black text-gray-800 mb-4 flex items-center gap-2 border-b-2 pb-2 text-lg">
                    <span>‚öôÔ∏è</span> V·∫¨N H√ÄNH TH·ª¨
                </h3>
                <p class="text-sm text-gray-600 mb-4">D√πng c√°c n√∫t b√™n d∆∞·ªõi ƒë·ªÉ ki·ªÉm tra t√≠nh nƒÉng khi kh√¥ng c√≥ ng∆∞·ªùi ch∆°i th·∫≠t:</p>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-test-player1" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-3 py-2 rounded-xl text-xs uppercase transition-all">
                        Th√™m P1 (M√®o)
                    </button>
                    <button id="btn-test-player2" class="bg-pink-500 hover:bg-pink-600 text-white font-bold px-3 py-2 rounded-xl text-xs uppercase transition-all">
                        Th√™m P2 (C√∫n)
                    </button>
                    <button id="btn-test-spectator" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-3 py-2 rounded-xl text-xs uppercase transition-all">
                        Th√™m kh√°n gi·∫£
                    </button>
                    <button id="btn-test-battle" class="bg-green-600 hover:bg-green-700 text-white font-bold px-3 py-2 rounded-xl text-xs uppercase transition-all">
                        T·∫°o tr·∫≠n th·ª≠
                    </button>
                </div>
                <div class="mt-4 p-3 bg-gray-50 rounded-xl">
                    <h4 class="font-bold text-gray-700 text-sm mb-2">H∆∞·ªõng d·∫´n nhanh:</h4>
                    <ul class="text-xs text-gray-600 space-y-1">
                        <li>1. Nh·∫≠p t√™n ‚Üí "S·∫µn s√†ng"</li>
                        <li>2. "Gh√©p c·∫∑p" khi c√≥ 2+ ng∆∞·ªùi</li>
                        <li>3. T√¨m s·ªë ti·∫øp theo trong m√™ cung</li>
                        <li>4. Ng∆∞·ªùi t√¨m ƒë·ªß 1-10 tr∆∞·ªõc s·∫Ω th·∫Øng!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 sm:p-10 rounded-[3rem] shadow-2xl text-center max-w-sm w-full border-8 border-green-50">
            <div id="win-icon" class="text-7xl mb-4">üëë</div>
            <h2 id="win-title" class="text-3xl font-black text-green-600 mb-2 uppercase">TH·∫ÆNG CU·ªòC!</h2>
            <p id="winner-name-display" class="text-gray-700 font-black text-2xl mb-4 uppercase italic"></p>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-yellow-50 p-3 rounded-2xl">
                    <div class="text-xs text-gray-500">P1 ƒêi·ªÉm</div>
                    <div id="p1-final-score" class="text-2xl font-black text-yellow-600">0</div>
                </div>
                <div class="bg-pink-50 p-3 rounded-2xl">
                    <div class="text-xs text-gray-500">P2 ƒêi·ªÉm</div>
                    <div id="p2-final-score" class="text-2xl font-black text-pink-600">0</div>
                </div>
            </div>
            <button id="btn-next-battle" class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-4 px-8 rounded-2xl shadow-xl transition-all text-lg uppercase">
                V·ªÅ ph√≤ng ch·ªù ‚úÖ
            </button>
            <button id="btn-rematch" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-black py-3 px-8 rounded-2xl shadow-xl transition-all text-sm uppercase mt-3">
                ƒê·∫•u l·∫°i v·ªõi c√πng ƒë·ªôi ‚ôªÔ∏è
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-green-100 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 sm:p-10 rounded-[3rem] shadow-2xl max-w-sm w-full text-center border-8 border-white">
            <div class="text-7xl mb-6">üê•üî•</div>
            <h2 class="text-3xl font-black text-green-800 mb-2 uppercase italic">ƒê·∫†I CHI·∫æN</h2>
            <p id="login-desc" class="text-gray-400 mb-6 font-bold text-xs">Nh·∫≠p t√™n ƒë·ªÉ so t√†i m√™ cung (2-15 k√Ω t·ª±)</p>
            
            <input type="text" id="login-name-input" placeholder="T√™n c·ªßa em..." maxlength="15"
                class="w-full border-4 border-green-50 bg-green-50 rounded-2xl px-6 py-4 mb-4 focus:outline-none focus:ring-4 focus:ring-green-200 text-2xl text-center font-black">
            <div id="name-error" class="text-red-500 text-xs mb-4 hidden"></div>
            
            <button id="btn-login" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-5 px-8 rounded-2xl shadow-xl transition-all text-xl uppercase disabled:opacity-50">
                S·∫µn s√†ng! üöÄ
            </button>
            
            <div class="mt-6 text-xs text-gray-400">
                <p>D√πng n√∫t "V·∫≠n h√†nh th·ª≠" ƒë·ªÉ test khi kh√¥ng c√≥ b·∫°n ch∆°i</p>
            </div>
        </div>
    </div>

    <!-- Debug Panel (ch·ªâ hi·ªán trong development) -->
    <div id="debug-panel" class="fixed bottom-4 right-4 bg-black/80 text-white p-3 rounded-xl text-xs font-mono hidden">
        <div>State: <span id="debug-state">-</span></div>
        <div>Players: <span id="debug-players">0</span></div>
    </div>

    <script>
        // =================== C·∫§U H√åNH & BI·∫æN TO√ÄN C·ª§C ===================
        const APP_ID = 'maze-battle-v2';
        const BATTLE_TIME_LIMIT = 180; // 3 ph√∫t
        const MAX_PLAYERS = 20;
        
        // D·ªØ li·ªáu s·ªë ti·∫øng Trung
        const numberData = [
            { val: 1, hanzi: "‰∏Ä", pinyin: "yƒ´" }, { val: 2, hanzi: "‰∫å", pinyin: "√®r" },
            { val: 3, hanzi: "‰∏â", pinyin: "sƒÅn" }, { val: 4, hanzi: "Âõõ", pinyin: "s√¨" },
            { val: 5, hanzi: "‰∫î", pinyin: "w«î" }, { val: 6, hanzi: "ÂÖ≠", pinyin: "li√π" },
            { val: 7, hanzi: "‰∏É", pinyin: "qƒ´" }, { val: 8, hanzi: "ÂÖ´", pinyin: "bƒÅ" },
            { val: 9, hanzi: "‰πù", pinyin: "ji«î" }, { val: 10, hanzi: "ÂçÅ", pinyin: "sh√≠" }
        ];
        
        // State c·ªßa ·ª©ng d·ª•ng
        let appState = {
            queue: [],
            battleActive: false,
            p1: { name: "", progress: 1, score: 0 },
            p2: { name: "", progress: 1, score: 0 },
            winner: "",
            pathIndices: [],
            cellsData: "",
            timer: BATTLE_TIME_LIMIT,
            battleStartTime: null,
            connectionStatus: "disconnected"
        };
        
        let myName = "";
        let currentTurn = null;
        let timerInterval = null;
        let connectionCheckInterval = null;
        let isSimulationMode = false;

        // =================== KH·ªûI T·∫†O ·ª®NG D·ª§NG ===================
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            setupEventListeners();
            loadFromLocalStorage();
            updateUI();
            
            // Hi·ªÉn th·ªã login modal
            document.getElementById('login-modal').classList.remove('hidden');
        });

        // =================== CORE FUNCTIONS ===================
        function initApp() {
            console.log("·ª®ng d·ª•ng ƒê·∫°i Chi·∫øn M√™ Cung ƒë√£ kh·ªüi ƒë·ªông!");
            
            // Ki·ªÉm tra k·∫øt n·ªëi ƒë·ªãnh k·ª≥
            connectionCheckInterval = setInterval(() => {
                updateConnectionStatus();
            }, 3000);
            
            // C·∫≠p nh·∫≠t debug panel
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('debug-panel').classList.remove('hidden');
                setInterval(updateDebugInfo, 1000);
            }
        }

        function setupEventListeners() {
            // Login
            document.getElementById('btn-login').addEventListener('click', handleLogin);
            document.getElementById('login-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Teacher controls
            document.getElementById('btn-match-random').addEventListener('click', matchRandomPlayers);
            document.getElementById('btn-reset-battle').addEventListener('click', resetBattle);
            document.getElementById('btn-clear-queue').addEventListener('click', clearQueue);
            
            // Win modal
            document.getElementById('btn-next-battle').addEventListener('click', returnToQueue);
            document.getElementById('btn-rematch').addEventListener('click', startRematch);
            
            // V·∫≠n h√†nh th·ª≠
            document.getElementById('btn-test-player1').addEventListener('click', () => addTestPlayer('M√®o Con'));
            document.getElementById('btn-test-player2').addEventListener('click', () => addTestPlayer('C√∫n Con'));
            document.getElementById('btn-test-spectator').addEventListener('click', () => addTestPlayer('Kh√°n Gi·∫£ ' + Math.floor(Math.random() * 100)));
            document.getElementById('btn-test-battle').addEventListener('click', createTestBattle);
            
            // Online/offline detection
            window.addEventListener('online', () => updateConnectionStatus());
            window.addEventListener('offline', () => updateConnectionStatus());
        }

        // =================== X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ===================
        function handleLogin() {
            const nameInput = document.getElementById('login-name-input');
            const name = nameInput.value.trim();
            const errorEl = document.getElementById('name-error');
            
            // Validation
            if (!validateName(name)) {
                errorEl.textContent = "T√™n ph·∫£i c√≥ 2-15 k√Ω t·ª±, kh√¥ng ch·ª©a k√Ω t·ª± ƒë·∫∑c bi·ªát";
                errorEl.classList.remove('hidden');
                shakeElement(nameInput);
                return;
            }
            
            if (appState.queue.includes(name)) {
                errorEl.textContent = "T√™n n√†y ƒë√£ c√≥ trong ph√≤ng ch·ªù";
                errorEl.classList.remove('hidden');
                shakeElement(nameInput);
                return;
            }
            
            if (appState.queue.length >= MAX_PLAYERS) {
                errorEl.textContent = "Ph√≤ng ch·ªù ƒë√£ ƒë·∫ßy! Vui l√≤ng ch·ªù";
                errorEl.classList.remove('hidden');
                return;
            }
            
            // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
            myName = name;
            appState.queue.push(name);
            errorEl.classList.add('hidden');
            
            // ·∫®n modal, l∆∞u v√† c·∫≠p nh·∫≠t UI
            document.getElementById('login-modal').classList.add('hidden');
            saveToLocalStorage();
            updateUI();
            
            // Ph·∫£n h·ªìi √¢m thanh
            playSuccessSound();
            speakVietnamese(`Ch√†o ${name}, s·∫µn s√†ng ƒë·∫°i chi·∫øn!`);
        }

        function validateName(name) {
            if (name.length < 2 || name.length > 15) return false;
            if (/[<>{};]/.test(name)) return false; // Ch·ªëng XSS c∆° b·∫£n
            return true;
        }

        // =================== X·ª¨ L√ù TR·∫¨N ƒê·∫§U ===================
        function matchRandomPlayers() {
            if (appState.queue.length < 2) {
                showToast("C·∫ßn √≠t nh·∫•t 2 b·∫°n trong ph√≤ng ch·ªù!", "warning");
                return;
            }
            
            const btn = document.getElementById('btn-match-random');
            btn.disabled = true;
            btn.innerHTML = 'üé≤ ƒêang gh√©p...';
            
            // Random v√† ch·ªçn 2 ng∆∞·ªùi
            const shuffled = [...appState.queue].sort(() => Math.random() - 0.5);
            const p1 = shuffled[0];
            const p2 = shuffled[1];
            
            // C·∫≠p nh·∫≠t queue
            appState.queue = appState.queue.filter(p => p !== p1 && p !== p2);
            
            // T·∫°o tr·∫≠n ƒë·∫•u
            createNewBattle(p1, p2);
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = 'üé≤ Gh√©p c·∫∑p ng·∫´u nhi√™n';
            }, 1000);
        }

        function createNewBattle(p1, p2) {
            // Reset tr·∫°ng th√°i
            appState.battleActive = true;
            appState.p1 = { name: p1, progress: 1, score: 0 };
            appState.p2 = { name: p2, progress: 1, score: 0 };
            appState.winner = "";
            appState.timer = BATTLE_TIME_LIMIT;
            appState.battleStartTime = Date.now();
            
            // T·∫°o m√™ cung
            const { pathIndices, cells } = generateMaze();
            appState.pathIndices = pathIndices;
            appState.cellsData = JSON.stringify(cells);
            
            // Kh·ªüi ƒë·ªông timer
            startBattleTimer();
            
            // C·∫≠p nh·∫≠t UI
            updateUI();
            saveToLocalStorage();
            
            // Th√¥ng b√°o
            showToast(`Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu: ${p1} vs ${p2}`, "success");
            speakVietnamese(`Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu! ${p1} v√† ${p2} s·∫µn s√†ng!`);
        }

        function generateMaze() {
            const gridSize = 5;
            const totalCells = gridSize * gridSize;
            
            // T·∫°o ƒë∆∞·ªùng ƒëi t·ª´ 1 ƒë·∫øn 10
            const path = [Math.floor(Math.random() * totalCells)];
            
            while (path.length < 10) {
                const current = path[path.length - 1];
                const neighbors = getNeighbors(current, gridSize);
                const validNeighbors = neighbors.filter(n => !path.includes(n));
                
                if (validNeighbors.length === 0) {
                    // Backtrack n·∫øu b√≠
                    path.pop();
                    continue;
                }
                
                // Ch·ªçn neighbor ng·∫´u nhi√™n
                const next = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
                path.push(next);
            }
            
            // T·∫°o cells data
            const cells = new Array(totalCells).fill(null).map((_, i) => {
                const pathIndex = path.indexOf(i);
                if (pathIndex !== -1) {
                    return { ...numberData[pathIndex], isPath: true };
                } else {
                    // S·ªë ng·∫´u nhi√™n kh√¥ng n·∫±m trong ƒë∆∞·ªùng ƒëi
                    const randomNum = Math.floor(Math.random() * 10);
                    return { ...numberData[randomNum], isPath: false };
                }
            });
            
            return { pathIndices: path, cells };
        }

        function getNeighbors(index, gridSize) {
            const row = Math.floor(index / gridSize);
            const col = index % gridSize;
            const neighbors = [];
            
            if (row > 0) neighbors.push(index - gridSize); // L√™n
            if (row < gridSize - 1) neighbors.push(index + gridSize); // Xu·ªëng
            if (col > 0) neighbors.push(index - 1); // Tr√°i
            if (col < gridSize - 1) neighbors.push(index + 1); // Ph·∫£i
            
            return neighbors;
        }

        // =================== X·ª¨ L√ù CLICK √î ===================
        function handleCellClick(index) {
            if (!appState.battleActive || appState.winner) return;
            
            const isP1 = myName === appState.p1.name;
            const isP2 = myName === appState.p2.name;
            if (!isP1 && !isP2) return;
            
            const player = isP1 ? appState.p1 : appState.p2;
            const expectedIndex = appState.pathIndices[player.progress - 1];
            const cell = JSON.parse(appState.cellsData)[index];
            
            const cellElement = document.querySelector(`[data-index="${index}"]`);
            
            if (index === expectedIndex) {
                // ƒê√öNG: C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
                if (isP1) {
                    appState.p1.progress++;
                    appState.p1.score += calculateScore();
                } else {
                    appState.p2.progress++;
                    appState.p2.score += calculateScore();
                }
                
                // Hi·ªáu ·ª©ng visual
                cellElement.classList.add('pop');
                playSuccessSound();
                
                // Ph√°t √¢m thanh
                if (player.progress <= 10) {
                    speakChinese(numberData[player.progress - 2].hanzi);
                }
                
                // Ki·ªÉm tra chi·∫øn th·∫Øng
                if (player.progress > 10) {
                    appState.winner = player.name;
                    endBattle();
                    showWinner(player.name);
                }
                
                // C·∫≠p nh·∫≠t UI
                updateUI();
                saveToLocalStorage();
                
            } else {
                // SAI: Hi·ªáu ·ª©ng rung
                cellElement.classList.add('shake');
                playErrorSound();
                setTimeout(() => cellElement.classList.remove('shake'), 500);
                
                // Tr·ª´ ƒëi·ªÉm
                if (isP1 && appState.p1.score > 0) appState.p1.score -= 5;
                if (isP2 && appState.p2.score > 0) appState.p2.score -= 5;
            }
        }

        function calculateScore() {
            // ƒêi·ªÉm d·ª±a tr√™n th·ªùi gian c√≤n l·∫°i
            const timeLeft = appState.timer;
            const baseScore = 100;
            const timeBonus = Math.floor(timeLeft / 10);
            return baseScore + timeBonus;
        }

        // =================== TIMER FUNCTIONS ===================
        function startBattleTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (appState.battleActive && !appState.winner) {
                    appState.timer--;
                    
                    if (appState.timer <= 0) {
                        endBattleByTime();
                    }
                    
                    updateTimerDisplay();
                    saveToLocalStorage();
                }
            }, 1000);
        }

        function endBattleByTime() {
            clearInterval(timerInterval);
            appState.battleActive = false;
            
            // Ai c√≥ progress cao h∆°n th·∫Øng
            if (appState.p1.progress > appState.p2.progress) {
                appState.winner = appState.p1.name;
            } else if (appState.p2.progress > appState.p1.progress) {
                appState.winner = appState.p2.name;
            } else {
                // H√≤a - ai c√≥ ƒëi·ªÉm cao h∆°n
                if (appState.p1.score > appState.p2.score) {
                    appState.winner = appState.p1.name;
                } else {
                    appState.winner = appState.p2.name;
                }
            }
            
            showWinner(appState.winner);
            updateUI();
            showToast("H·∫øt gi·ªù! Tr·∫≠n ƒë·∫•u k·∫øt th√∫c", "info");
        }

        function endBattle() {
            clearInterval(timerInterval);
            appState.battleActive = false;
            saveToLocalStorage();
        }

        // =================== UI UPDATES ===================
        function updateUI() {
            // C·∫≠p nh·∫≠t queue
            updateQueueUI();
            
            // C·∫≠p nh·∫≠t battle panel
            if (appState.battleActive) {
                document.getElementById('battle-panel').classList.remove('hidden');
                document.getElementById('p1-name').textContent = appState.p1.name;
                document.getElementById('p2-name').textContent = appState.p2.name;
                document.getElementById('p1-score').textContent = appState.p1.score;
                document.getElementById('p2-score').textContent = appState.p2.score;
                
                // Progress bars
                document.getElementById('p1-progress-bar').style.width = `${(appState.p1.progress - 1) * 10}%`;
                document.getElementById('p2-progress-bar').style.width = `${(appState.p2.progress - 1) * 10}%`;
                
                // Highlight active player
                document.getElementById('p1-info').className = `text-center p-3 rounded-2xl transition-all border-2 ${myName === appState.p1.name ? 'bg-yellow-50 border-yellow-400' : 'border-transparent'}`;
                document.getElementById('p2-info').className = `text-center p-3 rounded-2xl transition-all border-2 ${myName === appState.p2.name ? 'bg-pink-50 border-pink-400' : 'border-transparent'}`;
                
                // Render grid n·∫øu ch∆∞a c√≥
                if (!document.querySelector('.grid-cell')) {
                    renderGrid();
                }
                
                // Sync chickens
                syncChickens();
                
                // Target display
                updateTargetDisplay();
                
                // Spectator mode
                const isSpectator = !(myName === appState.p1.name || myName === appState.p2.name);
                document.getElementById('spectator-overlay').classList.toggle('hidden', !isSpectator);
                
            } else {
                document.getElementById('battle-panel').classList.add('hidden');
                document.getElementById('spectator-overlay').classList.remove('hidden');
                
                // Hi·ªÉn th·ªã grid tr·ªëng
                const gridEl = document.getElementById('game-grid');
                if (gridEl) {
                    gridEl.innerHTML = '<div class="col-span-5 py-10 text-center"><div class="text-5xl mb-4">üèÆ</div><p class="font-bold text-gray-300 uppercase italic">ƒêang ch·ªù gh√©p tr·∫≠n...</p></div>';
                }
            }
            
            // Update button states
            document.getElementById('btn-match-random').disabled = appState.queue.length < 2;
            document.getElementById('btn-reset-battle').disabled = !appState.battleActive;
            document.getElementById('btn-clear-queue').disabled = appState.queue.length === 0;
            
            // Update queue count
            document.getElementById('queue-count').textContent = appState.queue.length;
        }

        function updateQueueUI() {
            const listEl = document.getElementById('queue-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            
            if (appState.queue.length === 0) {
                listEl.innerHTML = '<div class="text-center py-8 text-gray-400"><div class="text-3xl mb-2">üò¥</div><p class="text-sm">Ch∆∞a c√≥ ai trong ph√≤ng ch·ªù</p></div>';
                return;
            }
            
            appState.queue.forEach((name, i) => {
                const div = document.createElement('div');
                const isMe = name === myName;
                div.className = `flex items-center gap-3 p-3 rounded-2xl border-2 transition-all ${isMe ? 'border-green-500 bg-green-50 shadow-sm' : 'border-gray-50 bg-gray-50'}`;
                div.innerHTML = `
                    <span class="w-8 h-8 flex items-center justify-center rounded-full ${isMe ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'} text-xs font-black">${i+1}</span>
                    <div class="flex-grow">
                        <span class="font-black text-sm text-gray-700">${name}</span>
                        ${isMe ? '<div class="text-[10px] text-green-600 font-bold uppercase">B·∫°n</div>' : ''}
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        function renderGrid() {
            const gridEl = document.getElementById('game-grid');
            if (!gridEl || !appState.cellsData) return;
            
            gridEl.innerHTML = '';
            const cells = JSON.parse(appState.cellsData);
            
            cells.forEach((cell, index) => {
                const div = document.createElement('div');
                div.className = 'grid-cell border-2 border-gray-100 flex flex-col items-center justify-center relative';
                div.dataset.index = index;
                
                // Mark start and exit
                if (cell.val === 1 && appState.pathIndices[0] === index) {
                    div.innerHTML += `<div class="label-marker start-label">üö™ V√†o</div>`;
                    div.classList.add('border-red-400', 'bg-red-50');
                }
                if (cell.val === 10 && appState.pathIndices[9] === index) {
                    div.innerHTML += `<div class="label-marker exit-label">üèÅ ƒê√≠ch</div>`;
                    div.classList.add('border-green-400', 'bg-green-50');
                }
                
                // Cell content
                div.innerHTML += `<span class="pinyin">${cell.pinyin}</span><span class="hanzi">${cell.hanzi}</span>`;
                
                // Click handler
                div.addEventListener('click', () => handleCellClick(index));
                
                gridEl.appendChild(div);
            });
            
            // Highlight path
            highlightPath();
        }

        function highlightPath() {
            const cells = document.querySelectorAll('.grid-cell');
            cells.forEach((cell, idx) => {
                const pathOrder = appState.pathIndices.indexOf(idx);
                cell.classList.remove('correct-p1', 'correct-p2');
                
                if (pathOrder !== -1) {
                    if (pathOrder < appState.p1.progress - 1) {
                        cell.classList.add('correct-p1');
                    }
                    if (pathOrder < appState.p2.progress - 1) {
                        cell.classList.add('correct-p2');
                    }
                }
            });
        }

        function syncChickens() {
            // Remove existing chickens
            document.querySelectorAll('.chicken-p1, .chicken-p2').forEach(c => c.remove());
            
            // Add P1 chicken
            const p1Idx = appState.pathIndices[appState.p1.progress - 2];
            if (p1Idx !== undefined && p1Idx >= 0) {
                const cell = document.querySelector(`[data-index="${p1Idx}"]`);
                if (cell) cell.innerHTML += `<div class="chicken-p1">üê•</div>`;
            }
            
            // Add P2 chicken
            const p2Idx = appState.pathIndices[appState.p2.progress - 2];
            if (p2Idx !== undefined && p2Idx >= 0) {
                const cell = document.querySelector(`[data-index="${p2Idx}"]`);
                if (cell) cell.innerHTML += `<div class="chicken-p2">üéÄ</div>`;
            }
        }

        function updateTargetDisplay() {
            const targetEl = document.getElementById('target-display');
            if (!targetEl) return;
            
            const isP1 = myName === appState.p1.name;
            const isP2 = myName === appState.p2.name;
            
            if (isP1 || isP2) {
                const player = isP1 ? appState.p1 : appState.p2;
                if (player.progress <= 10) {
                    const info = numberData[player.progress - 1];
                    targetEl.textContent = `${info.hanzi} (${info.pinyin})`;
                } else {
                    targetEl.textContent = "üèÅ ƒê√£ v·ªÅ ƒë√≠ch!";
                }
            } else {
                targetEl.textContent = "üëÄ ƒêang ƒë·∫•u...";
            }
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.textContent = appState.timer;
                
                // ƒê·ªïi m√†u khi th·ªùi gian s·∫Øp h·∫øt
                if (appState.timer <= 30) {
                    timerEl.parentElement.classList.add('text-red-600', 'bg-red-50');
                } else if (appState.timer <= 60) {
                    timerEl.parentElement.classList.add('text-amber-600', 'bg-amber-50');
                }
            }
        }

        // =================== WIN/LOSE HANDLING ===================
        function showWinner(winner) {
            const modal = document.getElementById('win-modal');
            const title = document.getElementById('win-title');
            const icon = document.getElementById('win-icon');
            const nameDisplay = document.getElementById('winner-name-display');
            
            nameDisplay.textContent = winner;
            
            if (winner === myName) {
                title.textContent = "B·∫†N ƒê√É TH·∫ÆNG! üèÜ";
                icon.textContent = "üèÜ";
                speakVietnamese("Ch√∫c m·ª´ng chi·∫øn th·∫Øng! B·∫°n qu√° gi·ªèi!");
                playVictorySound();
            } else {
                title.textContent = "TR·∫¨N ƒê·∫§U K·∫æT TH√öC";
                icon.textContent = "üëè";
                speakVietnamese(`Ch√∫c m·ª´ng ${winner} ƒë√£ chi·∫øn th·∫Øng!`);
                playApplauseSound();
            }
            
            // Hi·ªÉn th·ªã ƒëi·ªÉm
            document.getElementById('p1-final-score').textContent = appState.p1.score;
            document.getElementById('p2-final-score').textContent = appState.p2.score;
            
            modal.classList.remove('hidden');
        }

        function returnToQueue() {
            // ƒê∆∞a ng∆∞·ªùi ch∆°i tr·ªü l·∫°i ph√≤ng ch·ªù (n·∫øu kh√¥ng ph·∫£i test player)
            if (appState.p1.name && !appState.p1.name.includes('Test') && !appState.queue.includes(appState.p1.name)) {
                appState.queue.push(appState.p1.name);
            }
            if (appState.p2.name && !appState.p2.name.includes('Test') && !appState.queue.includes(appState.p2.name)) {
                appState.queue.push(appState.p2.name);
            }
            
            // Reset battle
            appState.battleActive = false;
            appState.winner = "";
            
            // ·∫®n modal
            document.getElementById('win-modal').classList.add('hidden');
            
            // C·∫≠p nh·∫≠t UI
            updateUI();
            saveToLocalStorage();
            
            showToast("ƒê√£ tr·ªü v·ªÅ ph√≤ng ch·ªù", "info");
        }

        function startRematch() {
            if (!appState.p1.name || !appState.p2.name) return;
            
            // T·∫°o tr·∫≠n ƒë·∫•u m·ªõi v·ªõi c√πng ƒë·ªôi
            createNewBattle(appState.p1.name, appState.p2.name);
            
            // ·∫®n modal
            document.getElementById('win-modal').classList.add('hidden');
            
            showToast("Tr·∫≠n ƒë·∫•u m·ªõi b·∫Øt ƒë·∫ßu!", "success");
        }

        // =================== UTILITY FUNCTIONS ===================
        function resetBattle() {
            if (!appState.battleActive) return;
            
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy tr·∫≠n ƒë·∫•u hi·ªán t·∫°i?")) {
                // ƒê∆∞a ng∆∞·ªùi ch∆°i tr·ªü l·∫°i queue
                if (appState.p1.name && !appState.queue.includes(appState.p1.name)) {
                    appState.queue.push(appState.p1.name);
                }
                if (appState.p2.name && !appState.queue.includes(appState.p2.name)) {
                    appState.queue.push(appState.p2.name);
                }
                
                // Reset state
                appState.battleActive = false;
                appState.winner = "";
                clearInterval(timerInterval);
                
                // C·∫≠p nh·∫≠t UI
                updateUI();
                saveToLocalStorage();
                
                showToast("Tr·∫≠n ƒë·∫•u ƒë√£ b·ªã h·ªßy", "warning");
            }
        }

        function clearQueue() {
            if (appState.queue.length === 0) return;
            
            if (confirm(`X√≥a t·∫•t c·∫£ ${appState.queue.length} ng∆∞·ªùi trong ph√≤ng ch·ªù?`)) {
                appState.queue = [];
                updateUI();
                saveToLocalStorage();
                showToast("ƒê√£ x√≥a ph√≤ng ch·ªù", "warning");
            }
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const indicator = document.getElementById('connection-indicator');
            const message = document.getElementById('connection-message');
            
            if (navigator.onLine) {
                indicator.className = 'connection-dot connection-good';
                message.textContent = 'ƒê√£ k·∫øt n·ªëi (Ch·∫ø ƒë·ªô c·ª•c b·ªô)';
                statusEl.classList.remove('hidden');
                appState.connectionStatus = "connected";
            } else {
                indicator.className = 'connection-dot connection-bad';
                message.textContent = 'M·∫•t k·∫øt n·ªëi (ƒêang d√πng offline)';
                statusEl.classList.remove('hidden');
                appState.connectionStatus = "disconnected";
            }
        }

        // =================== V·∫¨N H√ÄNH TH·ª¨ ===================
        function addTestPlayer(name) {
            if (appState.queue.includes(name)) {
                showToast("T√™n test ƒë√£ t·ªìn t·∫°i", "warning");
                return;
            }
            
            if (appState.queue.length >= MAX_PLAYERS) {
                showToast("Ph√≤ng ch·ªù ƒë√£ ƒë·∫ßy", "warning");
                return;
            }
            
            appState.queue.push(name);
            updateUI();
            saveToLocalStorage();
            
            showToast(`ƒê√£ th√™m ${name} v√†o ph√≤ng ch·ªù`, "success");
            playSuccessSound();
        }

        function createTestBattle() {
            if (appState.queue.length < 2) {
                // T·ª± ƒë·ªông th√™m test players n·∫øu c·∫ßn
                if (!appState.queue.includes('M√®o Con')) addTestPlayer('M√®o Con');
                if (!appState.queue.includes('C√∫n Con')) addTestPlayer('C√∫n Con');
            }
            
            if (appState.queue.length >= 2) {
                matchRandomPlayers();
                isSimulationMode = true;
            }
        }

        // =================== AUDIO FUNCTIONS ===================
        function playSuccessSound() {
            playTone(800, 'sine', 0.2);
        }

        function playErrorSound() {
            playTone(300, 'sawtooth', 0.1);
        }

        function playVictorySound() {
            // Chu·ªói √¢m thanh chi·∫øn th·∫Øng
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            notes.forEach((freq, i) => {
                setTimeout(() => playTone(freq, 'sine', 0.3), i * 200);
            });
        }

        function playApplauseSound() {
            // √Çm thanh v·ªó tay m√¥ ph·ªèng
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    playTone(1000 + Math.random() * 500, 'square', 0.05);
                }, i * 100);
            }
        }

        function playTone(frequency, type = 'sine', duration = 0.3) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Audio kh√¥ng kh·∫£ d·ª•ng");
            }
        }

        function speakChinese(text) {
            if (!window.speechSynthesis) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        function speakVietnamese(text) {
            if (!window.speechSynthesis) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        // =================== UI HELPERS ===================
        function showToast(message, type = "info") {
            // T·∫°o toast element
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-xl shadow-xl text-white font-bold text-sm transition-all transform translate-x-full ${type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-amber-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Hi·ªáu ·ª©ng xu·∫•t hi·ªán
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            
            // T·ª± ƒë·ªông ·∫©n sau 3s
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function shakeElement(element) {
            element.classList.add('shake');
            setTimeout(() => element.classList.remove('shake'), 500);
        }

        function updateDebugInfo() {
            document.getElementById('debug-state').textContent = appState.battleActive ? 'BATTLE' : 'LOBBY';
            document.getElementById('debug-players').textContent = appState.queue.length;
        }

        // =================== LOCAL STORAGE ===================
        function saveToLocalStorage() {
            try {
                const saveData = {
                    appState: appState,
                    myName: myName,
                    timestamp: Date.now()
                };
                localStorage.setItem(APP_ID, JSON.stringify(saveData));
            } catch (e) {
                console.error("Kh√¥ng th·ªÉ l∆∞u v√†o localStorage:", e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(APP_ID);
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Ch·ªâ load n·∫øu data kh√¥ng qu√° c≈© (1 gi·ªù)
                    if (Date.now() - data.timestamp < 3600000) {
                        appState = data.appState || appState;
                        myName = data.myName || "";
                    }
                }
            } catch (e) {
                console.error("Kh√¥ng th·ªÉ load t·ª´ localStorage:", e);
            }
        }

        // =================== EXPORT FOR TESTING ===================
        window.app = {
            state: appState,
            getMyName: () => myName,
            resetApp: () => {
                appState = {
                    queue: [],
                    battleActive: false,
                    p1: { name: "", progress: 1, score: 0 },
                    p2: { name: "", progress: 1, score: 0 },
                    winner: "",
                    pathIndices: [],
                    cellsData: "",
                    timer: BATTLE_TIME_LIMIT,
                    battleStartTime: null,
                    connectionStatus: "disconnected"
                };
                myName = "";
                clearInterval(timerInterval);
                updateUI();
                saveToLocalStorage();
                showToast("ƒê√£ reset ·ª©ng d·ª•ng", "info");
            }
        };
    </script>
</body>
</html>
