import React, { useState, useEffect, useRef } from 'react';
import { Printer, Plus, Trash2, RefreshCw, FileText, Image as ImageIcon, X, Star } from 'lucide-react';

/* --- Utility Components --- */

// Component resize textarea t·ª± ƒë·ªông (ƒê√£ s·ª≠a l·ªói null value)
const TextAreaAutoResize = ({ value, onChange, className, placeholder, style, label }) => {
  const textareaRef = useRef(null);

  useEffect(() => {
    if (textareaRef.current) {
      // Reset height to auto to get the correct scrollHeight
      textareaRef.current.style.height = 'auto';
      // Set new height based on content
      textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
    }
  }, [value]);

  return (
    <div className="w-full relative">
       {label && <label className="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">{label}</label>}
      <textarea
        ref={textareaRef}
        // Fix: ƒê·∫£m b·∫£o value lu√¥n l√† chu·ªói, tr√°nh l·ªói uncontrolled input
        value={value || ""}
        onChange={onChange}
        className={`w-full bg-transparent resize-none overflow-hidden focus:outline-none focus:bg-blue-50/50 rounded transition-colors ${className}`}
        placeholder={placeholder}
        style={style}
        rows={1}
      />
    </div>
  );
};

// Component x·ª≠ l√Ω h√¨nh ·∫£nh
const ImageUploader = ({ image, onImageChange, label = "Ch√®n ·∫£nh minh h·ªça" }) => {
  const fileInputRef = useRef(null);

  const handleFileChange = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 1024 * 1024 * 2) {
        alert("Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 2MB ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô.");
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        onImageChange(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  return (
    <div className="mt-2 mb-2 print:mt-1 print:mb-1">
      {!image ? (
        <button 
          onClick={() => fileInputRef.current?.click()}
          className="flex items-center gap-1 text-xs text-blue-500 hover:text-blue-700 transition print:hidden bg-blue-50 px-3 py-2 rounded border border-blue-100"
          type="button"
        >
          <ImageIcon size={14} /> {label}
        </button>
      ) : (
        <div className="relative group inline-block max-w-full">
          <img src={image} alt="Minh h·ªça" className="max-h-48 rounded shadow-sm border border-gray-200 object-contain" />
          <button 
            onClick={() => onImageChange(null)}
            className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition print:hidden shadow-md"
            title="X√≥a ·∫£nh"
            type="button"
          >
            <X size={12} />
          </button>
        </div>
      )}
      <input 
        type="file" 
        ref={fileInputRef} 
        onChange={handleFileChange} 
        accept="image/*" 
        className="hidden" 
      />
    </div>
  );
};

// Component ƒê√°nh gi√° sao
const StarRating = ({ value, onChange, readOnly = false }) => {
  return (
    <div className="flex gap-1">
      {[1, 2, 3, 4, 5].map((star) => (
        <button
          key={star}
          onClick={() => !readOnly && onChange(star)}
          className={`focus:outline-none transition-transform ${!readOnly ? 'hover:scale-110 active:scale-90' : 'cursor-default'}`}
          disabled={readOnly}
          type="button"
        >
          <Star 
            size={24} 
            className={`${star <= value ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'} transition-colors`} 
          />
        </button>
      ))}
    </div>
  );
};

// Component Section
const Section = ({ title, chineseTitle, children, className = "", colorClass = "border-blue-200" }) => (
  <div className={`mb-8 border-l-4 ${colorClass} bg-white shadow-sm rounded-r-lg print:shadow-none print:border-l-2 print:mb-6 print:break-inside-avoid ${className}`}>
    <div className="bg-gradient-to-r from-gray-50 to-white px-4 py-3 border-b border-gray-100 rounded-tr-lg flex items-baseline gap-3 print:bg-transparent print:border-none print:px-4 print:py-0">
      <h3 className="font-bold text-lg text-slate-800 uppercase print:text-black">{title}</h3>
      <span className="text-slate-500 font-medium text-sm print:text-gray-600 font-serif">{chineseTitle}</span>
    </div>
    <div className="p-5 print:p-2 print:pl-4">
      {children}
    </div>
  </div>
);

// Component Danh s√°ch ƒë·ªông
const DynamicSectionList = ({ items, onChange, placeholderTitle, placeholderContent, allowImages = false }) => {
  // Fix: B·∫£o v·ªá tr∆∞·ªùng h·ª£p items b·ªã undefined
  const safeItems = Array.isArray(items) ? items : [];

  const handleChange = (id, field, value) => {
    const newItems = safeItems.map(item => item.id === id ? { ...item, [field]: value } : item);
    onChange(newItems);
  };

  const addItem = () => {
    const newId = safeItems.length > 0 ? Math.max(...safeItems.map(i => i.id)) + 1 : 1;
    onChange([...safeItems, { id: newId, title: "", content: "", image: null }]);
  };

  const removeItem = (id) => {
    if (window.confirm("B·∫°n mu·ªën x√≥a m·ª•c n√†y?")) {
      onChange(safeItems.filter(i => i.id !== id));
    }
  };

  return (
    <div className="space-y-6 print:space-y-4">
      {safeItems.map((item, index) => (
        <div key={item.id} className="relative group border-b border-dashed border-gray-200 last:border-0 pb-4 last:pb-0 print:border-gray-300">
          <div className="flex gap-2 items-start">
            <div className="flex-grow min-w-0">
              <TextAreaAutoResize 
                value={item.title} 
                onChange={(e) => handleChange(item.id, 'title', e.target.value)} 
                className="font-bold text-slate-800 mb-1 w-full"
                placeholder={placeholderTitle || `M·ª•c ${index + 1}...`}
              />
              <TextAreaAutoResize 
                value={item.content} 
                onChange={(e) => handleChange(item.id, 'content', e.target.value)} 
                className="text-gray-700 min-h-[40px]"
                placeholder={placeholderContent || "N·ªôi dung chi ti·∫øt..."}
              />
              {allowImages && (
                <ImageUploader 
                  image={item.image} 
                  onImageChange={(newImg) => handleChange(item.id, 'image', newImg)} 
                />
              )}
            </div>
            <button 
              onClick={() => removeItem(item.id)} 
              className="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100 print:hidden p-2"
              type="button"
            >
              <Trash2 size={18} />
            </button>
          </div>
        </div>
      ))}
      <button 
        onClick={addItem} 
        className="flex items-center gap-2 text-sm text-blue-600 font-medium hover:bg-blue-50 px-4 py-2 rounded-lg transition print:hidden border border-blue-100 shadow-sm justify-center"
        type="button"
      >
        <Plus size={16} /> Th√™m n·ªôi dung
      </button>
    </div>
  );
};

/* --- Main App --- */

const App = () => {
  const initialData = {
    meta: {
      lessonName: "Á¨¨‰∏ÄËØæ ‰Ω†Â•Ω (B√†i 1: Xin ch√†o)",
      teacher: "Gi√°o vi√™n A",
      classInfo: "L·ªõp HSK 1 - K23",
      date: new Date().toLocaleDateString('vi-VN'),
      textbook: "Gi√°o tr√¨nh HSK 1",
      students: "Ng∆∞·ªùi h·ªçc n·ªØ, t·ª´ 18 tu·ªïi tr·ªü l√™n"
    },
    basicInfo: {
      courseType: "H·ªçc HSK + Giao ti·∫øp",
      tools: "PPT, Padlet, Web ng·ªØ √¢m"
    },
    content: [
      { id: 1, title: "1. T·ª´ m·ªõi (ÁîüËØç)", content: "‰Ω†„ÄÅÊàë„ÄÅÊÇ®„ÄÅ‰ªñ„ÄÅÂ•π„ÄÅÂÆÉ„ÄÅ‰ª¨„ÄÅÂ•Ω„ÄÅÂØπ‰∏çËµ∑„ÄÅÊ≤°ÂÖ≥Á≥ª", image: null },
      { id: 2, title: "2. Ng·ªØ ph√°p (ËØ≠Ë®ÄÁÇπ)", content: "-", image: null },
      { id: 3, title: "3. B√†i kh√≥a (ËØæÊñá)", content: "-", image: null }
    ],
    objectives: [
      { id: 1, title: "1. M·ª•c ti√™u nh·∫≠n th·ª©c (ËÆ§Áü•ÁõÆÊ†á)", content: "- N·∫Øm ch·∫Øc ph·∫ßn phi√™n √¢m c∆° b·∫£n, d·∫•u thanh v√† c√°ch bi·∫øn ƒë·ªïi d·∫•u thanh.", image: null },
      { id: 2, title: "2. M·ª•c ti√™u t√¨nh c·∫£m (ÊÉÖÊÑüÁõÆÊ†á)", content: "- Hi·ªÉu v·ªÅ l·ªãch s·ª≠ ch·ªØ vi·∫øt, c√°ch h√¨nh th√†nh ch·ªØ.", image: null }
    ],
    keyPoints: {
      emphasis: "ÊãºÈü≥ (Phi√™n √¢m)",
      difficulty: "Ph·ª• √¢m: j, q, x\nD·∫•u thanh: 1, 2, 3, 4"
    },
    creative: [
      { id: 1, title: "üí° √ù t∆∞·ªüng m·ªü r·ªông", content: "S·ª≠ d·ª•ng Flashcard m√†u s·∫Øc ƒë·ªÉ ch∆°i tr√≤ ch∆°i gh√©p t·ª´.", image: null }
    ],
    process: [
      {
        id: 1,
        time: "5p",
        step: "1. ·ªîn ƒë·ªãnh l·ªõp",
        content: "Ch√†o h·ªèi & Quy t·∫Øc",
        teacherAct: "Gi√°o vi√™n v√†ÂêåÂ≠¶‰ª¨ h·ªèi thƒÉm, tuy√™n b·ªë b·∫Øt ƒë·∫ßu.",
        studentAct: "L·∫Øng nghe, ghi nh·ªõ.",
        purpose: "Thu h√∫t s·ª± ch√∫ √Ω.",
        image: null
      },
      {
        id: 2,
        time: "20p",
        step: "2. B√†i m·ªõi: Phi√™n √¢m",
        content: "Thanh m·∫´u & V·∫≠n m·∫´u",
        teacherAct: "Gi·∫£i th√≠ch thanh m·∫´u (b,p,m,f...). ƒê·ªçc m·∫´u.",
        studentAct: "L·∫Øng nghe v√† nh·∫°i l·∫°i.",
        purpose: "N·∫Øm v·ªØng ph√°t √¢m.",
        image: null
      }
    ],
    reflection: {
      situation: "C√°c b·∫°n n·∫Øm b√†i t·ªët nh∆∞ng ph·∫ßn gh√©p √¢m h∆°i nhanh.",
      situationImage: null,
      solution: "D·∫°y ch·∫≠m l·∫°i, b·ªï sung th√™m b√†i t·∫≠p th·ª±c h√†nh.",
      solutionImage: null
    },
    ratings: [
      { id: 1, label: "Th√°i ƒë·ªô h·ªçc sinh", stars: 4 },
      { id: 2, label: "M·ª©c ƒë·ªô t∆∞∆°ng t√°c", stars: 5 },
      { id: 3, label: "M·ª©c ƒë·ªô hi·ªÉu b√†i", stars: 4 },
      { id: 4, label: "K·ª∑ lu·∫≠t l·ªõp h·ªçc", stars: 5 }
    ],
    footer: {
      signatureTitle: "Gi√°o vi√™n k√Ω t√™n",
      signerName: "Gi√°o vi√™n A"
    }
  };

  const [data, setData] = useState(initialData);

  // Load local storage an to√†n
  useEffect(() => {
    try {
      const saved = localStorage.getItem('lessonPlanData_v3');
      if (saved) {
        const parsed = JSON.parse(saved);
        setData(prev => ({ 
          ...prev, 
          ...parsed,
          ratings: Array.isArray(parsed.ratings) ? parsed.ratings : initialData.ratings,
          footer: parsed.footer || initialData.footer 
        }));
      }
    } catch (e) {
      console.error("L·ªói khi t·∫£i d·ªØ li·ªáu c≈©, s·∫Ω d√πng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh:", e);
    }
  }, []);

  // Save local storage
  useEffect(() => {
    localStorage.setItem('lessonPlanData_v3', JSON.stringify(data));
  }, [data]);

  const handleChange = (section, field, value) => {
    setData(prev => {
      const sectionData = prev[section] ? { ...prev[section] } : {};
      sectionData[field] = value;
      return { ...prev, [section]: sectionData };
    });
  };

  const handleListChange = (section, newItems) => {
    setData(prev => ({ ...prev, [section]: newItems }));
  };

  const handleProcessChange = (id, field, value) => {
    const newProcess = data.process.map(row => row.id === id ? { ...row, [field]: value } : row);
    setData(prev => ({ ...prev, process: newProcess }));
  };
  
  const addProcessStep = () => {
    const newId = data.process.length > 0 ? Math.max(...data.process.map(p => p.id)) + 1 : 1;
    setData(prev => ({
      ...prev,
      process: [...prev.process, { id: newId, time: "", step: "", content: "", teacherAct: "", studentAct: "", purpose: "", image: null }]
    }));
  };

  const removeProcessStep = (id) => {
    if (window.confirm("X√≥a b∆∞·ªõc n√†y?")) {
      setData(prev => ({ ...prev, process: prev.process.filter(p => p.id !== id) }));
    }
  };

  const handleRatingChange = (id, field, value) => {
    const safeRatings = Array.isArray(data.ratings) ? data.ratings : [];
    const newRatings = safeRatings.map(r => r.id === id ? { ...r, [field]: value } : r);
    setData(prev => ({ ...prev, ratings: newRatings }));
  };

  const addRating = () => {
    const safeRatings = Array.isArray(data.ratings) ? data.ratings : [];
    const newId = safeRatings.length > 0 ? Math.max(...safeRatings.map(r => r.id)) + 1 : 1;
    setData(prev => ({ ...prev, ratings: [...safeRatings, { id: newId, label: "", stars: 0 }] }));
  };

  const removeRating = (id) => {
    const safeRatings = Array.isArray(data.ratings) ? data.ratings : [];
    setData(prev => ({ ...prev, ratings: safeRatings.filter(r => r.id !== id) }));
  };

  const handleReset = () => {
    if (window.confirm("ƒê·∫∑t l·∫°i v·ªÅ b√†i m·∫´u m·∫∑c ƒë·ªãnh? D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω m·∫•t.")) {
      setData(initialData);
    }
  };

  return (
    <div className="min-h-screen bg-slate-100 pb-10 font-sans text-slate-800 print:bg-white print:pb-0 print:text-black">
      
      {/* Toolbar */}
      <div className="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-gray-200 px-4 py-3 mb-6 print:hidden shadow-sm">
        <div className="max-w-5xl mx-auto flex flex-wrap justify-between items-center gap-2">
          <div className="flex items-center gap-2 text-blue-700 font-bold text-lg md:text-xl truncate">
            <FileText size={24} className="flex-shrink-0" />
            <span className="truncate">Gi√°o √Ån 3.0</span>
          </div>
          
          <div className="flex gap-2">
            <button onClick={handleReset} className="flex items-center gap-1 sm:gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded transition font-medium border border-red-100 sm:border-transparent">
              <RefreshCw size={16} /> <span className="hidden sm:inline">ƒê·∫∑t l·∫°i</span>
            </button>
            <button onClick={() => window.print()} className="flex items-center gap-1 sm:gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full hover:shadow-lg transition font-medium transform active:scale-95 text-sm sm:text-base">
              <Printer size={18} /> Xu·∫•t PDF
            </button>
          </div>
        </div>
      </div>

      {/* Paper Container */}
      <div className="max-w-5xl mx-auto bg-white p-6 md:p-14 shadow-xl min-h-screen print:shadow-none print:p-0 print:max-w-none">
        
        {/* Header */}
        <div className="text-center mb-10 border-b-2 border-double border-gray-300 pb-8 print:border-black">
          <TextAreaAutoResize
            value={data.meta.lessonName}
            onChange={(e) => handleChange('meta', 'lessonName', e.target.value)}
            className="w-full text-3xl md:text-4xl font-extrabold text-center text-blue-900 mb-4 font-serif print:text-black"
            placeholder="T√äN B√ÄI H·ªåC"
          />
          <div className="flex flex-wrap justify-center gap-x-8 gap-y-3 text-gray-600 mt-4 print:text-black">
            {[
              { label: "Gi√°o vi√™n", val: data.meta.teacher, key: "teacher" },
              { label: "L·ªõp", val: data.meta.classInfo, key: "classInfo" },
              { label: "Ng√†y", val: data.meta.date, key: "date" }
            ].map((item, idx) => (
              <div key={idx} className="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded print:bg-transparent print:p-0">
                <span className="font-bold text-sm uppercase tracking-wider">{item.label}:</span>
                <input 
                  value={item.val || ""} 
                  onChange={(e) => handleChange('meta', item.key, e.target.value)}
                  className="bg-transparent border-b border-dashed border-gray-400 focus:border-blue-500 outline-none text-center font-medium w-auto min-w-[100px]" 
                />
              </div>
            ))}
          </div>
        </div>

        {/* General Info */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 print:gap-6">
          <Section title="I. Lo·∫°i h√¨nh l·ªõp h·ªçc" chineseTitle="ËØæÂûã" colorClass="border-indigo-400">
            <TextAreaAutoResize value={data.basicInfo.courseType} onChange={(e) => handleChange('basicInfo', 'courseType', e.target.value)} />
          </Section>
          <Section title="II. ƒê·ªëi t∆∞·ª£ng" chineseTitle="ÊïôÂ≠¶ÂØπË±°" colorClass="border-indigo-400">
            <TextAreaAutoResize value={data.meta.students} onChange={(e) => handleChange('meta', 'students', e.target.value)} />
          </Section>
          <Section title="III. Gi√°o tr√¨nh" chineseTitle="‰ΩøÁî®ÊïôÊùê" colorClass="border-indigo-400">
            <TextAreaAutoResize value={data.meta.textbook} onChange={(e) => handleChange('meta', 'textbook', e.target.value)} />
          </Section>
           <Section title="IV. C√¥ng c·ª• d·∫°y h·ªçc" chineseTitle="ÊïôÂ≠¶Â∑•ÂÖ∑" colorClass="border-indigo-400">
            <TextAreaAutoResize value={data.basicInfo.tools} onChange={(e) => handleChange('basicInfo', 'tools', e.target.value)} />
          </Section>
        </div>

        {/* Content & Objectives */}
        <Section title="V. N·ªôi dung gi·∫£ng d·∫°y" chineseTitle="ÊïôÂ≠¶ÂÜÖÂÆπ" colorClass="border-teal-500">
          <DynamicSectionList 
            items={data.content} 
            onChange={(items) => handleListChange('content', items)}
            placeholderTitle="T√™n m·ª•c (VD: 1. T·ª´ v·ª±ng)"
            allowImages={false} 
          />
        </Section>

        <Section title="VI. M·ª•c ti√™u d·∫°y h·ªçc" chineseTitle="ÊïôÂ≠¶ÁõÆÊ†á" colorClass="border-teal-500">
          <DynamicSectionList 
            items={data.objectives} 
            onChange={(items) => handleListChange('objectives', items)}
            placeholderTitle="T√™n m·ª•c ti√™u"
            allowImages={false} 
          />
        </Section>

        {/* Key Points */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div className="border border-red-100 bg-red-50/50 rounded-xl p-5 shadow-sm print:border-black print:bg-white print:p-0 print:shadow-none">
             <div className="flex items-center gap-2 mb-3">
                <div className="w-1 h-6 bg-red-500 rounded-full"></div>
                <div>
                   <div className="font-bold text-red-800 uppercase print:text-black">VII. Tr·ªçng ƒëi·ªÉm</div>
                   <div className="text-xs text-red-400 font-bold print:text-gray-500">ÊïôÂ≠¶ÈáçÁÇπ</div>
                </div>
             </div>
             <TextAreaAutoResize 
                value={data.keyPoints.emphasis} 
                onChange={(e) => handleChange('keyPoints', 'emphasis', e.target.value)} 
                className="w-full bg-transparent min-h-[60px]"
              />
          </div>
          <div className="border border-orange-100 bg-orange-50/50 rounded-xl p-5 shadow-sm print:border-black print:bg-white print:p-0 print:shadow-none">
             <div className="flex items-center gap-2 mb-3">
                <div className="w-1 h-6 bg-orange-500 rounded-full"></div>
                <div>
                   <div className="font-bold text-orange-800 uppercase print:text-black">VIII. ƒêi·ªÉm kh√≥</div>
                   <div className="text-xs text-orange-400 font-bold print:text-gray-500">ÊïôÂ≠¶ÈöæÁÇπ</div>
                </div>
             </div>
             <TextAreaAutoResize 
                value={data.keyPoints.difficulty} 
                onChange={(e) => handleChange('keyPoints', 'difficulty', e.target.value)} 
                className="w-full bg-transparent min-h-[60px]"
              />
          </div>
        </div>

        {/* Creative */}
        <Section title="IX. S√°ng t·∫°o & M·ªü r·ªông" chineseTitle="ÊïôÂ≠¶ÂàõÊñ∞" colorClass="border-purple-500">
          <div className="mb-4 text-sm text-gray-500 italic print:hidden">
             * Ghi l·∫°i c√°c √Ω t∆∞·ªüng tr√≤ ch∆°i, ho·∫°t ƒë·ªông ngo·∫°i kh√≥a ho·∫∑c ph∆∞∆°ng ph√°p m·ªõi.
          </div>
          <DynamicSectionList 
            items={data.creative} 
            onChange={(items) => handleListChange('creative', items)}
            placeholderTitle="T√™n ho·∫°t ƒë·ªông s√°ng t·∫°o"
            allowImages={true}
          />
        </Section>

        {/* Process - Unified Table View */}
        <Section title="X. Ti·∫øn tr√¨nh d·∫°y h·ªçc" chineseTitle="ÊïôÂ≠¶ËøáÁ®ã" className="overflow-visible" colorClass="border-blue-600">
          <div className="overflow-x-auto print:overflow-visible">
            <table className="w-full border-collapse text-sm min-w-[800px] md:min-w-0">
              <thead>
                <tr className="bg-gray-100 text-left print:bg-gray-200 text-gray-700">
                  <th className="border-b-2 border-gray-300 p-3 w-16">Th·ªùi gian</th>
                  <th className="border-b-2 border-gray-300 p-3 w-1/4">B∆∞·ªõc / N·ªôi dung</th>
                  <th className="border-b-2 border-gray-300 p-3">Ho·∫°t ƒë·ªông Gi√°o Vi√™n</th>
                  <th className="border-b-2 border-gray-300 p-3">Ho·∫°t ƒë·ªông H·ªçc Sinh</th>
                  <th className="border-b-2 border-gray-300 p-3 w-24">M·ª•c ƒë√≠ch</th>
                  <th className="border-b-2 border-gray-300 p-3 w-8 print:hidden"></th>
                </tr>
              </thead>
              <tbody className="align-top">
                {Array.isArray(data.process) && data.process.map((row) => (
                  <tr key={row.id} className="group border-b border-gray-100 hover:bg-gray-50 print:hover:bg-transparent print:border-gray-300">
                    <td className="p-2 border-r border-dashed border-gray-200 print:border-gray-400">
                      <TextAreaAutoResize value={row.time} onChange={(e) => handleProcessChange(row.id, 'time', e.target.value)} placeholder="5p" className="text-center font-bold text-gray-600" />
                    </td>
                    <td className="p-2 border-r border-dashed border-gray-200 print:border-gray-400">
                      <TextAreaAutoResize value={row.step} onChange={(e) => handleProcessChange(row.id, 'step', e.target.value)} placeholder="T√™n b∆∞·ªõc" className="font-bold text-blue-800 mb-1 print:text-black" />
                      <TextAreaAutoResize value={row.content} onChange={(e) => handleProcessChange(row.id, 'content', e.target.value)} placeholder="N·ªôi dung ch√≠nh" className="text-xs text-gray-500 print:text-gray-700" />
                      <ImageUploader image={row.image} onImageChange={(img) => handleProcessChange(row.id, 'image', img)} />
                    </td>
                    <td className="p-2 border-r border-dashed border-gray-200 print:border-gray-400">
                      <TextAreaAutoResize value={row.teacherAct} onChange={(e) => handleProcessChange(row.id, 'teacherAct', e.target.value)} placeholder="..." />
                    </td>
                    <td className="p-2 border-r border-dashed border-gray-200 print:border-gray-400">
                      <TextAreaAutoResize value={row.studentAct} onChange={(e) => handleProcessChange(row.id, 'studentAct', e.target.value)} placeholder="..." />
                    </td>
                    <td className="p-2">
                      <TextAreaAutoResize value={row.purpose} onChange={(e) => handleProcessChange(row.id, 'purpose', e.target.value)} placeholder="..." className="italic text-gray-500 text-xs" />
                    </td>
                     <td className="p-2 text-center print:hidden align-middle">
                      <button onClick={() => removeProcessStep(row.id)} className="text-gray-300 hover:text-red-500 transition p-1" type="button">
                        <Trash2 size={16} />
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <button onClick={addProcessStep} className="mt-4 flex items-center justify-center gap-2 text-blue-600 font-bold hover:bg-blue-50 px-4 py-3 rounded-xl transition print:hidden border border-blue-200 shadow-sm mx-auto" type="button">
            <Plus size={18} /> Th√™m b∆∞·ªõc ti·∫øn tr√¨nh
          </button>
        </Section>

        {/* Reflection */}
        <div className="mt-10 bg-yellow-50/50 border border-yellow-200 rounded-xl p-6 print:bg-white print:border-t-2 print:border-x-0 print:border-b-0 print:border-gray-300 print:rounded-none print:p-0 print:mt-6 print:break-inside-avoid">
           <div className="flex items-baseline gap-2 mb-4 border-b border-yellow-100 pb-2 print:border-none">
              <h3 className="font-bold text-xl text-yellow-800 uppercase print:text-black">Ph·∫£n t∆∞ sau gi·∫£ng d·∫°y</h3>
              <span className="text-yellow-600 font-medium text-sm print:text-gray-600">ÊïôÂ≠¶ÂèçÊÄù</span>
           </div>
           
           <div className="grid grid-cols-1 md:grid-cols-2 gap-8 print:gap-4">
             <div>
                <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">V·∫•n ƒë·ªÅ t·ªìn t·∫°i</label>
                <TextAreaAutoResize 
                  value={data.reflection?.situation}
                  onChange={(e) => handleChange('reflection', 'situation', e.target.value)}
                  className="w-full min-h-[100px] border border-gray-200 rounded-lg p-3 bg-white focus:ring-2 focus:ring-yellow-200 print:border-gray-300"
                />
                <ImageUploader 
                  image={data.reflection?.situationImage} 
                  onImageChange={(img) => handleChange('reflection', 'situationImage', img)} 
                  label="·∫¢nh minh h·ªça v·∫•n ƒë·ªÅ"
                />
             </div>
             <div>
                <label className="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">H∆∞·ªõng c·∫£i thi·ªán</label>
                <TextAreaAutoResize 
                  value={data.reflection?.solution}
                  onChange={(e) => handleChange('reflection', 'solution', e.target.value)}
                  className="w-full min-h-[100px] border border-gray-200 rounded-lg p-3 bg-white focus:ring-2 focus:ring-green-200 print:border-gray-300"
                />
                <ImageUploader 
                  image={data.reflection?.solutionImage} 
                  onImageChange={(img) => handleChange('reflection', 'solutionImage', img)} 
                  label="·∫¢nh minh h·ªça gi·∫£i ph√°p"
                />
             </div>
           </div>
        </div>

        {/* Class Rating */}
        <div className="mt-8 pt-6 border-t border-gray-200 print:break-inside-avoid">
           <div className="flex items-baseline gap-2 mb-4">
              <h3 className="font-bold text-xl text-slate-700 uppercase print:text-black">ƒê√°nh gi√° l·ªõp h·ªçc</h3>
              <span className="text-slate-400 font-medium text-sm print:text-gray-500">ËØæÂ†ÇËØÑ‰ª∑</span>
           </div>
           
           <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4">
             {Array.isArray(data.ratings) && data.ratings.map((rating) => (
               <div key={rating.id} className="flex flex-col sm:flex-row sm:items-center justify-between border-b border-gray-100 pb-3 sm:pb-2 group">
                  <div className="flex-grow mb-2 sm:mb-0">
                    <input 
                      value={rating.label || ""}
                      onChange={(e) => handleRatingChange(rating.id, 'label', e.target.value)}
                      className="w-full bg-transparent focus:outline-none font-medium text-gray-700 print:text-black text-lg sm:text-base"
                      placeholder="Ti√™u ch√≠ ƒë√°nh gi√°..."
                    />
                  </div>
                  <div className="flex items-center justify-between sm:justify-end gap-4">
                    <StarRating value={rating.stars} onChange={(val) => handleRatingChange(rating.id, 'stars', val)} />
                    <button onClick={() => removeRating(rating.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition print:hidden p-2" type="button">
                       <Trash2 size={20} />
                    </button>
                  </div>
               </div>
             ))}
           </div>
           
           <button onClick={addRating} className="mt-4 flex items-center justify-center sm:justify-start gap-2 text-sm text-blue-500 hover:text-blue-700 font-medium print:hidden w-full sm:w-auto p-2 border border-dashed border-blue-200 rounded" type="button">
              <Plus size={16} /> Th√™m ti√™u ch√≠ ƒë√°nh gi√°
           </button>
        </div>

        {/* Footer */}
        <div className="mt-16 pt-8 border-t border-gray-200 flex flex-col md:flex-row justify-between items-center md:items-end print:mt-10 print:flex-row gap-8 md:gap-0">
            <div className="text-sm text-gray-400 mb-4 md:mb-0 print:text-gray-600 order-2 md:order-1">
               Ng√†y so·∫°n: {data.meta?.date}
            </div>
            <div className="text-center px-8 order-1 md:order-2 w-full md:w-auto">
               <input 
                 className="block mb-16 font-bold text-lg text-center bg-transparent focus:outline-none placeholder-gray-400 print:text-black w-full"
                 value={data.footer?.signatureTitle || "Gi√°o vi√™n k√Ω t√™n"}
                 onChange={(e) => handleChange('footer', 'signatureTitle', e.target.value)}
               />
               
               <input 
                 className="block font-serif italic text-xl text-center bg-transparent focus:outline-none print:text-black w-full min-w-[200px]"
                 value={data.footer?.signerName || data.meta?.teacher}
                 onChange={(e) => handleChange('footer', 'signerName', e.target.value)}
               />
            </div>
        </div>

      </div>
    </div>
  );
};

export default App;
